---
title: "plot_for_paper"
author: "Abhishek Senapati"
date: "`r Sys.Date()`"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```


```{r message=FALSE}
library(here)
library(ggplot2)
library(ggpubr)
library(tidyr)
library(dplyr)
library(reshape2)
library(cowplot)
library(readxl)
```


## Percentage of cases averted for 3 vaccine coverage
```{r}
## aggregate over all the age groups
get_agg_over_age <- function(arr) {
  arr_agg_age <- apply(arr, c(1,2,4), sum)
  return(arr_agg_age)
}

## cumulative number over year
get_cumulative_over_time <- function(arr, t_begin, t_end) {
  arr_cum_time <- apply(arr[, , t_begin:t_end], c(1, 2), sum)
  return(arr_cum_time)
}

## calculate the averted 
get_averted <- function(nv_output, v_output, t_begin, t_end, output_type){
  
  nv_agg_age <- get_agg_over_age(nv_output)
  v_agg_age <-  get_agg_over_age(v_output)
  
  nv_cum_t <- get_cumulative_over_time( nv_agg_age, t_begin = t_begin, t_end = t_end)
  v_cum_t <- get_cumulative_over_time( v_agg_age, t_begin = t_begin, t_end = t_end)
  
  if (output_type == "absolute") {
    
    averted <- (nv_cum_t - v_cum_t)
  }
  
  if (output_type == "proportion") {
    
    averted <- 100*(nv_cum_t - v_cum_t)/nv_cum_t
  }
  
  return(averted)
}

## extract variable from .rds file
extract_variable <- function(rds_file, variable_name) {
  
  result <- readRDS(here::here("model_output",  rds_file) )
  
  out_v <- as.data.frame(result$output, stringsAsFactors = FALSE)
  
  n_vac_age = result$n_vac_age
  n_sample = result$n_sample
  n_age = result$n_age
  n_year = result$n_year
  
  x <- out_v[,colnames(out_v) == variable_name] 
  
  y <- array(NA, dim = c(n_vac_age,n_sample, n_age, n_year))
  
  for (i in 1:n_vac_age) {
    
    y[i,,,] <- x[[paste0("result.", i)]]
  }
  
  return(y)
}

## make single figure
get_plot_averted <- function(df_v20, df_v50, df_v80, y_limits, y_breaks) {
  
  # Add a column for age groups
  df_v20$age <- 1:nrow(df_v20)
  df_v50$age <- 1:nrow(df_v50)
  df_v80$age <- 1:nrow(df_v80)
  
  # Reshape the dataframes to long format
  df_v20_long <- gather(df_v20, key = "Realization", value = "Output", -age)
  df_v50_long <- gather(df_v50, key = "Realization", value = "Output", -age)
  df_v80_long <- gather(df_v80, key = "Realization", value = "Output", -age)
  
  # Add a column to indicate the vaccine coverage for each dataset
  df_v20_long$VaccineCoverage <- "20% Coverage"
  df_v50_long$VaccineCoverage <- "50% Coverage"
  df_v80_long$VaccineCoverage <- "80% Coverage"
  
  # Combine all datasets into one long dataframe
  df_long <- bind_rows(df_v20_long, df_v50_long, df_v80_long)
  
  # Calculate the mean and 95% confidence interval for each age group and vaccine coverage
  summary_df <- df_long %>%
    group_by(age, VaccineCoverage) %>%
    summarise(
      mean_output =  quantile(Output, 0.5), #mean(Output),
      lower_bound = quantile(Output, 0.025),
      upper_bound = quantile(Output, 0.975)
    ) %>%
    ungroup()

  # 
  
  # Define colors for different vaccine coverages
  vaccine_colors <- c("20% Coverage" = "#1b7a53", "50% Coverage" = "#d94e28", "80% Coverage" = "#4a5a92")
  
  # Define the dodge position for side-by-side plotting
  dodge <- position_dodge(width = 0.3)
  
  # Plot using ggplot2
  p <- ggplot(summary_df, aes(x = factor(age), y = mean_output, color = VaccineCoverage)) +
    geom_point(size = 9, position = dodge, shape = 16) +  # Points for the mean with dodge
    geom_errorbar(aes(ymin = lower_bound, ymax = upper_bound), 
                  width = 0.0, size = 1.8, position = dodge) +  # Error bars with dodge
    scale_color_manual(values = vaccine_colors, name = "") + 
    scale_x_discrete(
      breaks = c(1, 2, 3, 4, 5, 6, 7),   # Set the positions of the x-axis ticks
      labels = c("6-16", "17-30", "31-40", "41-50", "51-60", "61-70", "71-80")  # Labels for age groups
    ) +
    # labs(x = "Age at vaccination", y = ylab, color = NULL) +  # Labels for x and y axes
    scale_y_continuous(limits = y_limits, breaks = y_breaks) +  # Define y-axis tick points )+
    theme_bw() +  # Clean theme
    theme(
      axis.ticks.length = unit(0.4, "cm"),        # Increase the length of the ticks
      axis.ticks = element_line(size = 1.5),      # Increase the thickness of the ticks
      panel.border = element_rect(color = "black", size = 2),  # Thicker border
      plot.margin = margin(t=10, r=10, b=10, l=10),
      axis.text.x = element_text(size = 35, color="black", angle= 30, margin = margin(t = 10, b = 10)),
      axis.text.y = element_text(size = 35,color="black", margin = margin(r = 10, l = 30)),
      # axis.title = element_text(size = 35, color = "black"),
      axis.title = element_blank(),
      legend.position = "top",
      legend.direction = "horizontal",
      legend.text = element_text(size = 40),
      legend.key.size = unit(2, "cm"),  # Increase size of legend keys
      legend.key.height = unit(1.5, "cm"),  # Increase height of legend keys
      legend.key.width = unit(2.5, "cm"),  # Increase width of legend keys
      legend.background = element_blank()
    )
  
  return(list(plot = p, summary = summary_df))
  
}


get_arranged_plot_avert_percent <- function(set_of_rds_files, variable_name, y_lab, t_begin, t_end) {
  
  plot_list <- list()
  summary_list <- list()

  for (i in seq_along(set_of_rds_files)) {
    
    rds_files <- set_of_rds_files[[i]]
    
    v_0 <- extract_variable(rds_file = rds_files[1] , 
                            variable_name = variable_name) + 
      extract_variable(rds_file =  rds_files[1], 
                       variable_name = paste0(variable_name, "_v"))
    
    v_20 <- extract_variable(rds_file = rds_files[2] , 
                             variable_name = variable_name) + 
      extract_variable(rds_file =  rds_files[2], 
                       variable_name = paste0(variable_name, "_v"))
    
    v_50 <- extract_variable(rds_file = rds_files[3] , 
                             variable_name = variable_name) + 
      extract_variable(rds_file =  rds_files[3], 
                       variable_name = paste0(variable_name, "_v"))
    
    v_80 <- extract_variable(rds_file = rds_files[4] , 
                             variable_name = variable_name) + 
      extract_variable(rds_file =  rds_files[4], 
                       variable_name = paste0(variable_name, "_v"))
    
    
    
    averted_inc_v20 <- get_averted(nv_output = v_0,
                                   v_output = v_20,
                                   t_begin = t_begin,
                                   t_end = t_end,
                                   output_type = "proportion")
    
    averted_inc_v50 <- get_averted(nv_output = v_0,
                                   v_output = v_50,
                                   t_begin = t_begin,
                                   t_end = t_end,
                                   output_type = "proportion")
    
    averted_inc_v80 <- get_averted(nv_output = v_0,
                                   v_output = v_80,
                                   t_begin = t_begin,
                                   t_end = t_end,
                                   output_type = "proportion")
    
    
    df_v20 <- as.data.frame(averted_inc_v20)
    df_v50 <- as.data.frame(averted_inc_v50)
    df_v80 <- as.data.frame(averted_inc_v80)
    
    
    
  # Determine y-axis settings for this figure
    if (i == 1 ) {  # Example: The second figure requires different limits
      y_limits <- custom_y_limits1
      y_breaks <- custom_y_breaks1
      
    } else if (i == 2) {
      y_limits <- custom_y_limits2
      y_breaks <- custom_y_breaks2
      
    } else if (i == 3) {
      y_limits <- custom_y_limits3
      y_breaks <- custom_y_breaks3
      
    }  else if (i == 4) {
      y_limits <- custom_y_limits4
      y_breaks <- custom_y_breaks4
    }

    
    result <- get_plot_averted(df_v20 = df_v20 , df_v50 = df_v50, df_v80 = df_v80, 
                                     y_limits = y_limits, y_breaks = y_breaks )
    
    averted_plot <- result$plot
    plot_list[[i]] <- averted_plot
    
    ## save estimates presented in the figure
    
    summary_list[[i]] <- result$summary
    
  }
  
  
  ## store the estimates in a file for future reference
  names(summary_list) <- c("DENV1", "DENV2", "DENV3", "DENV4")
  combined_summary <- dplyr::bind_rows(summary_list, .id = "Sero")
  ## saving upto 3 decimal place
  combined_summary <- combined_summary %>%
  dplyr::mutate(
    mean_output = round(mean_output, 3),
    lower_bound = round(lower_bound, 3),
    upper_bound = round(upper_bound, 3)
  )
  write.table(combined_summary,
            file = here::here("output_estimate_figure", "percent_symp_averted_10_y_dom_sero.txt"),
            sep = "\t",
            row.names = FALSE,
            quote = FALSE)




## remove legend in each of the figure
  plot_list_wo_legend <- list()
  
  for (i in seq_along(plot_list)){
    plot_list_wo_legend[[i]] <- plot_list[[i]] + theme(legend.position = "none")
  }  
  
## extrct the legend  
legend_plot <- get_legend(averted_plot)  

# Create the grid of plots without individual x and y labels
plot_wo_labels <- plot_grid(
  plotlist = plot_list_wo_legend,
  nrow = 2,
  ncol = 2,
  align = "hv",
  axis = "tblr",
  labels = c("(a)", "(b)", "(c)", "(d)"),  # Add subfigure labels
  label_size = 40,                        # Adjust label size
  label_x = 0.03,                         # Adjust horizontal position of labels
  label_y = 1.08                          # Adjust vertical position of labels
)

plot_with_labels <- ggdraw() +
  draw_plot(plot_wo_labels, x = 0, y = 0, width = 1, height = 1) +   
  draw_label(y_lab, x = 0.01, y = 0.5, angle = 90, size = 45, fontface = "bold") +  # Y-axis label
  draw_label("Age at vaccination (year)", x = 0.5, y = 0.025, angle = 0, size = 45, fontface = "bold")           # X-axis label

# make grid of plots  
final_plot_with_legend <- plot_grid(
  legend_plot,
  plot_with_labels,
  nrow = 2, 
  rel_heights = c(0.1,1)  
)

return(final_plot_with_legend)
  
}  

### Inputs
## List all the datasets that we want to plot together
set_of_rds_files <- list(
  c("pri_sec_neq_detailed_a7_sero_dom_denv1_vcov_0.8_baseline_yes_nsamp_100_waning_0.rds", 
    "pri_sec_neq_detailed_a7_sero_dom_denv1_vcov_0.2_baseline_no_nsamp_100_waning_0.rds",
    "pri_sec_neq_detailed_a7_sero_dom_denv1_vcov_0.5_baseline_no_nsamp_100_waning_0.rds", 
    "pri_sec_neq_detailed_a7_sero_dom_denv1_vcov_0.8_baseline_no_nsamp_100_waning_0.rds"),  # Set 1
  
  c("pri_sec_neq_detailed_a7_sero_dom_denv2_vcov_0.8_baseline_yes_nsamp_100_waning_0.rds", 
    "pri_sec_neq_detailed_a7_sero_dom_denv2_vcov_0.2_baseline_no_nsamp_100_waning_0.rds",
    "pri_sec_neq_detailed_a7_sero_dom_denv2_vcov_0.5_baseline_no_nsamp_100_waning_0.rds", 
    "pri_sec_neq_detailed_a7_sero_dom_denv2_vcov_0.8_baseline_no_nsamp_100_waning_0.rds"),  # Set 2
  
  c("pri_sec_neq_detailed_a7_sero_dom_denv3_vcov_0.8_baseline_yes_nsamp_100_waning_0.rds", 
    "pri_sec_neq_detailed_a7_sero_dom_denv3_vcov_0.2_baseline_no_nsamp_100_waning_0.rds",
    "pri_sec_neq_detailed_a7_sero_dom_denv3_vcov_0.5_baseline_no_nsamp_100_waning_0.rds", 
    "pri_sec_neq_detailed_a7_sero_dom_denv3_vcov_0.8_baseline_no_nsamp_100_waning_0.rds"),  # Set 3
  
  c("pri_sec_neq_detailed_a7_sero_dom_denv4_vcov_0.8_baseline_yes_nsamp_100_waning_0.rds", 
    "pri_sec_neq_detailed_a7_sero_dom_denv4_vcov_0.2_baseline_no_nsamp_100_waning_0.rds",
    "pri_sec_neq_detailed_a7_sero_dom_denv4_vcov_0.5_baseline_no_nsamp_100_waning_0.rds", 
    "pri_sec_neq_detailed_a7_sero_dom_denv4_vcov_0.8_baseline_no_nsamp_100_waning_0.rds")    # Set 4
)

## grab the start of vaccination year from one of the dataset
t_begin = readRDS(here::here("model_output",set_of_rds_files[[1]][1]) )$v_year 

custom_y_limits1 <- c(0, 15)
custom_y_breaks1 <- seq(0, 15, by = 3)


custom_y_limits2 <- c(0, 15)
custom_y_breaks2 <- seq(0, 15, by = 3)

# Custom y-axis settings for a specific figure (for negative impact)(change it accordingly)
custom_y_limits3 <- c(0, 15)
custom_y_breaks3 <- seq(0, 15, by = 3)

custom_y_limits4 <- c(-18, 15)
custom_y_breaks4 <- seq(-18, 15, by = 6)


## Generate figure now
plot_impact <- get_arranged_plot_avert_percent(set_of_rds_files = set_of_rds_files,
                                                       variable_name = "symp_sample_age",
                                                       y_lab = "Reported cases averted (%)", 
                                                       t_begin = t_begin,
                                                       t_end = t_begin + 9) ## for 10 year impact

figure_name <- "percent_symp_averted_10_y_dom_sero.jpg"

# ## save
ggsave(
  filename = file.path(here("figure"), figure_name),  # Combine folder path and file name
  plot = plot_impact,                                            # The plot object to save
  width = 29*2,                                           # Width in inches
  height = 40,                                          # Height in inches
  dpi = 300,
  units = "cm")                                  # DPI (resolution)
```




## Percentage of hospitalization averted for 3 vaccine coverage
```{r}
## aggregate over all the age groups
get_agg_over_age <- function(arr) {
  arr_agg_age <- apply(arr, c(1,2,4), sum)
  return(arr_agg_age)
}

## cumulative number over year
get_cumulative_over_time <- function(arr, t_begin, t_end) {
  arr_cum_time <- apply(arr[, , t_begin:t_end], c(1, 2), sum)
  return(arr_cum_time)
}

## calculate the averted 
get_averted <- function(nv_output, v_output, t_begin, t_end, output_type){
  
  nv_agg_age <- get_agg_over_age(nv_output)
  v_agg_age <-  get_agg_over_age(v_output)
  
  nv_cum_t <- get_cumulative_over_time( nv_agg_age, t_begin = t_begin, t_end = t_end)
  v_cum_t <- get_cumulative_over_time( v_agg_age, t_begin = t_begin, t_end = t_end)
  
  if (output_type == "absolute") {
    
    averted <- (nv_cum_t - v_cum_t)
  }
  
  if (output_type == "proportion") {
    
    averted <- 100*(nv_cum_t - v_cum_t)/nv_cum_t
  }
  
  return(averted)
}


## extract variable from .rds file
extract_variable <- function(rds_file, variable_name) {
  
  result <- readRDS(here::here("model_output",  rds_file) )
  
  out_v <- as.data.frame(result$output, stringsAsFactors = FALSE)
  
  n_vac_age = result$n_vac_age
  n_sample = result$n_sample
  n_age = result$n_age
  n_year = result$n_year
  
  x <- out_v[,colnames(out_v) == variable_name] 
  
  y <- array(NA, dim = c(n_vac_age,n_sample, n_age, n_year))
  
  for (i in 1:n_vac_age) {
    
    y[i,,,] <- x[[paste0("result.", i)]]
  }
  
  return(y)
}

## make single figure
get_plot_averted <- function(df_v20, df_v50, df_v80, y_limits, y_breaks) {
  
  # Add a column for age groups
  df_v20$age <- 1:nrow(df_v20)
  df_v50$age <- 1:nrow(df_v50)
  df_v80$age <- 1:nrow(df_v80)
  
  # Reshape the dataframes to long format
  df_v20_long <- gather(df_v20, key = "Realization", value = "Output", -age)
  df_v50_long <- gather(df_v50, key = "Realization", value = "Output", -age)
  df_v80_long <- gather(df_v80, key = "Realization", value = "Output", -age)
  
  # Add a column to indicate the vaccine coverage for each dataset
  df_v20_long$VaccineCoverage <- "20% Coverage"
  df_v50_long$VaccineCoverage <- "50% Coverage"
  df_v80_long$VaccineCoverage <- "80% Coverage"
  
  # Combine all datasets into one long dataframe
  df_long <- bind_rows(df_v20_long, df_v50_long, df_v80_long)
  
  # Calculate the mean and 95% confidence interval for each age group and vaccine coverage
  summary_df <- df_long %>%
    group_by(age, VaccineCoverage) %>%
    summarise(
      mean_output = mean(Output),
      lower_bound = quantile(Output, 0.025),
      upper_bound = quantile(Output, 0.975)
    ) %>%
    ungroup()

  # 
  
  # Define colors for different vaccine coverages
  vaccine_colors <- c("20% Coverage" = "#1b7a53", "50% Coverage" = "#d94e28", "80% Coverage" = "#4a5a92")
  
  # Define the dodge position for side-by-side plotting
  dodge <- position_dodge(width = 0.3)
  
  # Plot using ggplot2
  p <- ggplot(summary_df, aes(x = factor(age), y = mean_output, color = VaccineCoverage)) +
    geom_point(size = 9, position = dodge, shape = 16) +  # Points for the mean with dodge
    geom_errorbar(aes(ymin = lower_bound, ymax = upper_bound), 
                  width = 0.0, size = 1.8, position = dodge) +  # Error bars with dodge
    scale_color_manual(values = vaccine_colors, name = "") + 
    scale_x_discrete(
      breaks = c(1, 2, 3, 4, 5, 6, 7),   # Set the positions of the x-axis ticks
      labels = c("6-16", "17-30", "31-40", "41-50", "51-60", "61-70", "71-80")  # Labels for age groups
    ) +
    # labs(x = "Age at vaccination", y = ylab, color = NULL) +  # Labels for x and y axes
    scale_y_continuous(limits = y_limits, breaks = y_breaks) +  # Define y-axis tick points )+
    theme_bw() +  # Clean theme
    theme(
      axis.ticks.length = unit(0.4, "cm"),        # Increase the length of the ticks
      axis.ticks = element_line(size = 1.5),      # Increase the thickness of the ticks
      panel.border = element_rect(color = "black", size = 2),  # Thicker border
      plot.margin = margin(t=10, r=10, b=10, l=10),
      axis.text.x = element_text(size = 35, color="black", angle= 30, margin = margin(t = 10, b = 10)),
      axis.text.y = element_text(size = 35,color="black", margin = margin(r = 10, l = 30)),
      # axis.title = element_text(size = 35, color = "black"),
      axis.title = element_blank(),
      legend.position = "top",
      legend.direction = "horizontal",
      legend.text = element_text(size = 40),
      legend.key.size = unit(2, "cm"),  # Increase size of legend keys
      legend.key.height = unit(1.5, "cm"),  # Increase height of legend keys
      legend.key.width = unit(2.5, "cm"),  # Increase width of legend keys
      legend.background = element_blank()
    )
  
  return(list(plot = p, summary = summary_df))
  
}


get_arranged_plot_avert_percent <- function(set_of_rds_files, variable_name, y_lab, t_begin, t_end) {
  
  plot_list <- list()
  summary_list <- list()

  for (i in seq_along(set_of_rds_files)) {
    
    rds_files <- set_of_rds_files[[i]]
    
    v_0 <- extract_variable(rds_file = rds_files[1] , 
                            variable_name = variable_name) + 
      extract_variable(rds_file =  rds_files[1], 
                       variable_name = paste0(variable_name, "_v"))
    
    v_20 <- extract_variable(rds_file = rds_files[2] , 
                             variable_name = variable_name) + 
      extract_variable(rds_file =  rds_files[2], 
                       variable_name = paste0(variable_name, "_v"))
    
    v_50 <- extract_variable(rds_file = rds_files[3] , 
                             variable_name = variable_name) + 
      extract_variable(rds_file =  rds_files[3], 
                       variable_name = paste0(variable_name, "_v"))
    
    v_80 <- extract_variable(rds_file = rds_files[4] , 
                             variable_name = variable_name) + 
      extract_variable(rds_file =  rds_files[4], 
                       variable_name = paste0(variable_name, "_v"))
    
    averted_inc_v20 <- get_averted(nv_output = v_0,
                                   v_output = v_20,
                                   t_begin = t_begin,
                                   t_end = t_end,
                                   output_type = "proportion")
    
    averted_inc_v50 <- get_averted(nv_output = v_0,
                                   v_output = v_50,
                                   t_begin = t_begin,
                                   t_end = t_end,
                                   output_type = "proportion")
    
    averted_inc_v80 <- get_averted(nv_output = v_0,
                                   v_output = v_80,
                                   t_begin = t_begin,
                                   t_end = t_end,
                                   output_type = "proportion")
    
    
    df_v20 <- as.data.frame(averted_inc_v20)
    df_v50 <- as.data.frame(averted_inc_v50)
    df_v80 <- as.data.frame(averted_inc_v80)
    
    
    
  # Determine y-axis settings for this figure
    if (i == 1 ) {  # Example: The second figure requires different limits
      y_limits <- custom_y_limits1
      y_breaks <- custom_y_breaks1
      
    } else if (i == 2) {
      y_limits <- custom_y_limits2
      y_breaks <- custom_y_breaks2
      
    } else if (i == 3) {
      y_limits <- custom_y_limits3
      y_breaks <- custom_y_breaks3
      
    }  else if (i == 4) {
      y_limits <- custom_y_limits4
      y_breaks <- custom_y_breaks4
    }

    
    result <- get_plot_averted(df_v20 = df_v20 , df_v50 = df_v50, df_v80 = df_v80, 
                                     y_limits = y_limits, y_breaks = y_breaks )
    
    averted_plot <- result$plot
    plot_list[[i]] <- averted_plot
    
    ## save estimates presented in the figure
    
    summary_list[[i]] <- result$summary
    
  }
  
  
  ## store the estimates in a file for future reference
  names(summary_list) <- c("DENV1", "DENV2", "DENV3", "DENV4")
  combined_summary <- dplyr::bind_rows(summary_list, .id = "Sero")
  ## saving upto 3 decimal place
  combined_summary <- combined_summary %>%
  dplyr::mutate(
    mean_output = round(mean_output, 3),
    lower_bound = round(lower_bound, 3),
    upper_bound = round(upper_bound, 3)
  )
  write.table(combined_summary,
            file = here::here("output_estimate_figure", "percent_hosp_averted_10_y_dom_sero.txt"),
            sep = "\t",
            row.names = FALSE,
            quote = FALSE)




## remove legend in each of the figure
  plot_list_wo_legend <- list()
  
  for (i in seq_along(plot_list)){
    plot_list_wo_legend[[i]] <- plot_list[[i]] + theme(legend.position = "none")
  }  
  
## extrct the legend  
legend_plot <- get_legend(averted_plot)  

# Create the grid of plots without individual x and y labels
plot_wo_labels <- plot_grid(
  plotlist = plot_list_wo_legend,
  nrow = 2,
  ncol = 2,
  align = "hv",
  axis = "tblr",
  labels = c("(a)", "(b)", "(c)", "(d)"),  # Add subfigure labels
  label_size = 40,                        # Adjust label size
  label_x = 0.03,                         # Adjust horizontal position of labels
  label_y = 1.08                          # Adjust vertical position of labels
)

plot_with_labels <- ggdraw() +
  draw_plot(plot_wo_labels, x = 0, y = 0, width = 1, height = 1) +   
  draw_label(y_lab, x = 0.01, y = 0.5, angle = 90, size = 45, fontface = "bold") +  # Y-axis label
  draw_label("Age at vaccination (year)", x = 0.5, y = 0.025, angle = 0, size = 45, fontface = "bold")           # X-axis label

# make grid of plots  
final_plot_with_legend <- plot_grid(
  legend_plot,
  plot_with_labels,
  nrow = 2, 
  rel_heights = c(0.1,1)  
)

return(final_plot_with_legend)
  
}  



### Inputs

## List all the datasets that we want to plot together
set_of_rds_files <- list(
  c("pri_sec_neq_detailed_a7_sero_dom_denv1_vcov_0.8_baseline_yes_nsamp_100_waning_0.rds", 
    "pri_sec_neq_detailed_a7_sero_dom_denv1_vcov_0.2_baseline_no_nsamp_100_waning_0.rds",
    "pri_sec_neq_detailed_a7_sero_dom_denv1_vcov_0.5_baseline_no_nsamp_100_waning_0.rds", 
    "pri_sec_neq_detailed_a7_sero_dom_denv1_vcov_0.8_baseline_no_nsamp_100_waning_0.rds"),  # Set 1
  
  c("pri_sec_neq_detailed_a7_sero_dom_denv2_vcov_0.8_baseline_yes_nsamp_100_waning_0.rds", 
    "pri_sec_neq_detailed_a7_sero_dom_denv2_vcov_0.2_baseline_no_nsamp_100_waning_0.rds",
    "pri_sec_neq_detailed_a7_sero_dom_denv2_vcov_0.5_baseline_no_nsamp_100_waning_0.rds", 
    "pri_sec_neq_detailed_a7_sero_dom_denv2_vcov_0.8_baseline_no_nsamp_100_waning_0.rds"),  # Set 2
  
  c("pri_sec_neq_detailed_a7_sero_dom_denv3_vcov_0.8_baseline_yes_nsamp_100_waning_0.rds", 
    "pri_sec_neq_detailed_a7_sero_dom_denv3_vcov_0.2_baseline_no_nsamp_100_waning_0.rds",
    "pri_sec_neq_detailed_a7_sero_dom_denv3_vcov_0.5_baseline_no_nsamp_100_waning_0.rds", 
    "pri_sec_neq_detailed_a7_sero_dom_denv3_vcov_0.8_baseline_no_nsamp_100_waning_0.rds"),  # Set 3
  
  c("pri_sec_neq_detailed_a7_sero_dom_denv4_vcov_0.8_baseline_yes_nsamp_100_waning_0.rds", 
    "pri_sec_neq_detailed_a7_sero_dom_denv4_vcov_0.2_baseline_no_nsamp_100_waning_0.rds",
    "pri_sec_neq_detailed_a7_sero_dom_denv4_vcov_0.5_baseline_no_nsamp_100_waning_0.rds", 
    "pri_sec_neq_detailed_a7_sero_dom_denv4_vcov_0.8_baseline_no_nsamp_100_waning_0.rds")    # Set 4
)

## grab the start of vaccination year from one of the dataset
t_begin = readRDS(here::here("model_output",set_of_rds_files[[1]][1]) )$v_year 

custom_y_limits1 <- c(0, 17)
custom_y_breaks1 <- seq(0, 15, by = 3)


custom_y_limits2 <- c(0, 17)
custom_y_breaks2 <- seq(0, 15, by = 3)

# Custom y-axis settings for a specific figure (for negative impact)(change it accordingly)
custom_y_limits3 <- c(0, 17)
custom_y_breaks3 <- seq(0, 15, by = 3)

custom_y_limits4 <- c(-0.05, 17)
custom_y_breaks4 <- seq(0, 15, by = 3)


## Generate figure now
plot_impact <- get_arranged_plot_avert_percent(set_of_rds_files = set_of_rds_files,
                                                       variable_name = "hosp_sample_age",
                                                       y_lab = "Hospitalizations averted (%)", 
                                                       t_begin = t_begin,
                                                       t_end = t_begin + 9)

figure_name <- "percent_hosp_averted_10_y_dom_sero.jpg"

## save
ggsave(
  filename = file.path(here("figure"), figure_name),  # Combine folder path and file name
  plot = plot_impact,                                            # The plot object to save
  width = 29*2,                                           # Width in inches
  height = 40,                                          # Height in inches
  dpi = 300,
  units = "cm")                                  # DPI (resolution)
```






## Percentage of cases averted for 3 vaccine coverage (cases and hospitalization plotted together)
```{r}
## aggregate over all the age groups
get_agg_over_age <- function(arr) {
  arr_agg_age <- apply(arr, c(1,2,4), sum)
  return(arr_agg_age)
}

## cumulative number over year
get_cumulative_over_time <- function(arr, t_begin, t_end) {
  arr_cum_time <- apply(arr[, , t_begin:t_end], c(1, 2), sum)
  return(arr_cum_time)
}

## calculate the averted 
get_averted <- function(nv_output, v_output, t_begin, t_end, output_type){
  
  nv_agg_age <- get_agg_over_age(nv_output)
  v_agg_age <-  get_agg_over_age(v_output)
  
  nv_cum_t <- get_cumulative_over_time( nv_agg_age, t_begin = t_begin, t_end = t_end)
  v_cum_t <- get_cumulative_over_time( v_agg_age, t_begin = t_begin, t_end = t_end)
  
  if (output_type == "absolute") {
    
    averted <- (nv_cum_t - v_cum_t)
  }
  
  if (output_type == "proportion") {
    
    averted <- 100*(nv_cum_t - v_cum_t)/nv_cum_t
  }
  
  return(averted)
}

## extract variable from .rds file
extract_variable <- function(rds_file, variable_name) {
  
  result <- readRDS(here::here("model_output",  rds_file) )
  
  out_v <- as.data.frame(result$output, stringsAsFactors = FALSE)
  
  n_vac_age = result$n_vac_age
  n_sample = result$n_sample
  n_age = result$n_age
  n_year = result$n_year
  
  x <- out_v[,colnames(out_v) == variable_name] 
  
  y <- array(NA, dim = c(n_vac_age,n_sample, n_age, n_year))
  
  for (i in 1:n_vac_age) {
    
    y[i,,,] <- x[[paste0("result.", i)]]
  }
  
  return(y)
}

## make single figure
get_plot_averted <- function(df_v20, df_v50, df_v80, y_limits, y_breaks) {
  
  # Add a column for age groups
  df_v20$age <- 1:nrow(df_v20)
  df_v50$age <- 1:nrow(df_v50)
  df_v80$age <- 1:nrow(df_v80)
  
  # Reshape the dataframes to long format
  df_v20_long <- gather(df_v20, key = "Realization", value = "Output", -age)
  df_v50_long <- gather(df_v50, key = "Realization", value = "Output", -age)
  df_v80_long <- gather(df_v80, key = "Realization", value = "Output", -age)
  
  # Add a column to indicate the vaccine coverage for each dataset
  df_v20_long$VaccineCoverage <- "20% Coverage"
  df_v50_long$VaccineCoverage <- "50% Coverage"
  df_v80_long$VaccineCoverage <- "80% Coverage"
  
  # Combine all datasets into one long dataframe
  df_long <- bind_rows(df_v20_long, df_v50_long, df_v80_long)
  
  # Calculate the mean and 95% confidence interval for each age group and vaccine coverage
  summary_df <- df_long %>%
    group_by(age, VaccineCoverage) %>%
    summarise(
      mean_output =  quantile(Output, 0.5), #mean(Output),
      lower_bound = quantile(Output, 0.025),
      upper_bound = quantile(Output, 0.975)
    ) %>%
    ungroup()

  # 
  
  # Define colors for different vaccine coverages
  vaccine_colors <- c("20% Coverage" = "#1b7a53", "50% Coverage" = "#d94e28", "80% Coverage" = "#4a5a92")
  
  # Define the dodge position for side-by-side plotting
  dodge <- position_dodge(width = 0.3)
  
  # Plot using ggplot2
  p <- ggplot(summary_df, aes(x = factor(age), y = mean_output, color = VaccineCoverage)) +
    geom_point(size = 9, position = dodge, shape = 16) +  # Points for the mean with dodge
    geom_errorbar(aes(ymin = lower_bound, ymax = upper_bound), 
                  width = 0.0, size = 1.8, position = dodge) +  # Error bars with dodge
    scale_color_manual(values = vaccine_colors, name = "") + 
    scale_x_discrete(
      breaks = c(1, 2, 3, 4, 5, 6, 7),   # Set the positions of the x-axis ticks
      labels = c("6-16", "17-30", "31-40", "41-50", "51-60", "61-70", "71-80")  # Labels for age groups
    ) +
    # labs(x = "Age at vaccination", y = ylab, color = NULL) +  # Labels for x and y axes
    scale_y_continuous(limits = y_limits, breaks = y_breaks) +  # Define y-axis tick points )+
    theme_bw() +  # Clean theme
    theme(
      axis.ticks.length = unit(0.4, "cm"),        # Increase the length of the ticks
      axis.ticks = element_line(size = 1.5),      # Increase the thickness of the ticks
      panel.border = element_rect(color = "black", size = 2),  # Thicker border
      plot.margin = margin(t=10, r=10, b=20, l=25),
      axis.text.x = element_text(size = 35, color="black", angle= 30, margin = margin(t = 10, b = 20)),
      axis.text.y = element_text(size = 35,color="black", margin = margin(r = 10, l = 30)),
      # axis.title = element_text(size = 35, color = "black"),
      axis.title = element_blank(),
      legend.position = "top",
      legend.direction = "horizontal",
      legend.text = element_text(size = 40),
      legend.key.size = unit(2, "cm"),  # Increase size of legend keys
      legend.key.height = unit(1.5, "cm"),  # Increase height of legend keys
      legend.key.width = unit(2.5, "cm"),  # Increase width of legend keys
      legend.background = element_blank()
    )
  
  return(list(plot = p, summary = summary_df))
  
}


get_arranged_plot_avert_percent_combined <- function(set_of_rds_files, variable_name1, variable_name2, y_lab1, y_lab2, t_begin, t_end) {
  
  plot_list_cases <- list()
  plot_list_hosp <- list()

  for (i in seq_along(set_of_rds_files)) {
    
    rds_files <- set_of_rds_files[[i]]
    
    v_0_cases <- extract_variable(rds_file = rds_files[1] , 
                            variable_name = variable_name1) + 
      extract_variable(rds_file =  rds_files[1], 
                       variable_name = paste0(variable_name1, "_v"))
    
    v_20_cases <- extract_variable(rds_file = rds_files[2] , 
                             variable_name = variable_name1) + 
      extract_variable(rds_file =  rds_files[2], 
                       variable_name = paste0(variable_name1, "_v"))
    
    v_50_cases <- extract_variable(rds_file = rds_files[3] , 
                             variable_name = variable_name1) + 
      extract_variable(rds_file =  rds_files[3], 
                       variable_name = paste0(variable_name1, "_v"))
    
    v_80_cases <- extract_variable(rds_file = rds_files[4] , 
                             variable_name = variable_name1) + 
      extract_variable(rds_file =  rds_files[4], 
                       variable_name = paste0(variable_name1, "_v"))
    
    
    
    averted_inc_v20_cases <- get_averted(nv_output = v_0_cases,
                                   v_output = v_20_cases,
                                   t_begin = t_begin,
                                   t_end = t_end,
                                   output_type = "proportion")
    
    averted_inc_v50_cases <- get_averted(nv_output = v_0_cases,
                                   v_output = v_50_cases,
                                   t_begin = t_begin,
                                   t_end = t_end,
                                   output_type = "proportion")
    
    averted_inc_v80_cases <- get_averted(nv_output = v_0_cases,
                                   v_output = v_80_cases,
                                   t_begin = t_begin,
                                   t_end = t_end,
                                   output_type = "proportion")
    
    
    df_v20_cases <- as.data.frame(averted_inc_v20_cases)
    df_v50_cases <- as.data.frame(averted_inc_v50_cases)
    df_v80_cases <- as.data.frame(averted_inc_v80_cases)
    
    
    
  # Determine y-axis settings for this figure
    if (i == 1 ) {  # Example: The second figure requires different limits
      y_limits <- custom_y_limits1_cases
      y_breaks <- custom_y_breaks1_cases
      
    } else if (i == 2) {
      y_limits <- custom_y_limits2_cases
      y_breaks <- custom_y_breaks2_cases
      
    } else if (i == 3) {
      y_limits <- custom_y_limits3_cases
      y_breaks <- custom_y_breaks3_cases
      
    }  else if (i == 4) {
      y_limits <- custom_y_limits4_cases
      y_breaks <- custom_y_breaks4_cases
    }

    
    result_cases <- get_plot_averted(df_v20 = df_v20_cases , df_v50 = df_v50_cases, df_v80 = df_v80_cases, 
                                     y_limits = y_limits, y_breaks = y_breaks )
    
    averted_plot_cases <- result_cases$plot
    plot_list_cases[[i]] <- averted_plot_cases
    
  }
  
### Now for hospitalizations  
  
   for (i in seq_along(set_of_rds_files)) {
    
    rds_files <- set_of_rds_files[[i]]
    
    v_0_hosp <- extract_variable(rds_file = rds_files[1] , 
                            variable_name = variable_name2) + 
      extract_variable(rds_file =  rds_files[1], 
                       variable_name = paste0(variable_name2, "_v"))
    
    v_20_hosp <- extract_variable(rds_file = rds_files[2] , 
                             variable_name = variable_name2) + 
      extract_variable(rds_file =  rds_files[2], 
                       variable_name = paste0(variable_name2, "_v"))
    
    v_50_hosp <- extract_variable(rds_file = rds_files[3] , 
                             variable_name = variable_name2) + 
      extract_variable(rds_file =  rds_files[3], 
                       variable_name = paste0(variable_name2, "_v"))
    
    v_80_hosp <- extract_variable(rds_file = rds_files[4] , 
                             variable_name = variable_name2) + 
      extract_variable(rds_file =  rds_files[4], 
                       variable_name = paste0(variable_name2, "_v"))
    
    averted_inc_v20_hosp <- get_averted(nv_output = v_0_hosp,
                                   v_output = v_20_hosp,
                                   t_begin = t_begin,
                                   t_end = t_end,
                                   output_type = "proportion")
    
    averted_inc_v50_hosp <- get_averted(nv_output = v_0_hosp,
                                   v_output = v_50_hosp,
                                   t_begin = t_begin,
                                   t_end = t_end,
                                   output_type = "proportion")
    
    averted_inc_v80_hosp <- get_averted(nv_output = v_0_hosp,
                                   v_output = v_80_hosp,
                                   t_begin = t_begin,
                                   t_end = t_end,
                                   output_type = "proportion")
    
    
    df_v20_hosp <- as.data.frame(averted_inc_v20_hosp)
    df_v50_hosp <- as.data.frame(averted_inc_v50_hosp)
    df_v80_hosp <- as.data.frame(averted_inc_v80_hosp)
    
    
    
  # Determine y-axis settings for this figure
    if (i == 1 ) {  # Example: The second figure requires different limits
      y_limits <- custom_y_limits1_hosp
      y_breaks <- custom_y_breaks1_hosp
      
    } else if (i == 2) {
      y_limits <- custom_y_limits2_hosp
      y_breaks <- custom_y_breaks2_hosp
      
    } else if (i == 3) {
      y_limits <- custom_y_limits3_hosp
      y_breaks <- custom_y_breaks3_hosp
      
    }  else if (i == 4) {
      y_limits <- custom_y_limits4_hosp
      y_breaks <- custom_y_breaks4_hosp
    }

    
    result_hosp <- get_plot_averted(df_v20 = df_v20_hosp, df_v50 = df_v50_hosp, df_v80 = df_v80_hosp, 
                                     y_limits = y_limits, y_breaks = y_breaks )
    
    averted_plot_hosp <- result_hosp$plot
    plot_list_hosp[[i]] <- averted_plot_hosp
    

    
  }
  
  
  ### combine the plots
  plot_list <- c(plot_list_cases, plot_list_hosp)
  

  
## remove legend in each of the figure
  plot_list_wo_legend <- list()
  
  for (i in seq_along(plot_list)){
    plot_list_wo_legend[[i]] <- plot_list[[i]] + theme(legend.position = "none")
  }  
  
## extrct the legend  
legend_plot <- get_legend(averted_plot_cases)  

# Create the grid of plots without individual x and y labels
plot_wo_labels <- plot_grid(
  plotlist = plot_list_wo_legend,
  nrow = 4,
  ncol = 2,
  align = "hv",
  axis = "tblr",
  labels = c("(a)", "(b)", "(c)", "(d)", "(e)", "(f)", "(g)", "(h)"),  # Add subfigure labels
  label_size = 40,                        # Adjust label size
  label_x = 0.03,                         # Adjust horizontal position of labels
  label_y = 1.08                          # Adjust vertical position of labels
)

plot_with_labels <- ggdraw() +
  draw_plot(plot_wo_labels, x = 0, y = 0, width = 1, height = 1) +   
  draw_label(y_lab1, x = 0.01, y = 0.78, angle = 90, size = 45, fontface = "bold") +  # Y-axis label for cases
  draw_label(y_lab2, x = 0.01, y = 0.28, angle = 90, size = 45, fontface = "bold") +  # Y-axis label
  
  draw_label("Age at vaccination (year)", x = 0.5, y = 0.025, angle = 0, size = 45, fontface = "bold")           # X-axis label

# make grid of plots  
final_plot_with_legend <- plot_grid(
  legend_plot,
  plot_with_labels,
  nrow = 2, 
  rel_heights = c(0.1,1)  
)

return(final_plot_with_legend)
  
}  

### Inputs
## List all the datasets that we want to plot together
set_of_rds_files <- list(
  c("pri_sec_neq_detailed_a7_sero_dom_denv1_vcov_0.8_baseline_yes_nsamp_100_waning_0.rds", 
    "pri_sec_neq_detailed_a7_sero_dom_denv1_vcov_0.2_baseline_no_nsamp_100_waning_0.rds",
    "pri_sec_neq_detailed_a7_sero_dom_denv1_vcov_0.5_baseline_no_nsamp_100_waning_0.rds", 
    "pri_sec_neq_detailed_a7_sero_dom_denv1_vcov_0.8_baseline_no_nsamp_100_waning_0.rds"),  # Set 1
  
  c("pri_sec_neq_detailed_a7_sero_dom_denv2_vcov_0.8_baseline_yes_nsamp_100_waning_0.rds", 
    "pri_sec_neq_detailed_a7_sero_dom_denv2_vcov_0.2_baseline_no_nsamp_100_waning_0.rds",
    "pri_sec_neq_detailed_a7_sero_dom_denv2_vcov_0.5_baseline_no_nsamp_100_waning_0.rds", 
    "pri_sec_neq_detailed_a7_sero_dom_denv2_vcov_0.8_baseline_no_nsamp_100_waning_0.rds"),  # Set 2
  
  c("pri_sec_neq_detailed_a7_sero_dom_denv3_vcov_0.8_baseline_yes_nsamp_100_waning_0.rds", 
    "pri_sec_neq_detailed_a7_sero_dom_denv3_vcov_0.2_baseline_no_nsamp_100_waning_0.rds",
    "pri_sec_neq_detailed_a7_sero_dom_denv3_vcov_0.5_baseline_no_nsamp_100_waning_0.rds", 
    "pri_sec_neq_detailed_a7_sero_dom_denv3_vcov_0.8_baseline_no_nsamp_100_waning_0.rds"),  # Set 3
  
  c("pri_sec_neq_detailed_a7_sero_dom_denv4_vcov_0.8_baseline_yes_nsamp_100_waning_0.rds", 
    "pri_sec_neq_detailed_a7_sero_dom_denv4_vcov_0.2_baseline_no_nsamp_100_waning_0.rds",
    "pri_sec_neq_detailed_a7_sero_dom_denv4_vcov_0.5_baseline_no_nsamp_100_waning_0.rds", 
    "pri_sec_neq_detailed_a7_sero_dom_denv4_vcov_0.8_baseline_no_nsamp_100_waning_0.rds")    # Set 4
)

## grab the start of vaccination year from one of the dataset
t_begin = readRDS(here::here("model_output",set_of_rds_files[[1]][1]) )$v_year 

custom_y_limits1_cases <- c(0, 15)
custom_y_breaks1_cases <- seq(0, 15, by = 3)


custom_y_limits2_cases <- c(0, 15)
custom_y_breaks2_cases <- seq(0, 15, by = 3)

# Custom y-axis settings for a specific figure (for negative impact)(change it accordingly)
custom_y_limits3_cases <- c(0, 15)
custom_y_breaks3_cases <- seq(0, 15, by = 3)

custom_y_limits4_cases <- c(-18, 15)
custom_y_breaks4_cases <- seq(-18, 15, by = 6)

## for hosp
custom_y_limits1_hosp <- c(0, 17)
custom_y_breaks1_hosp <- seq(0, 15, by = 3)


custom_y_limits2_hosp <- c(0, 17)
custom_y_breaks2_hosp <- seq(0, 15, by = 3)

# Custom y-axis settings for a specific figure (for negative impact)(change it accordingly)
custom_y_limits3_hosp <- c(0, 17)
custom_y_breaks3_hosp <- seq(0, 15, by = 3)

custom_y_limits4_hosp <- c(-0.05, 17)
custom_y_breaks4_hosp <- seq(0, 15, by = 3)



## Generate figure now
plot_impact <- get_arranged_plot_avert_percent_combined(set_of_rds_files = set_of_rds_files,
                                                       variable_name1 = "symp_sample_age",
                                                       variable_name2 = "hosp_sample_age",
                                                       y_lab1 = "Reported cases averted (%)", 
                                                       y_lab2 = "Hospitalizations averted (%)", 
                                                       t_begin = t_begin,
                                                       t_end = t_begin + 9) ## for 10 year impact

figure_name <- "percent_averted_10_y_dom_sero_symp_hosp_combined.jpg"

# ## save
ggsave(
  filename = file.path(here("figure"), figure_name),  # Combine folder path and file name
  plot = plot_impact,                                            # The plot object to save
  width = 29*2,                                           # Width in inches
  height = 80,                                          # Height in inches
  dpi = 300,
  units = "cm")                                  # DPI (resolution)
```


## Percentage of Cases averted stratified with baseline serostatus
```{r message=FALSE}
get_agg_over_age <- function(arr) {
  arr_agg_age <- apply(arr, c(1,2,4), sum)
  return(arr_agg_age)
}

## cumulative number over year
get_cumulative_over_time <- function(arr, t_begin, t_end) {
  arr_cum_time <- apply(arr[, , t_begin:t_end], c(1, 2), sum)
  return(arr_cum_time)
}


## extract variable from .rds file
extract_variable <- function(rds_file, variable_name) {
  
  result <- readRDS(here::here("model_output",  rds_file) )
  
  out_v <- as.data.frame(result$output, stringsAsFactors = FALSE)
  
  n_vac_age = result$n_vac_age
  n_sample = result$n_sample
  n_age = result$n_age
  n_year = result$n_year
  
  x <- out_v[,colnames(out_v) == variable_name] 
  
  y <- array(NA, dim = c(n_vac_age,n_sample, n_age, n_year))
  
  for (i in 1:n_vac_age) {
    
    y[i,,,] <- x[[paste0("result.", i)]]
  }
  
  return(y)
}


get_averted_serostatus <- function(nv_output, v_output, t_begin, t_end){
  
  nv_agg_age <- get_agg_over_age(nv_output)
  v_agg_age <-  get_agg_over_age(v_output)
  # total_vac_agg_age <- get_agg_over_age(total_vac_output)
  
  nv_cum_t <- get_cumulative_over_time( nv_agg_age, t_begin = t_begin, t_end = t_end)
  v_cum_t <- get_cumulative_over_time( v_agg_age, t_begin = t_begin, t_end = t_end)
  # total_vac_cum_t <- get_cumulative_over_time(total_vac_agg_age, t_begin = t_begin, t_end = t_end)
  
  averted_serostatus <- 100*(nv_cum_t - v_cum_t)/nv_cum_t
  
  
  return(averted_serostatus)
  
}



get_plot_averted_serostatus <- function(df_total, df_seroneg, df_seropos, y_limits, y_breaks) {
  
  
  # Add a column for age groups
  df_total$age <- 1:nrow(df_total)
  df_seroneg$age <- 1:nrow(df_seroneg)
  df_seropos$age <- 1:nrow(df_seropos)
  
  # Reshape the dataframes to long format
  df_total_long <- gather(df_total, key = "Realization", value = "Output", -age)
  df_seroneg_long <- gather(df_seroneg, key = "Realization", value = "Output", -age)
  df_seropos_long <- gather(df_seropos, key = "Realization", value = "Output", -age)
  
  # Add a column to indicate the vaccine coverage for each dataset
  df_total_long$poptype <- "All"
  df_seroneg_long$poptype <- "Seronegative"
  df_seropos_long$poptype <- "Seropositive"
  
  # Combine all datasets into one long dataframe
  df_long <- bind_rows(df_total_long, df_seroneg_long, df_seropos_long)
  
  # Calculate the mean and 95% confidence interval for each age group and vaccine coverage
  summary_df <- df_long %>%
    group_by(age, poptype) %>%
    summarise(
      mean_output = mean(Output),
      lower_bound = quantile(Output, 0.025),
      upper_bound = quantile(Output, 0.975)
    ) %>%
    ungroup()
  
  
  
  # Define colors for different vaccine coverages
  poptype_barcolors <- c("All" = "#8dd3c7", "Seronegative" = "#fdb462", "Seropositive" = "#b3de69")
  
  poptype_errorbar_colors <- c("All" = "#55a39b", "Seronegative" = "#e08d3e", "Seropositive" = "#85a84e")
  
  # Define the dodge position for side-by-side plotting
  dodge <- position_dodge(width = 0.3)
  
  # Plot using ggplot2
  p <- ggplot(summary_df, aes(x = factor(age), y = mean_output, fill = poptype)) +
    # geom_point(size = 9, position = dodge, shape = 16) +  # Points for the mean with dodge
    geom_bar(stat = "identity", position = position_dodge(width = 0.75), width = 0.65) +
    
    geom_errorbar(aes(ymin = lower_bound, ymax = upper_bound, color = poptype), 
                  width = 0.0, size = 1.8, position = position_dodge(width = 0.75)) +
    # geom_errorbar(aes(ymin = lower_bound, ymax = upper_bound), 
    #               width = 0.0, size = 1.8, position = dodge) +  # Error bars with dodge
    scale_fill_manual(values = poptype_barcolors, name = "") + # Custom colors for bars
    scale_color_manual(values = poptype_errorbar_colors,  name = "") + # Custom colors for error bars
    # scale_color_manual(values = poptype_colors, name = "") + 
    scale_x_discrete(
      breaks = c(1, 2, 3, 4, 5, 6, 7),   # Set the positions of the x-axis ticks
      labels = c("6-16", "17-30", "31-40", "41-50", "51-60", "61-70", "71-80")  # Labels for age groups
    ) +
    # labs(x = "Age at vaccination", y = ylab, color = NULL) +  # Labels for x and y axes
    scale_y_continuous(limits = y_limits, breaks = y_breaks) +  # Define y-axis tick points )+
    theme_bw() +  # Clean theme
    theme(
      axis.ticks.length = unit(0.4, "cm"),        # Increase the length of the ticks
      axis.ticks = element_line(size = 1.5),      # Increase the thickness of the ticks
      panel.border = element_rect(color = "black", size = 2),  # Thicker border
      plot.margin = margin(t=10, r=10, b=20, l=25),
      axis.text.x = element_text(size = 35, color="black", angle= 30, margin = margin(t = 10, b = 20)),
      axis.text.y = element_text(size = 35,color="black", margin = margin(r = 10, l = 30)),
      # axis.title = element_text(size = 35, color = "black"),
      axis.title = element_blank(),
      legend.position = "top",
      legend.direction = "horizontal",
      legend.text = element_text(size = 40),
      legend.key.size = unit(2, "cm"),  # Increase size of legend keys
      legend.key.height = unit(1.5, "cm"),  # Increase height of legend keys
      legend.key.width = unit(2.5, "cm"),  # Increase width of legend keys
      legend.background = element_blank()
    )
  
   return(list(plot = p, summary = summary_df))
  
}


get_arranged_plot_averted_serostatus <- function(set_of_rds_files, variable_name, y_lab, t_begin, t_end) {
  
  plot_list <- list()
  summary_list <- list()
  
  for (i in seq_along(set_of_rds_files)) {
    
    rds_files <- set_of_rds_files[[i]]
    
    ## for total population
    nv_total <- extract_variable(rds_file = rds_files[1] , 
                            variable_name = variable_name) + 
      extract_variable(rds_file =  rds_files[1], 
                       variable_name = paste0(variable_name, "_v"))
    
    
    v_total <- extract_variable(rds_file = rds_files[2] , 
                                 variable_name = variable_name) + 
      extract_variable(rds_file =  rds_files[2], 
                       variable_name = paste0(variable_name, "_v"))
    
    ## seronegative
    nv_seroneg <- extract_variable(rds_file = rds_files[1] , 
                                 variable_name = paste0(variable_name, "_primary")) + 
      extract_variable(rds_file =  rds_files[1], 
                       variable_name = paste0(variable_name, "_v_primary"))
    
    
    v_seroneg <- extract_variable(rds_file = rds_files[2] , 
                                variable_name = paste0(variable_name, "_primary")) + 
      extract_variable(rds_file =  rds_files[2], 
                       variable_name = paste0(variable_name, "_v_primary"))
    
    ## seropositive
    nv_seropos <- extract_variable(rds_file = rds_files[1] , 
                                   variable_name = paste0(variable_name, "_secondary")) + 
      extract_variable(rds_file =  rds_files[1], 
                       variable_name = paste0(variable_name, "_v_secondary"))
    
    
    v_seropos <- extract_variable(rds_file = rds_files[2] , 
                                  variable_name = paste0(variable_name, "_secondary")) + 
      extract_variable(rds_file =  rds_files[2], 
                       variable_name = paste0(variable_name, "_v_secondary"))
    
    
    averted_serostatus_total <- get_averted_serostatus(nv_output = nv_total,
                                                 v_output = v_total,
                                                 t_begin = t_begin,
                                                 t_end = t_end)
    
    averted_serostatus_seroneg <- get_averted_serostatus(nv_output = nv_seroneg,
                                                   v_output = v_seroneg,
                                                   t_begin = t_begin,
                                                   t_end = t_end)
    
    averted_serostatus_seropos <- get_averted_serostatus(nv_output = nv_seropos,
                                                   v_output = v_seropos,
                                                   t_begin = t_begin,
                                                   t_end = t_end)
    
    df_averted_serostatus_total <- as.data.frame(averted_serostatus_total)
    
    df_averted_serostatus_seroneg <- as.data.frame(averted_serostatus_seroneg)
    
    df_averted_serostatus_seropos <- as.data.frame(averted_serostatus_seropos)
    
    
    
    
    # Determine y-axis settings for this figure
    if (i == 1 ) {  # Example: The second figure requires different limits
      y_limits <- custom_y_limits1
      y_breaks <- custom_y_breaks1
      
    } else if (i == 2) {
      y_limits <- custom_y_limits2
      y_breaks <- custom_y_breaks2
      
    } else if (i == 3) {
      y_limits <- custom_y_limits3
      y_breaks <- custom_y_breaks3
      
    }  else if (i == 4) {
      y_limits <- custom_y_limits4
      y_breaks <- custom_y_breaks4
    }
    
    
  
    result <- get_plot_averted_serostatus(
      df_total = df_averted_serostatus_total,
      df_seroneg = df_averted_serostatus_seroneg,
      df_seropos = df_averted_serostatus_seropos,
      y_limits = y_limits,
      y_breaks = y_breaks)
   
    averted_plot_serostatus <- result$plot
    
    plot_list[[i]] <-  averted_plot_serostatus
    summary_list[[i]] <- result$summary
    
  }
  
  
## store the estimates in a file for future reference
  names(summary_list) <- c("DENV1", "DENV2", "DENV3", "DENV4")
  combined_summary <- dplyr::bind_rows(summary_list, .id = "Sero")
  ## saving upto 3 decimal place
  combined_summary <- combined_summary %>%
  dplyr::mutate(
    mean_output = round(mean_output, 3),
    lower_bound = round(lower_bound, 3),
    upper_bound = round(upper_bound, 3)
  )
  write.table(combined_summary,
            file = here::here("output_estimate_figure", "percent_symp_averted_serop_seron.txt"),
            sep = "\t",
            row.names = FALSE,
            quote = FALSE)
  
  
  
  ## remove legend in each of the figure
  plot_list_wo_legend <- list()
  
  for (i in seq_along(plot_list)) {
    plot_list_wo_legend[[i]] <- plot_list[[i]] + theme(legend.position = "none")
  }  
  
  ## extrct the legend  
  legend_plot <- get_legend(averted_plot_serostatus)  
  
  # Create the grid of plots without individual x and y labels
  plot_wo_labels <- plot_grid(
    plotlist = plot_list_wo_legend,
    nrow = 2,
    ncol = 2,
    align = "hv",
    axis = "tblr",
    labels = c("(a)", "(b)", "(c)", "(d)"),  # Add subfigure labels
    label_size = 40,                        # Adjust label size
    label_x = 0.03,                         # Adjust horizontal position of labels
    label_y = 1.08                          # Adjust vertical position of labels
  )
  
  plot_with_labels <- ggdraw() +
    draw_plot(plot_wo_labels, x = 0, y = 0, width = 1, height = 1) +   
    draw_label(y_lab, x = 0.01, y = 0.55, angle = 90, size = 45, fontface = "bold") +  # Y-axis label
    draw_label("Age at vaccination (year)", x = 0.5, y = 0.025, angle = 0, size = 45, fontface = "bold")           # X-axis label
  
  # make grid of plots  
  final_plot_with_legend <- plot_grid(
    legend_plot,
    plot_with_labels,
    nrow = 2, 
    rel_heights = c(0.1,1)  
  )
  
  return(final_plot_with_legend)
  
}  



### Inputs


## List all the datasets that we want to plot together
set_of_rds_files <- list(
  c("pri_sec_neq_detailed_a7_sero_dom_denv1_vcov_0.8_baseline_yes_nsamp_100_waning_0.rds",
    "pri_sec_neq_detailed_a7_sero_dom_denv1_vcov_0.8_baseline_no_nsamp_100_waning_0.rds"),  # Set 1

  c("pri_sec_neq_detailed_a7_sero_dom_denv2_vcov_0.8_baseline_yes_nsamp_100_waning_0.rds",
    "pri_sec_neq_detailed_a7_sero_dom_denv2_vcov_0.8_baseline_no_nsamp_100_waning_0.rds"),  # Set 2

  c("pri_sec_neq_detailed_a7_sero_dom_denv3_vcov_0.8_baseline_yes_nsamp_100_waning_0.rds",
    "pri_sec_neq_detailed_a7_sero_dom_denv3_vcov_0.8_baseline_no_nsamp_100_waning_0.rds"),  # Set 3

  c("pri_sec_neq_detailed_a7_sero_dom_denv4_vcov_0.8_baseline_yes_nsamp_100_waning_0.rds",
    "pri_sec_neq_detailed_a7_sero_dom_denv4_vcov_0.8_baseline_no_nsamp_100_waning_0.rds")    # Set 4
)


## grab the start of vaccination year from one of the dataset
t_begin = readRDS(here::here("model_output",set_of_rds_files[[1]][1]) )$v_year 

custom_y_limits1 <- c(0, 16.5)
custom_y_breaks1 <- seq(0, 15, by = 3)


custom_y_limits2 <- c(0, 16.5)
custom_y_breaks2 <- seq(0, 15, by = 3)

# Custom y-axis settings for a specific figure (for negative impact)(change it accordingly)
custom_y_limits3 <- c(-6, 15)
custom_y_breaks3 <- seq(-6, 15, by = 3)

custom_y_limits4 <- c(-64, 15)
custom_y_breaks4 <- seq(-60, 15, by = 15)

## Generate figure now
plot_impact <- get_arranged_plot_averted_serostatus(set_of_rds_files = set_of_rds_files,
                                                                    variable_name = "symp_sample_age",
                                                                    y_lab = "Reported cases averted (%)",
                                                                    t_begin = t_begin,
                                                                    t_end = t_begin + 9)

figure_name <- "percent_symp_averted_serop_seron.jpg"

## save
ggsave(
  filename = file.path(here("figure"), figure_name),  # Combine folder path and file name
  plot = plot_impact,                                            # The plot object to save
  width = 29*2,                                           # Width in inches
  height = 40,                                          # Height in inches
  dpi = 300,
  units = "cm")                                  # DPI (resolution)


```




## Percentage of Hospitalizations averted stratified with baseline serostatus
```{r}
get_agg_over_age <- function(arr) {
  arr_agg_age <- apply(arr, c(1,2,4), sum)
  return(arr_agg_age)
}

## cumulative number over year
get_cumulative_over_time <- function(arr, t_begin, t_end) {
  arr_cum_time <- apply(arr[, , t_begin:t_end], c(1, 2), sum)
  return(arr_cum_time)
}


## extract variable from .rds file
extract_variable <- function(rds_file, variable_name) {
  
  result <- readRDS(here::here("model_output",  rds_file) )
  
  out_v <- as.data.frame(result$output, stringsAsFactors = FALSE)
  
  n_vac_age = result$n_vac_age
  n_sample = result$n_sample
  n_age = result$n_age
  n_year = result$n_year
  
  x <- out_v[,colnames(out_v) == variable_name] 
  
  y <- array(NA, dim = c(n_vac_age,n_sample, n_age, n_year))
  
  for (i in 1:n_vac_age) {
    
    y[i,,,] <- x[[paste0("result.", i)]]
  }
  
  return(y)
}


get_averted_serostatus <- function(nv_output, v_output, t_begin, t_end){
  
  nv_agg_age <- get_agg_over_age(nv_output)
  v_agg_age <-  get_agg_over_age(v_output)
  
  nv_cum_t <- get_cumulative_over_time( nv_agg_age, t_begin = t_begin, t_end = t_end)
  v_cum_t <- get_cumulative_over_time( v_agg_age, t_begin = t_begin, t_end = t_end)
  
  averted_serostatus <- 100*(nv_cum_t - v_cum_t)/nv_cum_t
  
  
  return(averted_serostatus)
  
}



get_plot_averted_serostatus <- function(df_total, df_seroneg, df_seropos, y_limits, y_breaks) {
  
  
  # Add a column for age groups
  df_total$age <- 1:nrow(df_total)
  df_seroneg$age <- 1:nrow(df_seroneg)
  df_seropos$age <- 1:nrow(df_seropos)
  
  # Reshape the dataframes to long format
  df_total_long <- gather(df_total, key = "Realization", value = "Output", -age)
  df_seroneg_long <- gather(df_seroneg, key = "Realization", value = "Output", -age)
  df_seropos_long <- gather(df_seropos, key = "Realization", value = "Output", -age)
  
  # Add a column to indicate the vaccine coverage for each dataset
  df_total_long$poptype <- "All"
  df_seroneg_long$poptype <- "Seronegative"
  df_seropos_long$poptype <- "Seropositive"
  
  # Combine all datasets into one long dataframe
  df_long <- bind_rows(df_total_long, df_seroneg_long, df_seropos_long)
  
  # Calculate the mean and 95% confidence interval for each age group and vaccine coverage
  summary_df <- df_long %>%
    group_by(age, poptype) %>%
    summarise(
      mean_output = mean(Output),
      lower_bound = quantile(Output, 0.025),
      upper_bound = quantile(Output, 0.975)
    ) %>%
    ungroup()
  
  # Define colors for different vaccine coverages
  poptype_barcolors <- c("All" = "#8dd3c7", "Seronegative" = "#fdb462", "Seropositive" = "#b3de69")
  
  poptype_errorbar_colors <- c("All" = "#55a39b", "Seronegative" = "#e08d3e", "Seropositive" = "#85a84e")
  

  # 
  # Define the dodge position for side-by-side plotting
  dodge <- position_dodge(width = 0.3)
  
  # Plot using ggplot2
  p <- ggplot(summary_df, aes(x = factor(age), y = mean_output, fill = poptype)) +
    # geom_point(size = 9, position = dodge, shape = 16) +  # Points for the mean with dodge
    geom_bar(stat = "identity", position = position_dodge(width = 0.75), width = 0.65) +
    
    geom_errorbar(aes(ymin = lower_bound, ymax = upper_bound, color = poptype), 
                  width = 0.0, size = 1.8, position = position_dodge(width = 0.75)) +
    scale_fill_manual(values = poptype_barcolors, name = "") + # Custom colors for bars
    scale_color_manual(values = poptype_errorbar_colors,  name = "") + # Custom colors for error bars
    scale_x_discrete(
      breaks = c(1, 2, 3, 4, 5, 6, 7),   # Set the positions of the x-axis ticks
      labels = c("6-16", "17-30", "31-40", "41-50", "51-60", "61-70", "71-80")  # Labels for age groups
    ) +
    scale_y_continuous(limits = y_limits, breaks = y_breaks) +  # Define y-axis tick points )+
    theme_bw() +  # Clean theme
    theme(
      axis.ticks.length = unit(0.4, "cm"),        # Increase the length of the ticks
      axis.ticks = element_line(size = 1.5),      # Increase the thickness of the ticks
      panel.border = element_rect(color = "black", size = 2),  # Thicker border
      plot.margin = margin(t=10, r=10, b=20, l=25),
      axis.text.x = element_text(size = 35, color="black", angle= 30, margin = margin(t = 10, b = 20)),
      axis.text.y = element_text(size = 35,color="black", margin = margin(r = 10, l = 30)),
      axis.title = element_blank(),
      legend.position = "top",
      legend.direction = "horizontal",
      legend.text = element_text(size = 40),
      legend.key.size = unit(2, "cm"),  # Increase size of legend keys
      legend.key.height = unit(1.5, "cm"),  # Increase height of legend keys
      legend.key.width = unit(2.5, "cm"),  # Increase width of legend keys
      legend.background = element_blank()
    )
  
   return(list(plot = p, summary = summary_df))
  
}


get_arranged_plot_averted_serostatus <- function(set_of_rds_files, variable_name, y_lab, t_begin, t_end) {
  
  plot_list <- list()
  summary_list <- list()
  
  for (i in seq_along(set_of_rds_files)) {
    
    rds_files <- set_of_rds_files[[i]]
    
    ## for total population
    nv_total <- extract_variable(rds_file = rds_files[1] , 
                            variable_name = variable_name) + 
      extract_variable(rds_file =  rds_files[1], 
                       variable_name = paste0(variable_name, "_v"))
    
    
    v_total <- extract_variable(rds_file = rds_files[2] , 
                                 variable_name = variable_name) + 
      extract_variable(rds_file =  rds_files[2], 
                       variable_name = paste0(variable_name, "_v"))
    
    ## seronegative
    nv_seroneg <- extract_variable(rds_file = rds_files[1] , 
                                 variable_name = paste0(variable_name, "_primary")) + 
      extract_variable(rds_file =  rds_files[1], 
                       variable_name = paste0(variable_name, "_v_primary"))
    
    
    v_seroneg <- extract_variable(rds_file = rds_files[2] , 
                                variable_name = paste0(variable_name, "_primary")) + 
      extract_variable(rds_file =  rds_files[2], 
                       variable_name = paste0(variable_name, "_v_primary"))
    
    ## seropositive
    nv_seropos <- extract_variable(rds_file = rds_files[1] , 
                                   variable_name = paste0(variable_name, "_secondary")) + 
      extract_variable(rds_file =  rds_files[1], 
                       variable_name = paste0(variable_name, "_v_secondary"))
    
    
    v_seropos <- extract_variable(rds_file = rds_files[2] , 
                                  variable_name = paste0(variable_name, "_secondary")) + 
      extract_variable(rds_file =  rds_files[2], 
                       variable_name = paste0(variable_name, "_v_secondary"))
    
    
    averted_serostatus_total <- get_averted_serostatus(nv_output = nv_total,
                                                 v_output = v_total,
                                                 t_begin = t_begin,
                                                 t_end = t_end)
    
    averted_serostatus_seroneg <- get_averted_serostatus(nv_output = nv_seroneg,
                                                   v_output = v_seroneg,
                                                   t_begin = t_begin,
                                                   t_end = t_end)
    
    averted_serostatus_seropos <- get_averted_serostatus(nv_output = nv_seropos,
                                                   v_output = v_seropos,
                                                   t_begin = t_begin,
                                                   t_end = t_end)
    
    df_averted_serostatus_total <- as.data.frame(averted_serostatus_total)
    
    df_averted_serostatus_seroneg <- as.data.frame(averted_serostatus_seroneg)
    
    df_averted_serostatus_seropos <- as.data.frame(averted_serostatus_seropos)
    
    # Determine y-axis settings for this figure
    if (i == 1 ) {  # Example: The second figure requires different limits
      y_limits <- custom_y_limits1
      y_breaks <- custom_y_breaks1
      
    } else if (i == 2) {
      y_limits <- custom_y_limits2
      y_breaks <- custom_y_breaks2
      
    } else if (i == 3) {
      y_limits <- custom_y_limits3
      y_breaks <- custom_y_breaks3
      
    }  else if (i == 4) {
      y_limits <- custom_y_limits4
      y_breaks <- custom_y_breaks4
    }
    
    
  
    result <- get_plot_averted_serostatus(
      df_total = df_averted_serostatus_total,
      df_seroneg = df_averted_serostatus_seroneg,
      df_seropos = df_averted_serostatus_seropos,
      y_limits = y_limits,
      y_breaks = y_breaks)
   
    averted_plot_serostatus <- result$plot
    
    plot_list[[i]] <-  averted_plot_serostatus
    summary_list[[i]] <- result$summary
    
  }
  
  
    ## store the estimates in a file for future reference
  names(summary_list) <- c("DENV1", "DENV2", "DENV3", "DENV4")
  combined_summary <- dplyr::bind_rows(summary_list, .id = "Sero")
  ## saving upto 3 decimal place
  combined_summary <- combined_summary %>%
  dplyr::mutate(
    mean_output = round(mean_output, 3),
    lower_bound = round(lower_bound, 3),
    upper_bound = round(upper_bound, 3)
  )
  write.table(combined_summary,
            file = here::here("output_estimate_figure", "percent_hosp_averted_serop_seron.txt"),
            sep = "\t",
            row.names = FALSE,
            quote = FALSE)
  
  
  
  ## remove legend in each of the figure
  plot_list_wo_legend <- list()
  
  for (i in seq_along(plot_list)) {
    plot_list_wo_legend[[i]] <- plot_list[[i]] + theme(legend.position = "none")
  }  
  
  ## extrct the legend  
  legend_plot <- get_legend(averted_plot_serostatus)  
  
  # Create the grid of plots without individual x and y labels
  plot_wo_labels <- plot_grid(
    plotlist = plot_list_wo_legend,
    nrow = 2,
    ncol = 2,
    align = "hv",
    axis = "tblr",
    labels = c("(a)", "(b)", "(c)", "(d)"),  # Add subfigure labels
    label_size = 40,                        # Adjust label size
    label_x = 0.03,                         # Adjust horizontal position of labels
    label_y = 1.08                          # Adjust vertical position of labels
  )
  
  plot_with_labels <- ggdraw() +
    draw_plot(plot_wo_labels, x = 0, y = 0, width = 1, height = 1) +   
    draw_label(y_lab, x = 0.01, y = 0.55, angle = 90, size = 45, fontface = "bold") +  # Y-axis label
    draw_label("Age at vaccination (year)", x = 0.5, y = 0.025, angle = 0, size = 45, fontface = "bold")           # X-axis label
  
  # make grid of plots  
  final_plot_with_legend <- plot_grid(
    legend_plot,
    plot_with_labels,
    nrow = 2, 
    rel_heights = c(0.1,1)  
  )
  
  return(final_plot_with_legend)
  
}  



### Inputs

## List all the datasets that we want to plot together
set_of_rds_files <- list(
  c("pri_sec_neq_detailed_a7_sero_dom_denv1_vcov_0.8_baseline_yes_nsamp_100_waning_0.rds",
    "pri_sec_neq_detailed_a7_sero_dom_denv1_vcov_0.8_baseline_no_nsamp_100_waning_0.rds"),  # Set 1

  c("pri_sec_neq_detailed_a7_sero_dom_denv2_vcov_0.8_baseline_yes_nsamp_100_waning_0.rds",
    "pri_sec_neq_detailed_a7_sero_dom_denv2_vcov_0.8_baseline_no_nsamp_100_waning_0.rds"),  # Set 2

  c("pri_sec_neq_detailed_a7_sero_dom_denv3_vcov_0.8_baseline_yes_nsamp_100_waning_0.rds",
    "pri_sec_neq_detailed_a7_sero_dom_denv3_vcov_0.8_baseline_no_nsamp_100_waning_0.rds"),  # Set 3

  c("pri_sec_neq_detailed_a7_sero_dom_denv4_vcov_0.8_baseline_yes_nsamp_100_waning_0.rds",
    "pri_sec_neq_detailed_a7_sero_dom_denv4_vcov_0.8_baseline_no_nsamp_100_waning_0.rds")    # Set 4
)


## grab the start of vaccination year from one of the dataset
t_begin = readRDS(here::here("model_output",set_of_rds_files[[1]][1]) )$v_year 

custom_y_limits1 <- c(0, 20)
custom_y_breaks1 <- seq(0, 20, by = 5)


custom_y_limits2 <- c(0, 20)
custom_y_breaks2 <- seq(0, 20, by = 5)

# Custom y-axis settings for a specific figure (for negative impact)(change it accordingly)
custom_y_limits3 <- c(-40, 20)
custom_y_breaks3 <- seq(-40, 20, by = 10)

custom_y_limits4 <- c(-60, 20)
custom_y_breaks4 <- seq(-60, 20, by = 20)

## Generate figure now
plot_impact <- get_arranged_plot_averted_serostatus(set_of_rds_files = set_of_rds_files,
                                                                    variable_name = "hosp_sample_age",
                                                                    y_lab = "Hospitalizations averted (%)",
                                                                    t_begin = t_begin,
                                                                    t_end = t_begin + 9)

figure_name <- "percent_hosp_averted_serop_seron.jpg"

## save
ggsave(
  filename = file.path(here("figure"), figure_name),  # Combine folder path and file name
  plot = plot_impact,                                            # The plot object to save
  width = 29*2,                                           # Width in inches
  height = 40,                                          # Height in inches
  dpi = 300,
  units = "cm")                                  # DPI (resolution)


```



### Percentage of averted stratified with baseline serostatus (cases and hospitalizations averted combined)
```{r}
get_agg_over_age <- function(arr) {
  arr_agg_age <- apply(arr, c(1,2,4), sum)
  return(arr_agg_age)
}

## cumulative number over year
get_cumulative_over_time <- function(arr, t_begin, t_end) {
  arr_cum_time <- apply(arr[, , t_begin:t_end], c(1, 2), sum)
  return(arr_cum_time)
}


## extract variable from .rds file
extract_variable <- function(rds_file, variable_name) {
  
  result <- readRDS(here::here("model_output",  rds_file) )
  
  out_v <- as.data.frame(result$output, stringsAsFactors = FALSE)
  
  n_vac_age = result$n_vac_age
  n_sample = result$n_sample
  n_age = result$n_age
  n_year = result$n_year
  
  x <- out_v[,colnames(out_v) == variable_name] 
  
  y <- array(NA, dim = c(n_vac_age,n_sample, n_age, n_year))
  
  for (i in 1:n_vac_age) {
    
    y[i,,,] <- x[[paste0("result.", i)]]
  }
  
  return(y)
}


get_averted_serostatus <- function(nv_output, v_output, t_begin, t_end){
  
  nv_agg_age <- get_agg_over_age(nv_output)
  v_agg_age <-  get_agg_over_age(v_output)
  # total_vac_agg_age <- get_agg_over_age(total_vac_output)
  
  nv_cum_t <- get_cumulative_over_time( nv_agg_age, t_begin = t_begin, t_end = t_end)
  v_cum_t <- get_cumulative_over_time( v_agg_age, t_begin = t_begin, t_end = t_end)
  # total_vac_cum_t <- get_cumulative_over_time(total_vac_agg_age, t_begin = t_begin, t_end = t_end)
  
  averted_serostatus <- 100*(nv_cum_t - v_cum_t)/nv_cum_t
  
  
  return(averted_serostatus)
  
}



get_plot_averted_serostatus <- function(df_total, df_seroneg, df_seropos, y_limits, y_breaks) {
  
  
  # Add a column for age groups
  df_total$age <- 1:nrow(df_total)
  df_seroneg$age <- 1:nrow(df_seroneg)
  df_seropos$age <- 1:nrow(df_seropos)
  
  # Reshape the dataframes to long format
  df_total_long <- gather(df_total, key = "Realization", value = "Output", -age)
  df_seroneg_long <- gather(df_seroneg, key = "Realization", value = "Output", -age)
  df_seropos_long <- gather(df_seropos, key = "Realization", value = "Output", -age)
  
  # Add a column to indicate the vaccine coverage for each dataset
  df_total_long$poptype <- "All"
  df_seroneg_long$poptype <- "Seronegative"
  df_seropos_long$poptype <- "Seropositive"
  
  # Combine all datasets into one long dataframe
  df_long <- bind_rows(df_total_long, df_seroneg_long, df_seropos_long)
  
  # Calculate the mean and 95% confidence interval for each age group and vaccine coverage
  summary_df <- df_long %>%
    group_by(age, poptype) %>%
    summarise(
      mean_output = mean(Output),
      lower_bound = quantile(Output, 0.025),
      upper_bound = quantile(Output, 0.975)
    ) %>%
    ungroup()
  
  
  
  # Define colors for different vaccine coverages
  poptype_barcolors <- c("All" = "#8dd3c7", "Seronegative" = "#fdb462", "Seropositive" = "#b3de69")
  
  poptype_errorbar_colors <- c("All" = "#55a39b", "Seronegative" = "#e08d3e", "Seropositive" = "#85a84e")
  
  # Define the dodge position for side-by-side plotting
  dodge <- position_dodge(width = 0.3)
  
  # Plot using ggplot2
  p <- ggplot(summary_df, aes(x = factor(age), y = mean_output, fill = poptype)) +
    # geom_point(size = 9, position = dodge, shape = 16) +  # Points for the mean with dodge
    geom_bar(stat = "identity", position = position_dodge(width = 0.75), width = 0.65) +
    
    geom_errorbar(aes(ymin = lower_bound, ymax = upper_bound, color = poptype), 
                  width = 0.0, size = 1.8, position = position_dodge(width = 0.75)) +
    # geom_errorbar(aes(ymin = lower_bound, ymax = upper_bound), 
    #               width = 0.0, size = 1.8, position = dodge) +  # Error bars with dodge
    scale_fill_manual(values = poptype_barcolors, name = "") + # Custom colors for bars
    scale_color_manual(values = poptype_errorbar_colors,  name = "") + # Custom colors for error bars
    # scale_color_manual(values = poptype_colors, name = "") + 
    scale_x_discrete(
      breaks = c(1, 2, 3, 4, 5, 6, 7),   # Set the positions of the x-axis ticks
      labels = c("6-16", "17-30", "31-40", "41-50", "51-60", "61-70", "71-80")  # Labels for age groups
    ) +
    # labs(x = "Age at vaccination", y = ylab, color = NULL) +  # Labels for x and y axes
    scale_y_continuous(limits = y_limits, breaks = y_breaks) +  # Define y-axis tick points )+
    theme_bw() +  # Clean theme
    theme(
      axis.ticks.length = unit(0.4, "cm"),        # Increase the length of the ticks
      axis.ticks = element_line(size = 1.5),      # Increase the thickness of the ticks
      panel.border = element_rect(color = "black", size = 2),  # Thicker border
      plot.margin = margin(t=10, r=10, b=20, l=25),
      axis.text.x = element_text(size = 35, color="black", angle= 30, margin = margin(t = 10, b = 20)),
      axis.text.y = element_text(size = 35,color="black", margin = margin(r = 10, l = 30)),
      # axis.title = element_text(size = 35, color = "black"),
      axis.title = element_blank(),
      legend.position = "top",
      legend.direction = "horizontal",
      legend.text = element_text(size = 40),
      legend.key.size = unit(2, "cm"),  # Increase size of legend keys
      legend.key.height = unit(1.5, "cm"),  # Increase height of legend keys
      legend.key.width = unit(2.5, "cm"),  # Increase width of legend keys
      legend.background = element_blank()
    )
  
   return(list(plot = p, summary = summary_df))
  
}


get_arranged_plot_averted_serostatus_combined <- function(set_of_rds_files, variable_name1, variable_name2, y_lab1, y_lab2, t_begin, t_end) {
  
  plot_list_cases <- list()
  plot_list_hosp <- list()
  # summary_list <- list()
  
  for (i in seq_along(set_of_rds_files)) {
    
    rds_files <- set_of_rds_files[[i]]
    
    ## for total population
    nv_total_cases <- extract_variable(rds_file = rds_files[1] , 
                            variable_name = variable_name1) + 
      extract_variable(rds_file =  rds_files[1], 
                       variable_name = paste0(variable_name1, "_v"))
    
    
    v_total_cases <- extract_variable(rds_file = rds_files[2] , 
                                 variable_name = variable_name1) + 
      extract_variable(rds_file =  rds_files[2], 
                       variable_name = paste0(variable_name1, "_v"))
    
    ## seronegative
    nv_seroneg_cases <- extract_variable(rds_file = rds_files[1] , 
                                 variable_name = paste0(variable_name1, "_primary")) + 
      extract_variable(rds_file =  rds_files[1], 
                       variable_name = paste0(variable_name1, "_v_primary"))
    
    
    v_seroneg_cases <- extract_variable(rds_file = rds_files[2] , 
                                variable_name = paste0(variable_name1, "_primary")) + 
      extract_variable(rds_file =  rds_files[2], 
                       variable_name = paste0(variable_name1, "_v_primary"))
    
    ## seropositive
    nv_seropos_cases <- extract_variable(rds_file = rds_files[1] , 
                                   variable_name = paste0(variable_name1, "_secondary")) + 
      extract_variable(rds_file =  rds_files[1], 
                       variable_name = paste0(variable_name1, "_v_secondary"))
    
    
    v_seropos_cases <- extract_variable(rds_file = rds_files[2] , 
                                  variable_name = paste0(variable_name1, "_secondary")) + 
      extract_variable(rds_file =  rds_files[2], 
                       variable_name = paste0(variable_name1, "_v_secondary"))
    
    
    averted_serostatus_total_cases <- get_averted_serostatus(nv_output = nv_total_cases,
                                                 v_output = v_total_cases,
                                                 t_begin = t_begin,
                                                 t_end = t_end)
    
    averted_serostatus_seroneg_cases <- get_averted_serostatus(nv_output = nv_seroneg_cases,
                                                   v_output = v_seroneg_cases,
                                                   t_begin = t_begin,
                                                   t_end = t_end)
    
    averted_serostatus_seropos_cases <- get_averted_serostatus(nv_output = nv_seropos_cases,
                                                   v_output = v_seropos_cases,
                                                   t_begin = t_begin,
                                                   t_end = t_end)
    
    df_averted_serostatus_total_cases <- as.data.frame(averted_serostatus_total_cases)
    
    df_averted_serostatus_seroneg_cases <- as.data.frame(averted_serostatus_seroneg_cases)
    
    df_averted_serostatus_seropos_cases <- as.data.frame(averted_serostatus_seropos_cases)
    
    
    
    
    # Determine y-axis settings for this figure
    if (i == 1 ) {  # Example: The second figure requires different limits
      y_limits <- custom_y_limits1_cases
      y_breaks <- custom_y_breaks1_cases
      
    } else if (i == 2) {
      y_limits <- custom_y_limits2_cases
      y_breaks <- custom_y_breaks2_cases
      
    } else if (i == 3) {
      y_limits <- custom_y_limits3_cases
      y_breaks <- custom_y_breaks3_cases
      
    }  else if (i == 4) {
      y_limits <- custom_y_limits4_cases
      y_breaks <- custom_y_breaks4_cases
    }
    
    
  
    result_cases <- get_plot_averted_serostatus(
      df_total = df_averted_serostatus_total_cases,
      df_seroneg = df_averted_serostatus_seroneg_cases,
      df_seropos = df_averted_serostatus_seropos_cases,
      y_limits = y_limits,
      y_breaks = y_breaks)
   
    averted_plot_serostatus_cases <- result_cases$plot
    
    plot_list_cases[[i]] <-  averted_plot_serostatus_cases
    # summary_list[[i]] <- result$summary
    
  }
  
  
#### now for hospitalizations
  
  
   for (i in seq_along(set_of_rds_files)) {
    
    rds_files <- set_of_rds_files[[i]]
    
    ## for total population
    nv_total_hosp <- extract_variable(rds_file = rds_files[1] , 
                            variable_name = variable_name2) + 
      extract_variable(rds_file =  rds_files[1], 
                       variable_name = paste0(variable_name2, "_v"))
    
    
    v_total_hosp <- extract_variable(rds_file = rds_files[2] , 
                                 variable_name = variable_name2) + 
      extract_variable(rds_file =  rds_files[2], 
                       variable_name = paste0(variable_name2, "_v"))
    
    ## seronegative
    nv_seroneg_hosp <- extract_variable(rds_file = rds_files[1] , 
                                 variable_name = paste0(variable_name2, "_primary")) + 
      extract_variable(rds_file =  rds_files[1], 
                       variable_name = paste0(variable_name2, "_v_primary"))
    
    
    v_seroneg_hosp <- extract_variable(rds_file = rds_files[2] , 
                                variable_name = paste0(variable_name2, "_primary")) + 
      extract_variable(rds_file =  rds_files[2], 
                       variable_name = paste0(variable_name2, "_v_primary"))
    
    ## seropositive
    nv_seropos_hosp <- extract_variable(rds_file = rds_files[1] , 
                                   variable_name = paste0(variable_name2, "_secondary")) + 
      extract_variable(rds_file =  rds_files[1], 
                       variable_name = paste0(variable_name2, "_v_secondary"))
    
    
    v_seropos_hosp <- extract_variable(rds_file = rds_files[2] , 
                                  variable_name = paste0(variable_name2, "_secondary")) + 
      extract_variable(rds_file =  rds_files[2], 
                       variable_name = paste0(variable_name2, "_v_secondary"))
    
    
    averted_serostatus_total_hosp <- get_averted_serostatus(nv_output = nv_total_hosp,
                                                 v_output = v_total_hosp,
                                                 t_begin = t_begin,
                                                 t_end = t_end)
    
    averted_serostatus_seroneg_hosp <- get_averted_serostatus(nv_output = nv_seroneg_hosp,
                                                   v_output = v_seroneg_hosp,
                                                   t_begin = t_begin,
                                                   t_end = t_end)
    
    averted_serostatus_seropos_hosp <- get_averted_serostatus(nv_output = nv_seropos_hosp,
                                                   v_output = v_seropos_hosp,
                                                   t_begin = t_begin,
                                                   t_end = t_end)
    
    df_averted_serostatus_total_hosp <- as.data.frame(averted_serostatus_total_hosp)
    
    df_averted_serostatus_seroneg_hosp <- as.data.frame(averted_serostatus_seroneg_hosp)
    
    df_averted_serostatus_seropos_hosp <- as.data.frame(averted_serostatus_seropos_hosp)
    
    # Determine y-axis settings for this figure
    if (i == 1 ) {  # Example: The second figure requires different limits
      y_limits <- custom_y_limits1_hosp
      y_breaks <- custom_y_breaks1_hosp
      
    } else if (i == 2) {
      y_limits <- custom_y_limits2_hosp
      y_breaks <- custom_y_breaks2_hosp
      
    } else if (i == 3) {
      y_limits <- custom_y_limits3_hosp
      y_breaks <- custom_y_breaks3_hosp
      
    }  else if (i == 4) {
      y_limits <- custom_y_limits4_hosp
      y_breaks <- custom_y_breaks4_hosp
    }
    
    
  
    result_hosp <- get_plot_averted_serostatus(
      df_total = df_averted_serostatus_total_hosp,
      df_seroneg = df_averted_serostatus_seroneg_hosp,
      df_seropos = df_averted_serostatus_seropos_hosp,
      y_limits = y_limits,
      y_breaks = y_breaks)
   
    averted_plot_serostatus_hosp <- result_hosp$plot
    
    plot_list_hosp[[i]] <-  averted_plot_serostatus_hosp
   
    
  }
  

  ### combine the plot
  plot_list <- c(plot_list_cases, plot_list_hosp)
  
  
  ## remove legend in each of the figure
  plot_list_wo_legend <- list()
  
  for (i in seq_along(plot_list)) {
    plot_list_wo_legend[[i]] <- plot_list[[i]] + theme(legend.position = "none")
  }  
  
  ## extrct the legend  
  legend_plot <- get_legend(averted_plot_serostatus_cases)  
  
  # Create the grid of plots without individual x and y labels
  plot_wo_labels <- plot_grid(
    plotlist = plot_list_wo_legend,
    nrow = 4,
    ncol = 2,
    align = "hv",
    axis = "tblr",
    labels = c("(a)", "(b)", "(c)", "(d)", "(e)", "(f)", "(g)", "(h)"),  # Add subfigure labels
    label_size = 40,                        # Adjust label size
    label_x = 0.03,                         # Adjust horizontal position of labels
    label_y = 1.08                          # Adjust vertical position of labels
  )
  
  plot_with_labels <- ggdraw() +
    draw_plot(plot_wo_labels, x = 0, y = 0, width = 1, height = 1) +   
    draw_label(y_lab1, x = 0.01, y = 0.78, angle = 90, size = 45, fontface = "bold") +  # Y-axis label
    draw_label(y_lab2, x = 0.01, y = 0.28, angle = 90, size = 45, fontface = "bold") +  # Y-axis label
    draw_label("Age at vaccination (year)", x = 0.5, y = 0.025, angle = 0, size = 45, fontface = "bold")           # X-axis label
  
  # make grid of plots  
  final_plot_with_legend <- plot_grid(
    legend_plot,
    plot_with_labels,
    nrow = 2, 
    rel_heights = c(0.1,1)  
  )
  
  return(final_plot_with_legend)
  
}  



### Inputs


## List all the datasets that we want to plot together
set_of_rds_files <- list(
  c("pri_sec_neq_detailed_a7_sero_dom_denv1_vcov_0.8_baseline_yes_nsamp_100_waning_0.rds",
    "pri_sec_neq_detailed_a7_sero_dom_denv1_vcov_0.8_baseline_no_nsamp_100_waning_0.rds"),  # Set 1

  c("pri_sec_neq_detailed_a7_sero_dom_denv2_vcov_0.8_baseline_yes_nsamp_100_waning_0.rds",
    "pri_sec_neq_detailed_a7_sero_dom_denv2_vcov_0.8_baseline_no_nsamp_100_waning_0.rds"),  # Set 2

  c("pri_sec_neq_detailed_a7_sero_dom_denv3_vcov_0.8_baseline_yes_nsamp_100_waning_0.rds",
    "pri_sec_neq_detailed_a7_sero_dom_denv3_vcov_0.8_baseline_no_nsamp_100_waning_0.rds"),  # Set 3

  c("pri_sec_neq_detailed_a7_sero_dom_denv4_vcov_0.8_baseline_yes_nsamp_100_waning_0.rds",
    "pri_sec_neq_detailed_a7_sero_dom_denv4_vcov_0.8_baseline_no_nsamp_100_waning_0.rds")    # Set 4
)


## grab the start of vaccination year from one of the dataset
t_begin = readRDS(here::here("model_output",set_of_rds_files[[1]][1]) )$v_year 

custom_y_limits1_cases <- c(0, 16.5)
custom_y_breaks1_cases <- seq(0, 15, by = 3)


custom_y_limits2_cases <- c(0, 16.5)
custom_y_breaks2_cases <- seq(0, 15, by = 3)

# Custom y-axis settings for a specific figure (for negative impact)(change it accordingly)
custom_y_limits3_cases <- c(-6, 15)
custom_y_breaks3_cases <- seq(-6, 15, by = 3)

custom_y_limits4_cases <- c(-64, 15)
custom_y_breaks4_cases <- seq(-60, 15, by = 15)


## for hospitalization

custom_y_limits1_hosp <- c(0, 20)
custom_y_breaks1_hosp <- seq(0, 20, by = 5)


custom_y_limits2_hosp <- c(0, 20)
custom_y_breaks2_hosp <- seq(0, 20, by = 5)

# Custom y-axis settings for a specific figure (for negative impact)(change it accordingly)
custom_y_limits3_hosp <- c(-40, 20)
custom_y_breaks3_hosp <- seq(-40, 20, by = 10)

custom_y_limits4_hosp <- c(-60, 20)
custom_y_breaks4_hosp <- seq(-60, 20, by = 20)



## Generate figure now
plot_impact <- get_arranged_plot_averted_serostatus_combined(set_of_rds_files = set_of_rds_files,
                                                                    variable_name1 = "symp_sample_age",
                                                                    variable_name2 = "hosp_sample_age",
                                                                    y_lab1 = "Reported cases averted (%)",
                                                                    y_lab2 = "Hospitalizations averted (%)",
                                                                    t_begin = t_begin,
                                                                    t_end = t_begin + 9)

figure_name <- "percent_averted_serop_seron_symp_hosp_combined.jpg"

## save
ggsave(
  filename = file.path(here("figure"), figure_name),  # Combine folder path and file name
  plot = plot_impact,                                            # The plot object to save
  width = 29*2,                                           # Width in inches
  height = 80,                                          # Height in inches
  dpi = 300,
  units = "cm")                                  # DPI (resolution)

```



### Percentage of cases averted  With vs without efficacy against infection
```{r}
get_agg_over_age <- function(arr) {
  arr_agg_age <- apply(arr, c(1,2,4), sum)
  return(arr_agg_age)
}

## cumulative number over year
get_cumulative_over_time <- function(arr, t_begin, t_end) {
  arr_cum_time <- apply(arr[, , t_begin:t_end], c(1, 2), sum)
  return(arr_cum_time)
}


## extract variable from .rds file
extract_variable <- function(rds_file, variable_name) {
  
  result <- readRDS(here::here("model_output",  rds_file) )
  
  out_v <- as.data.frame(result$output, stringsAsFactors = FALSE)
  
  n_vac_age = result$n_vac_age
  n_sample = result$n_sample
  n_age = result$n_age
  n_year = result$n_year
  
  x <- out_v[,colnames(out_v) == variable_name] 
  
  y <- array(NA, dim = c(n_vac_age,n_sample, n_age, n_year))
  
  for (i in 1:n_vac_age) {
    
    y[i,,,] <- x[[paste0("result.", i)]]
  }
  
  return(y)
}


get_averted_effi_inf <- function(nv_output, v_output, t_begin, t_end){
  
  nv_agg_age <- get_agg_over_age(nv_output)
  v_agg_age <-  get_agg_over_age(v_output)
  
  
  nv_cum_t <- get_cumulative_over_time( nv_agg_age, t_begin = t_begin, t_end = t_end)
  v_cum_t <- get_cumulative_over_time( v_agg_age, t_begin = t_begin, t_end = t_end)
  
  averted_effi_inf <- 100*(nv_cum_t - v_cum_t)/nv_cum_t 
  
  
  
  return(averted_effi_inf)
  
}


get_plot_averted_with_without_effi_inf <- function(df_with_effi_inf, df_without_effi_inf, y_limits, y_breaks) {
  
  
  # Add a column for age groups
  df_with_effi_inf$age <- 1:nrow(df_with_effi_inf)
  df_without_effi_inf$age <- 1:nrow(df_without_effi_inf)
  
  
  # Reshape the dataframes to long format
  df_with_effi_inf_long <- gather(df_with_effi_inf, key = "Realization", value = "Output", -age)
  df_without_effi_inf_long <- gather(df_without_effi_inf, key = "Realization", value = "Output", -age)
  
  
  # Add a column to indicate the vaccine coverage for each dataset
  df_with_effi_inf_long$efficacy_type <- "With efficacy against infection"
  df_without_effi_inf_long$efficacy_type <- "Without efficacy against infection"
  
  # Combine all datasets into one long dataframe
  df_long <- bind_rows(df_with_effi_inf_long, df_without_effi_inf_long)
  
  # Calculate the mean and 95% confidence interval for each age group and vaccine coverage
  summary_df <- df_long %>%
    group_by(age, efficacy_type) %>%
    summarise(
      mean_output = mean(Output),
      lower_bound = quantile(Output, 0.025),
      upper_bound = quantile(Output, 0.975)
    ) %>%
    ungroup()
  

  # Define colors for different vaccine coverages
  efficacy_type_barcolors <- c("With efficacy against infection" = "#fb8072", "Without efficacy against infection" = "#80b1d3")
  efficacy_type_errorbar_colors <- c("With efficacy against infection" = "#cc5045", "Without efficacy against infection" = "#40759a")
  # Define the dodge position for side-by-side plotting
  dodge <- position_dodge(width = 0.5)
  
  # Plot using ggplot2
  p <- ggplot(summary_df, aes(x = factor(age), y = mean_output, fill = efficacy_type)) +
    # geom_point(size = 9, position = dodge, shape = 16) +  # Points for the mean with dodge
    geom_bar(stat = "identity", position = position_dodge(width = 0.75), width = 0.65) +
    
    geom_errorbar(aes(ymin = lower_bound, ymax = upper_bound, color = efficacy_type), 
                  width = 0.0, size = 1.8, position = position_dodge(width = 0.75)) +
    # geom_errorbar(aes(ymin = lower_bound, ymax = upper_bound), 
    #               width = 0.0, size = 1.8, position = dodge) +  # Error bars with dodge
    scale_fill_manual(values = efficacy_type_barcolors, name = "") + # Custom colors for bars
    scale_color_manual(values = efficacy_type_errorbar_colors,  name = "") + # Custom colors for error bars
    # scale_color_manual(values = poptype_colors, name = "") + 
    scale_x_discrete(
      breaks = c(1, 2, 3, 4, 5, 6, 7),   # Set the positions of the x-axis ticks
      labels = c("6-16", "17-30", "31-40", "41-50", "51-60", "61-70", "71-80")  # Labels for age groups
    ) +
    # labs(x = "Age at vaccination", y = ylab, color = NULL) +  # Labels for x and y axes
    scale_y_continuous(limits = y_limits, breaks = y_breaks) +  # Define y-axis tick points )+
    theme_bw() +  # Clean theme
    theme(
      axis.ticks.length = unit(0.4, "cm"),        # Increase the length of the ticks
      axis.ticks = element_line(size = 1.5),      # Increase the thickness of the ticks
      panel.border = element_rect(color = "black", size = 2),  # Thicker border
      plot.margin = margin(t=10, r=10, b=20, l=25),
      axis.text.x = element_text(size = 35, color="black", angle= 30, margin = margin(t = 10, b = 20)),
      axis.text.y = element_text(size = 35,color="black", margin = margin(r = 10, l = 30)),
      # axis.title = element_text(size = 35, color = "black"),
      axis.title = element_blank(),
      legend.position = "top",
      legend.direction = "horizontal",
      legend.text = element_text(size = 40),
      legend.key.size = unit(2, "cm"),  # Increase size of legend keys
      legend.key.height = unit(1.5, "cm"),  # Increase height of legend keys
      legend.key.width = unit(2.5, "cm"),  # Increase width of legend keys
      legend.background = element_blank()
    )
  
     return(list(plot = p, summary = summary_df))
  
}



get_arranged_plot_averted_with_without_effi_inf <- function(set_of_rds_files, variable_name, y_lab, t_begin, t_end) {
  
  summary_list <- list()
  plot_list <- list()
  
  for (i in seq_along(set_of_rds_files)) {
    
    rds_files <- set_of_rds_files[[i]]
    
    ## for total population
    nv_with_effi_inf  <- extract_variable(rds_file = rds_files[1] , 
                                 variable_name = variable_name) + 
      extract_variable(rds_file =  rds_files[1], 
                       variable_name = paste0(variable_name, "_v"))
    
    v_with_effi_inf <- extract_variable(rds_file = rds_files[2] , 
                                        variable_name = variable_name) + 
      extract_variable(rds_file =  rds_files[2], 
                       variable_name = paste0(variable_name, "_v"))
    
    
    
    
    nv_without_effi_inf <- extract_variable(rds_file = rds_files[3] , 
                                variable_name = variable_name) + 
      extract_variable(rds_file =  rds_files[3], 
                       variable_name = paste0(variable_name, "_v"))
    
    v_without_effi_inf <- extract_variable(rds_file = rds_files[4] , 
                                        variable_name = variable_name) + 
      extract_variable(rds_file =  rds_files[4], 
                       variable_name = paste0(variable_name, "_v"))
    

   
    averted_with_effi_inf <- get_averted_effi_inf(nv_output = nv_with_effi_inf,
                                                 v_output = v_with_effi_inf,
                                                 t_begin = t_begin,
                                                 t_end = t_end)
    
    averted_without_effi_inf <- get_averted_effi_inf(nv_output = nv_without_effi_inf,
                                                   v_output = v_without_effi_inf,
                                                   t_begin = t_begin,
                                                   t_end = t_end)

    df_averted_with_effi_inf <- as.data.frame(averted_with_effi_inf)
    
    df_averted_without_effi_inf <- as.data.frame(averted_without_effi_inf)
    
  
    
    
    # Determine y-axis settings for this figure
    if (i == 1 ) {  # Example: The second figure requires different limits
      y_limits <- custom_y_limits1
      y_breaks <- custom_y_breaks1
      
    } else if (i == 2) {
      y_limits <- custom_y_limits2
      y_breaks <- custom_y_breaks2
      
    }else if (i == 3) {
      y_limits <- custom_y_limits3
      y_breaks <- custom_y_breaks3
      
    }else if (i == 4) {
      y_limits <- custom_y_limits4
      y_breaks <- custom_y_breaks4
      
    }
    
    
    result <- get_plot_averted_with_without_effi_inf(
      df_with_effi_inf =  df_averted_with_effi_inf,
      df_without_effi_inf = df_averted_without_effi_inf,
      y_limits = y_limits,
      y_breaks = y_breaks)
    
    averted_plot_with_without_effi_inf <- result$plot
    plot_list[[i]] <-  averted_plot_with_without_effi_inf
    summary_list[[i]] <- result$summary

    
  }
  
  names(summary_list) <- c("DENV1", "DENV2", "DENV3", "DENV4")
  combined_summary <- dplyr::bind_rows(summary_list, .id = "Sero")
  ## saving upto 3 decimal place
  combined_summary <- combined_summary %>%
  dplyr::mutate(
    mean_output = round(mean_output, 3),
    lower_bound = round(lower_bound, 3),
    upper_bound = round(upper_bound, 3)
  )
  write.table(combined_summary,
            file = here::here("output_estimate_figure", "percent_symp_averted_effi_inf.txt"),
            sep = "\t",
            row.names = FALSE,
            quote = FALSE)
  
  
  ## remove legend in each of the figure
  plot_list_wo_legend <- list()
  
  for (i in seq_along(plot_list)) {
    plot_list_wo_legend[[i]] <- plot_list[[i]] + theme(legend.position = "none")
  }  
  
  ## extrct the legend  
  legend_plot <- get_legend(averted_plot_with_without_effi_inf)  
  
  # Create the grid of plots without individual x and y labels
  plot_wo_labels <- plot_grid(
    plotlist = plot_list_wo_legend,
    nrow = 2,
    ncol = 2,
    align = "hv",
    axis = "tblr",
    labels = c("(a)", "(b)", "(c)", "(d)"),  # Add subfigure labels
    label_size = 40,                        # Adjust label size
    label_x = 0.03,                         # Adjust horizontal position of labels
    label_y = 1.08                          # Adjust vertical position of labels
  )
  
  plot_with_labels <- ggdraw() +
    draw_plot(plot_wo_labels, x = 0, y = 0, width = 1, height = 1) +   
    draw_label(y_lab, x = 0.01, y = 0.55, angle = 90, size = 45, fontface = "bold") +  # Y-axis label
    draw_label("Age at vaccination (year)", x = 0.5, y = 0.025, angle = 0, size = 45, fontface = "bold")           # X-axis label
  
  # make grid of plots  
  final_plot_with_legend <- plot_grid(
    legend_plot,
    plot_with_labels,
    nrow = 2, 
    rel_heights = c(0.1,1)  
  )
  
  return(final_plot_with_legend)
  
}  



### Inputs

## List all the datasets that we want to plot together
set_of_rds_files <- list(
  c("effi_inf_pri_sec_neq_detailed_a7_sero_dom_denv1_vcov_0.8_baseline_yes_nsamp_100_waning_0.rds", 
    "effi_inf_pri_sec_neq_detailed_a7_sero_dom_denv1_vcov_0.8_baseline_no_nsamp_100_waning_0.rds",
    "pri_sec_neq_detailed_a7_sero_dom_denv1_vcov_0.8_baseline_yes_nsamp_100_waning_0.rds",
    "pri_sec_neq_detailed_a7_sero_dom_denv1_vcov_0.8_baseline_no_nsamp_100_waning_0.rds"),  # Set 1
  
 c("effi_inf_pri_sec_neq_detailed_a7_sero_dom_denv2_vcov_0.8_baseline_yes_nsamp_100_waning_0.rds", 
    "effi_inf_pri_sec_neq_detailed_a7_sero_dom_denv2_vcov_0.8_baseline_no_nsamp_100_waning_0.rds",
    "pri_sec_neq_detailed_a7_sero_dom_denv2_vcov_0.8_baseline_yes_nsamp_100_waning_0.rds",
    "pri_sec_neq_detailed_a7_sero_dom_denv2_vcov_0.8_baseline_no_nsamp_100_waning_0.rds"),  # Set 2
  
 c("effi_inf_pri_sec_neq_detailed_a7_sero_dom_denv3_vcov_0.8_baseline_yes_nsamp_100_waning_0.rds", 
    "effi_inf_pri_sec_neq_detailed_a7_sero_dom_denv3_vcov_0.8_baseline_no_nsamp_100_waning_0.rds",
    "pri_sec_neq_detailed_a7_sero_dom_denv3_vcov_0.8_baseline_yes_nsamp_100_waning_0.rds",
    "pri_sec_neq_detailed_a7_sero_dom_denv3_vcov_0.8_baseline_no_nsamp_100_waning_0.rds"),   # Set 3
  
 c("effi_inf_pri_sec_neq_detailed_a7_sero_dom_denv4_vcov_0.8_baseline_yes_nsamp_100_waning_0.rds", 
    "effi_inf_pri_sec_neq_detailed_a7_sero_dom_denv4_vcov_0.8_baseline_no_nsamp_100_waning_0.rds",
    "pri_sec_neq_detailed_a7_sero_dom_denv4_vcov_0.8_baseline_yes_nsamp_100_waning_0.rds",
    "pri_sec_neq_detailed_a7_sero_dom_denv4_vcov_0.8_baseline_no_nsamp_100_waning_0.rds")   # Set 4
)

## grab the start of vaccination year from one of the dataset
t_begin = readRDS(here::here("model_output",set_of_rds_files[[1]][1]) )$v_year 

# General y-axis settings



custom_y_limits1 <- c(-10, 40)
custom_y_breaks1 <- seq(-10, 40, by = 10)

custom_y_limits2 <- c(-24, 68)
custom_y_breaks2 <- seq(-20, 60, by = 20)

# Custom y-axis settings for a specific figure (for negative impact)(change it accordingly)
custom_y_limits3 <- c(0, 20)
custom_y_breaks3 <- seq(0, 20, by = 5)

custom_y_limits4 <- c(-20, 30)
custom_y_breaks4 <- seq(-20, 30, by = 10)

## Generate figure now
plot_fig <- get_arranged_plot_averted_with_without_effi_inf(set_of_rds_files = set_of_rds_files,
                                                                              variable_name = "symp_sample_age",
                                                                              y_lab = "Reported cases averted (%)", 
                                                                              t_begin = t_begin,
                                                                              t_end = t_begin + 9)

figure_name <- "percent_symp_averted_effi_inf.jpg"

### save
ggsave(
  filename = file.path(here("figure"), figure_name),  # Combine folder path and file name
  plot = plot_fig,                                            # The plot object to save
  width = 29*2,                                           # Width in inches
  height = 40,                                          # Height in inches
  dpi = 300,
  units = "cm")                                  # DPI (resolution)



```


### percentage of hospitalizations averted  With vs without efficacy against infection
```{r}
get_agg_over_age <- function(arr) {
  arr_agg_age <- apply(arr, c(1,2,4), sum)
  return(arr_agg_age)
}

## cumulative number over year
get_cumulative_over_time <- function(arr, t_begin, t_end) {
  arr_cum_time <- apply(arr[, , t_begin:t_end], c(1, 2), sum)
  return(arr_cum_time)
}


## extract variable from .rds file
extract_variable <- function(rds_file, variable_name) {
  
  result <- readRDS(here::here("model_output",  rds_file) )
  
  out_v <- as.data.frame(result$output, stringsAsFactors = FALSE)
  
  n_vac_age = result$n_vac_age
  n_sample = result$n_sample
  n_age = result$n_age
  n_year = result$n_year
  
  x <- out_v[,colnames(out_v) == variable_name] 
  
  y <- array(NA, dim = c(n_vac_age,n_sample, n_age, n_year))
  
  for (i in 1:n_vac_age) {
    
    y[i,,,] <- x[[paste0("result.", i)]]
  }
  
  return(y)
}


get_averted_effi_inf <- function(nv_output, v_output, t_begin, t_end){
  
  nv_agg_age <- get_agg_over_age(nv_output)
  v_agg_age <-  get_agg_over_age(v_output)
  
  
  nv_cum_t <- get_cumulative_over_time( nv_agg_age, t_begin = t_begin, t_end = t_end)
  v_cum_t <- get_cumulative_over_time( v_agg_age, t_begin = t_begin, t_end = t_end)
  
  averted_effi_inf <- 100*(nv_cum_t - v_cum_t)/nv_cum_t 

  return(averted_effi_inf)
  
}


get_plot_averted_with_without_effi_inf <- function(df_with_effi_inf, df_without_effi_inf, y_limits, y_breaks) {
  
  
  # Add a column for age groups
  df_with_effi_inf$age <- 1:nrow(df_with_effi_inf)
  df_without_effi_inf$age <- 1:nrow(df_without_effi_inf)
  
  
  # Reshape the dataframes to long format
  df_with_effi_inf_long <- gather(df_with_effi_inf, key = "Realization", value = "Output", -age)
  df_without_effi_inf_long <- gather(df_without_effi_inf, key = "Realization", value = "Output", -age)
  
  
  # Add a column to indicate the vaccine coverage for each dataset
  df_with_effi_inf_long$efficacy_type <- "With efficacy against infection"
  df_without_effi_inf_long$efficacy_type <- "Without efficacy against infection"
  
  # Combine all datasets into one long dataframe
  df_long <- bind_rows(df_with_effi_inf_long, df_without_effi_inf_long)
  
  # Calculate the mean and 95% confidence interval for each age group and vaccine coverage
  summary_df <- df_long %>%
    group_by(age, efficacy_type) %>%
    summarise(
      mean_output = mean(Output),
      lower_bound = quantile(Output, 0.025),
      upper_bound = quantile(Output, 0.975)
    ) %>%
    ungroup()
  

  # Define colors for different vaccine coverages
  efficacy_type_barcolors <- c("With efficacy against infection" = "#fb8072", "Without efficacy against infection" = "#80b1d3")
  efficacy_type_errorbar_colors <- c("With efficacy against infection" = "#cc5045", "Without efficacy against infection" = "#40759a")
  # Define the dodge position for side-by-side plotting
  dodge <- position_dodge(width = 0.5)
  
  # Plot using ggplot2
  p <- ggplot(summary_df, aes(x = factor(age), y = mean_output, fill = efficacy_type)) +
    # geom_point(size = 9, position = dodge, shape = 16) +  # Points for the mean with dodge
    geom_bar(stat = "identity", position = position_dodge(width = 0.75), width = 0.65) +
    
    geom_errorbar(aes(ymin = lower_bound, ymax = upper_bound, color = efficacy_type), 
                  width = 0.0, size = 1.8, position = position_dodge(width = 0.75)) +
    # geom_errorbar(aes(ymin = lower_bound, ymax = upper_bound), 
    #               width = 0.0, size = 1.8, position = dodge) +  # Error bars with dodge
    scale_fill_manual(values = efficacy_type_barcolors, name = "") + # Custom colors for bars
    scale_color_manual(values = efficacy_type_errorbar_colors,  name = "") + # Custom colors for error bars
    # scale_color_manual(values = poptype_colors, name = "") + 
    scale_x_discrete(
      breaks = c(1, 2, 3, 4, 5, 6, 7),   # Set the positions of the x-axis ticks
      labels = c("6-16", "17-30", "31-40", "41-50", "51-60", "61-70", "71-80")  # Labels for age groups
    ) +
    # labs(x = "Age at vaccination", y = ylab, color = NULL) +  # Labels for x and y axes
    scale_y_continuous(limits = y_limits, breaks = y_breaks) +  # Define y-axis tick points )+
    theme_bw() +  # Clean theme
    theme(
      axis.ticks.length = unit(0.4, "cm"),        # Increase the length of the ticks
      axis.ticks = element_line(size = 1.5),      # Increase the thickness of the ticks
      panel.border = element_rect(color = "black", size = 2),  # Thicker border
      plot.margin = margin(t=10, r=10, b=20, l=25),
      axis.text.x = element_text(size = 35, color="black", angle= 30, margin = margin(t = 10, b = 20)),
      axis.text.y = element_text(size = 35,color="black", margin = margin(r = 10, l = 30)),
      # axis.title = element_text(size = 35, color = "black"),
      axis.title = element_blank(),
      legend.position = "top",
      legend.direction = "horizontal",
      legend.text = element_text(size = 40),
      legend.key.size = unit(2, "cm"),  # Increase size of legend keys
      legend.key.height = unit(1.5, "cm"),  # Increase height of legend keys
      legend.key.width = unit(2.5, "cm"),  # Increase width of legend keys
      legend.background = element_blank()
    )
  
     return(list(plot = p, summary = summary_df))
  
}



get_arranged_plot_averted_with_without_effi_inf <- function(set_of_rds_files, variable_name, y_lab, t_begin, t_end) {
  
  summary_list <- list()
  plot_list <- list()
  
  for (i in seq_along(set_of_rds_files)) {
    
    rds_files <- set_of_rds_files[[i]]
    
    ## for total population
    nv_with_effi_inf  <- extract_variable(rds_file = rds_files[1] , 
                                 variable_name = variable_name) + 
      extract_variable(rds_file =  rds_files[1], 
                       variable_name = paste0(variable_name, "_v"))
    
    v_with_effi_inf <- extract_variable(rds_file = rds_files[2] , 
                                        variable_name = variable_name) + 
      extract_variable(rds_file =  rds_files[2], 
                       variable_name = paste0(variable_name, "_v"))
    
    
    
    
    nv_without_effi_inf <- extract_variable(rds_file = rds_files[3] , 
                                variable_name = variable_name) + 
      extract_variable(rds_file =  rds_files[3], 
                       variable_name = paste0(variable_name, "_v"))
    
    v_without_effi_inf <- extract_variable(rds_file = rds_files[4] , 
                                        variable_name = variable_name) + 
      extract_variable(rds_file =  rds_files[4], 
                       variable_name = paste0(variable_name, "_v"))
    

   
    averted_with_effi_inf <- get_averted_effi_inf(nv_output = nv_with_effi_inf,
                                                 v_output = v_with_effi_inf,
                                                 t_begin = t_begin,
                                                 t_end = t_end)
    
    averted_without_effi_inf <- get_averted_effi_inf(nv_output = nv_without_effi_inf,
                                                   v_output = v_without_effi_inf,
                                                   t_begin = t_begin,
                                                   t_end = t_end)

    df_averted_with_effi_inf <- as.data.frame(averted_with_effi_inf)
    
    df_averted_without_effi_inf <- as.data.frame(averted_without_effi_inf)
    
  
    
    
    # Determine y-axis settings for this figure
    if (i == 1 ) {  # Example: The second figure requires different limits
      y_limits <- custom_y_limits1
      y_breaks <- custom_y_breaks1
      
    } else if (i == 2) {
      y_limits <- custom_y_limits2
      y_breaks <- custom_y_breaks2
      
    }else if (i == 3) {
      y_limits <- custom_y_limits3
      y_breaks <- custom_y_breaks3
      
    }else if (i == 4) {
      y_limits <- custom_y_limits4
      y_breaks <- custom_y_breaks4
      
    }
    
    
    result <- get_plot_averted_with_without_effi_inf(
      df_with_effi_inf =  df_averted_with_effi_inf,
      df_without_effi_inf = df_averted_without_effi_inf,
      y_limits = y_limits,
      y_breaks = y_breaks)
    
    averted_plot_with_without_effi_inf <- result$plot
    plot_list[[i]] <-  averted_plot_with_without_effi_inf
    summary_list[[i]] <- result$summary

    
  }
  
  names(summary_list) <- c("DENV1", "DENV2", "DENV3", "DENV4")
  combined_summary <- dplyr::bind_rows(summary_list, .id = "Sero")
  ## saving upto 3 decimal place
  combined_summary <- combined_summary %>%
  dplyr::mutate(
    mean_output = round(mean_output, 3),
    lower_bound = round(lower_bound, 3),
    upper_bound = round(upper_bound, 3)
  )
  write.table(combined_summary,
            file = here::here("output_estimate_figure", "percent_hosp_averted_effi_inf.txt"),
            sep = "\t",
            row.names = FALSE,
            quote = FALSE)
  
  
  ## remove legend in each of the figure
  plot_list_wo_legend <- list()
  
  for (i in seq_along(plot_list)) {
    plot_list_wo_legend[[i]] <- plot_list[[i]] + theme(legend.position = "none")
  }  
  
  ## extrct the legend  
  legend_plot <- get_legend(averted_plot_with_without_effi_inf)  
  
  # Create the grid of plots without individual x and y labels
  plot_wo_labels <- plot_grid(
    plotlist = plot_list_wo_legend,
    nrow = 2,
    ncol = 2,
    align = "hv",
    axis = "tblr",
    labels = c("(a)", "(b)", "(c)", "(d)"),  # Add subfigure labels
    label_size = 40,                        # Adjust label size
    label_x = 0.03,                         # Adjust horizontal position of labels
    label_y = 1.08                          # Adjust vertical position of labels
  )
  
  plot_with_labels <- ggdraw() +
    draw_plot(plot_wo_labels, x = 0, y = 0, width = 1, height = 1) +   
    draw_label(y_lab, x = 0.01, y = 0.55, angle = 90, size = 45, fontface = "bold") +  # Y-axis label
    draw_label("Age at vaccination (year)", x = 0.5, y = 0.025, angle = 0, size = 45, fontface = "bold")           # X-axis label
  
  # make grid of plots  
  final_plot_with_legend <- plot_grid(
    legend_plot,
    plot_with_labels,
    nrow = 2, 
    rel_heights = c(0.1,1)  
  )
  
  return(final_plot_with_legend)
  
}  



### Inputs

## List all the datasets that we want to plot together
set_of_rds_files <- list(
  c("effi_inf_pri_sec_neq_detailed_a7_sero_dom_denv1_vcov_0.8_baseline_yes_nsamp_100_waning_0.rds", 
    "effi_inf_pri_sec_neq_detailed_a7_sero_dom_denv1_vcov_0.8_baseline_no_nsamp_100_waning_0.rds",
    "pri_sec_neq_detailed_a7_sero_dom_denv1_vcov_0.8_baseline_yes_nsamp_100_waning_0.rds",
    "pri_sec_neq_detailed_a7_sero_dom_denv1_vcov_0.8_baseline_no_nsamp_100_waning_0.rds"),  # Set 1
  
 c("effi_inf_pri_sec_neq_detailed_a7_sero_dom_denv2_vcov_0.8_baseline_yes_nsamp_100_waning_0.rds", 
    "effi_inf_pri_sec_neq_detailed_a7_sero_dom_denv2_vcov_0.8_baseline_no_nsamp_100_waning_0.rds",
    "pri_sec_neq_detailed_a7_sero_dom_denv2_vcov_0.8_baseline_yes_nsamp_100_waning_0.rds",
    "pri_sec_neq_detailed_a7_sero_dom_denv2_vcov_0.8_baseline_no_nsamp_100_waning_0.rds"),  # Set 2
  
 c("effi_inf_pri_sec_neq_detailed_a7_sero_dom_denv3_vcov_0.8_baseline_yes_nsamp_100_waning_0.rds", 
    "effi_inf_pri_sec_neq_detailed_a7_sero_dom_denv3_vcov_0.8_baseline_no_nsamp_100_waning_0.rds",
    "pri_sec_neq_detailed_a7_sero_dom_denv3_vcov_0.8_baseline_yes_nsamp_100_waning_0.rds",
    "pri_sec_neq_detailed_a7_sero_dom_denv3_vcov_0.8_baseline_no_nsamp_100_waning_0.rds"),   # Set 3
  
 c("effi_inf_pri_sec_neq_detailed_a7_sero_dom_denv4_vcov_0.8_baseline_yes_nsamp_100_waning_0.rds", 
    "effi_inf_pri_sec_neq_detailed_a7_sero_dom_denv4_vcov_0.8_baseline_no_nsamp_100_waning_0.rds",
    "pri_sec_neq_detailed_a7_sero_dom_denv4_vcov_0.8_baseline_yes_nsamp_100_waning_0.rds",
    "pri_sec_neq_detailed_a7_sero_dom_denv4_vcov_0.8_baseline_no_nsamp_100_waning_0.rds")   # Set 4
)

## grab the start of vaccination year from one of the dataset
t_begin = readRDS(here::here("model_output",set_of_rds_files[[1]][1]) )$v_year 

# General y-axis settings




custom_y_limits1 <- c(-10, 41)
custom_y_breaks1 <- seq(-10, 40, by = 10)

custom_y_limits2 <- c(-30, 68)
custom_y_breaks2 <- seq(-30, 60, by = 15)

# Custom y-axis settings for a specific figure (for negative impact)(change it accordingly)
custom_y_limits3 <- c(0, 25)
custom_y_breaks3 <- seq(0, 25, by = 5)

custom_y_limits4 <- c(-0.05, 30)
custom_y_breaks4 <- seq(0, 30, by = 5)

## Generate figure now
plot_fig <- get_arranged_plot_averted_with_without_effi_inf(set_of_rds_files = set_of_rds_files,
                                                                              variable_name = "hosp_sample_age",
                                                                              y_lab = "Hospitalizations averted (%)", 
                                                                              t_begin = t_begin,
                                                                              t_end = t_begin + 9)

figure_name <- "percent_hosp_averted_effi_inf.jpg"

### save
ggsave(
  filename = file.path(here("figure"), figure_name),  # Combine folder path and file name
  plot = plot_fig,                                            # The plot object to save
  width = 29*2,                                           # Width in inches
  height = 40,                                          # Height in inches
  dpi = 300,
  units = "cm")                                  # DPI (resolution)



```









### Percentage averted  With vs without efficacy against infection (cases and hospitalization combined)
```{r}
get_agg_over_age <- function(arr) {
  arr_agg_age <- apply(arr, c(1,2,4), sum)
  return(arr_agg_age)
}

## cumulative number over year
get_cumulative_over_time <- function(arr, t_begin, t_end) {
  arr_cum_time <- apply(arr[, , t_begin:t_end], c(1, 2), sum)
  return(arr_cum_time)
}


## extract variable from .rds file
extract_variable <- function(rds_file, variable_name) {
  
  result <- readRDS(here::here("model_output",  rds_file) )
  
  out_v <- as.data.frame(result$output, stringsAsFactors = FALSE)
  
  n_vac_age = result$n_vac_age
  n_sample = result$n_sample
  n_age = result$n_age
  n_year = result$n_year
  
  x <- out_v[,colnames(out_v) == variable_name] 
  
  y <- array(NA, dim = c(n_vac_age,n_sample, n_age, n_year))
  
  for (i in 1:n_vac_age) {
    
    y[i,,,] <- x[[paste0("result.", i)]]
  }
  
  return(y)
}


get_averted_effi_inf <- function(nv_output, v_output, t_begin, t_end){
  
  nv_agg_age <- get_agg_over_age(nv_output)
  v_agg_age <-  get_agg_over_age(v_output)
  
  
  nv_cum_t <- get_cumulative_over_time( nv_agg_age, t_begin = t_begin, t_end = t_end)
  v_cum_t <- get_cumulative_over_time( v_agg_age, t_begin = t_begin, t_end = t_end)
  
  averted_effi_inf <- 100*(nv_cum_t - v_cum_t)/nv_cum_t 
  
  
  
  return(averted_effi_inf)
  
}


get_plot_averted_with_without_effi_inf <- function(df_with_effi_inf, df_without_effi_inf, y_limits, y_breaks) {
  
  
  # Add a column for age groups
  df_with_effi_inf$age <- 1:nrow(df_with_effi_inf)
  df_without_effi_inf$age <- 1:nrow(df_without_effi_inf)
  
  
  # Reshape the dataframes to long format
  df_with_effi_inf_long <- gather(df_with_effi_inf, key = "Realization", value = "Output", -age)
  df_without_effi_inf_long <- gather(df_without_effi_inf, key = "Realization", value = "Output", -age)
  
  
  # Add a column to indicate the vaccine coverage for each dataset
  df_with_effi_inf_long$efficacy_type <- "With efficacy against infection"
  df_without_effi_inf_long$efficacy_type <- "Without efficacy against infection"
  
  # Combine all datasets into one long dataframe
  df_long <- bind_rows(df_with_effi_inf_long, df_without_effi_inf_long)
  
  # Calculate the mean and 95% confidence interval for each age group and vaccine coverage
  summary_df <- df_long %>%
    group_by(age, efficacy_type) %>%
    summarise(
      mean_output = mean(Output),
      lower_bound = quantile(Output, 0.025),
      upper_bound = quantile(Output, 0.975)
    ) %>%
    ungroup()
  

  # Define colors for different vaccine coverages
  efficacy_type_barcolors <- c("With efficacy against infection" = "#fb8072", "Without efficacy against infection" = "#80b1d3")
  efficacy_type_errorbar_colors <- c("With efficacy against infection" = "#cc5045", "Without efficacy against infection" = "#40759a")
  # Define the dodge position for side-by-side plotting
  dodge <- position_dodge(width = 0.5)
  
  # Plot using ggplot2
  p <- ggplot(summary_df, aes(x = factor(age), y = mean_output, fill = efficacy_type)) +
    # geom_point(size = 9, position = dodge, shape = 16) +  # Points for the mean with dodge
    geom_bar(stat = "identity", position = position_dodge(width = 0.75), width = 0.65) +
    
    geom_errorbar(aes(ymin = lower_bound, ymax = upper_bound, color = efficacy_type), 
                  width = 0.0, size = 1.8, position = position_dodge(width = 0.75)) +
    # geom_errorbar(aes(ymin = lower_bound, ymax = upper_bound), 
    #               width = 0.0, size = 1.8, position = dodge) +  # Error bars with dodge
    scale_fill_manual(values = efficacy_type_barcolors, name = "") + # Custom colors for bars
    scale_color_manual(values = efficacy_type_errorbar_colors,  name = "") + # Custom colors for error bars
    # scale_color_manual(values = poptype_colors, name = "") + 
    scale_x_discrete(
      breaks = c(1, 2, 3, 4, 5, 6, 7),   # Set the positions of the x-axis ticks
      labels = c("6-16", "17-30", "31-40", "41-50", "51-60", "61-70", "71-80")  # Labels for age groups
    ) +
    # labs(x = "Age at vaccination", y = ylab, color = NULL) +  # Labels for x and y axes
    scale_y_continuous(limits = y_limits, breaks = y_breaks) +  # Define y-axis tick points )+
    theme_bw() +  # Clean theme
    theme(
      axis.ticks.length = unit(0.4, "cm"),        # Increase the length of the ticks
      axis.ticks = element_line(size = 1.5),      # Increase the thickness of the ticks
      panel.border = element_rect(color = "black", size = 2),  # Thicker border
      plot.margin = margin(t=10, r=10, b=20, l=25),
      axis.text.x = element_text(size = 35, color="black", angle= 30, margin = margin(t = 10, b = 20)),
      axis.text.y = element_text(size = 35,color="black", margin = margin(r = 10, l = 30)),
      # axis.title = element_text(size = 35, color = "black"),
      axis.title = element_blank(),
      legend.position = "top",
      legend.direction = "horizontal",
      legend.text = element_text(size = 40),
      legend.key.size = unit(2, "cm"),  # Increase size of legend keys
      legend.key.height = unit(1.5, "cm"),  # Increase height of legend keys
      legend.key.width = unit(2.5, "cm"),  # Increase width of legend keys
      legend.background = element_blank()
    )
  
     return(list(plot = p, summary = summary_df))
  
}



get_arranged_plot_averted_with_without_effi_inf_combined <- function(set_of_rds_files, variable_name1, variable_name2, y_lab1,y_lab2, t_begin, t_end) {
  
  # summary_list <- list()
  plot_list_cases <- list()
  plot_list_hosp <- list()
  
  for (i in seq_along(set_of_rds_files)) {
    
    rds_files <- set_of_rds_files[[i]]
    
    ## for total population
    nv_with_effi_inf_cases  <- extract_variable(rds_file = rds_files[1] , 
                                 variable_name = variable_name1) + 
      extract_variable(rds_file =  rds_files[1], 
                       variable_name = paste0(variable_name1, "_v"))
    
    v_with_effi_inf_cases <- extract_variable(rds_file = rds_files[2] , 
                                        variable_name = variable_name1) + 
      extract_variable(rds_file =  rds_files[2], 
                       variable_name = paste0(variable_name1, "_v"))
    
    
    
    
    nv_without_effi_inf_cases <- extract_variable(rds_file = rds_files[3] , 
                                variable_name = variable_name1) + 
      extract_variable(rds_file =  rds_files[3], 
                       variable_name = paste0(variable_name1, "_v"))
    
    v_without_effi_inf_cases <- extract_variable(rds_file = rds_files[4] , 
                                        variable_name = variable_name1) + 
      extract_variable(rds_file =  rds_files[4], 
                       variable_name = paste0(variable_name1, "_v"))
    

   
    averted_with_effi_inf_cases <- get_averted_effi_inf(nv_output = nv_with_effi_inf_cases,
                                                 v_output = v_with_effi_inf_cases,
                                                 t_begin = t_begin,
                                                 t_end = t_end)
    
    averted_without_effi_inf_cases <- get_averted_effi_inf(nv_output = nv_without_effi_inf_cases,
                                                   v_output = v_without_effi_inf_cases,
                                                   t_begin = t_begin,
                                                   t_end = t_end)

    df_averted_with_effi_inf_cases <- as.data.frame(averted_with_effi_inf_cases)
    
    df_averted_without_effi_inf_cases <- as.data.frame(averted_without_effi_inf_cases)
    
  
    
    
    # Determine y-axis settings for this figure
    if (i == 1 ) {  # Example: The second figure requires different limits
      y_limits <- custom_y_limits1_cases
      y_breaks <- custom_y_breaks1_cases
      
    } else if (i == 2) {
      y_limits <- custom_y_limits2_cases
      y_breaks <- custom_y_breaks2_cases
      
    }else if (i == 3) {
      y_limits <- custom_y_limits3_cases
      y_breaks <- custom_y_breaks3_cases
      
    }else if (i == 4) {
      y_limits <- custom_y_limits4_cases
      y_breaks <- custom_y_breaks4_cases
      
    }
    
    
    result_cases <- get_plot_averted_with_without_effi_inf(
      df_with_effi_inf =  df_averted_with_effi_inf_cases,
      df_without_effi_inf = df_averted_without_effi_inf_cases,
      y_limits = y_limits,
      y_breaks = y_breaks)
    
    averted_plot_with_without_effi_inf_cases <- result_cases$plot
    plot_list_cases[[i]] <-  averted_plot_with_without_effi_inf_cases
    # summary_list[[i]] <- result$summary

    
  }
  

  
  ## now for hospitalizations
  
   for (i in seq_along(set_of_rds_files)) {
    
    rds_files <- set_of_rds_files[[i]]
    
    ## for total population
    nv_with_effi_inf_hosp  <- extract_variable(rds_file = rds_files[1] , 
                                 variable_name = variable_name2) + 
      extract_variable(rds_file =  rds_files[1], 
                       variable_name = paste0(variable_name2, "_v"))
    
    v_with_effi_inf_hosp <- extract_variable(rds_file = rds_files[2] , 
                                        variable_name = variable_name2) + 
      extract_variable(rds_file =  rds_files[2], 
                       variable_name = paste0(variable_name2, "_v"))
    
    
    
    
    nv_without_effi_inf_hosp <- extract_variable(rds_file = rds_files[3] , 
                                variable_name = variable_name2) + 
      extract_variable(rds_file =  rds_files[3], 
                       variable_name = paste0(variable_name2, "_v"))
    
    v_without_effi_inf_hosp <- extract_variable(rds_file = rds_files[4] , 
                                        variable_name = variable_name2) + 
      extract_variable(rds_file =  rds_files[4], 
                       variable_name = paste0(variable_name2, "_v"))
    

   
    averted_with_effi_inf_hosp <- get_averted_effi_inf(nv_output = nv_with_effi_inf_hosp,
                                                 v_output = v_with_effi_inf_hosp,
                                                 t_begin = t_begin,
                                                 t_end = t_end)
    
    averted_without_effi_inf_hosp <- get_averted_effi_inf(nv_output = nv_without_effi_inf_hosp,
                                                   v_output = v_without_effi_inf_hosp,
                                                   t_begin = t_begin,
                                                   t_end = t_end)

    df_averted_with_effi_inf_hosp <- as.data.frame(averted_with_effi_inf_hosp)
    
    df_averted_without_effi_inf_hosp <- as.data.frame(averted_without_effi_inf_hosp)
    
  
    
    
    # Determine y-axis settings for this figure
    if (i == 1 ) {  # Example: The second figure requires different limits
      y_limits <- custom_y_limits1_hosp
      y_breaks <- custom_y_breaks1_hosp
      
    } else if (i == 2) {
      y_limits <- custom_y_limits2_hosp
      y_breaks <- custom_y_breaks2_hosp
      
    }else if (i == 3) {
      y_limits <- custom_y_limits3_hosp
      y_breaks <- custom_y_breaks3_hosp
      
    }else if (i == 4) {
      y_limits <- custom_y_limits4_hosp
      y_breaks <- custom_y_breaks4_hosp
      
    }
    
    
    result_hosp <- get_plot_averted_with_without_effi_inf(
      df_with_effi_inf =  df_averted_with_effi_inf_hosp,
      df_without_effi_inf = df_averted_without_effi_inf_hosp,
      y_limits = y_limits,
      y_breaks = y_breaks)
    
    averted_plot_with_without_effi_inf_hosp <- result_hosp$plot
    plot_list_hosp[[i]] <-  averted_plot_with_without_effi_inf_hosp
    # summary_list[[i]] <- result$summary

    
  }
  
  
  
  
  ## combine the plots
  
  plot_list <- c(plot_list_cases, plot_list_hosp)
  
  
  
  
  
  ## remove legend in each of the figure
  plot_list_wo_legend <- list()
  
  for (i in seq_along(plot_list)) {
    plot_list_wo_legend[[i]] <- plot_list[[i]] + theme(legend.position = "none")
  }  
  
  ## extrct the legend  
  legend_plot <- get_legend(averted_plot_with_without_effi_inf_cases)  
  
  # Create the grid of plots without individual x and y labels
  plot_wo_labels <- plot_grid(
    plotlist = plot_list_wo_legend,
    nrow = 4,
    ncol = 2,
    align = "hv",
    axis = "tblr",
    labels = c("(a)", "(b)", "(c)", "(d)", "(e)", "(f)", "(g)", "(h)"),  # Add subfigure labels
    label_size = 40,                        # Adjust label size
    label_x = 0.03,                         # Adjust horizontal position of labels
    label_y = 1.08                          # Adjust vertical position of labels
  )
  
  plot_with_labels <- ggdraw() +
    draw_plot(plot_wo_labels, x = 0, y = 0, width = 1, height = 1) +   
    draw_label(y_lab1, x = 0.01, y = 0.78, angle = 90, size = 45, fontface = "bold") +  # Y-axis label
    draw_label(y_lab2, x = 0.01, y = 0.28, angle = 90, size = 45, fontface = "bold") +  # Y-axis label
    draw_label("Age at vaccination (year)", x = 0.5, y = 0.025, angle = 0, size = 45, fontface = "bold")           # X-axis label
  
  # make grid of plots  
  final_plot_with_legend <- plot_grid(
    legend_plot,
    plot_with_labels,
    nrow = 2, 
    rel_heights = c(0.1,1)  
  )
  
  return(final_plot_with_legend)
  
}  



### Inputs

## List all the datasets that we want to plot together
set_of_rds_files <- list(
  c("effi_inf_pri_sec_neq_detailed_a7_sero_dom_denv1_vcov_0.8_baseline_yes_nsamp_100_waning_0.rds", 
    "effi_inf_pri_sec_neq_detailed_a7_sero_dom_denv1_vcov_0.8_baseline_no_nsamp_100_waning_0.rds",
    "pri_sec_neq_detailed_a7_sero_dom_denv1_vcov_0.8_baseline_yes_nsamp_100_waning_0.rds",
    "pri_sec_neq_detailed_a7_sero_dom_denv1_vcov_0.8_baseline_no_nsamp_100_waning_0.rds"),  # Set 1
  
 c("effi_inf_pri_sec_neq_detailed_a7_sero_dom_denv2_vcov_0.8_baseline_yes_nsamp_100_waning_0.rds", 
    "effi_inf_pri_sec_neq_detailed_a7_sero_dom_denv2_vcov_0.8_baseline_no_nsamp_100_waning_0.rds",
    "pri_sec_neq_detailed_a7_sero_dom_denv2_vcov_0.8_baseline_yes_nsamp_100_waning_0.rds",
    "pri_sec_neq_detailed_a7_sero_dom_denv2_vcov_0.8_baseline_no_nsamp_100_waning_0.rds"),  # Set 2
  
 c("effi_inf_pri_sec_neq_detailed_a7_sero_dom_denv3_vcov_0.8_baseline_yes_nsamp_100_waning_0.rds", 
    "effi_inf_pri_sec_neq_detailed_a7_sero_dom_denv3_vcov_0.8_baseline_no_nsamp_100_waning_0.rds",
    "pri_sec_neq_detailed_a7_sero_dom_denv3_vcov_0.8_baseline_yes_nsamp_100_waning_0.rds",
    "pri_sec_neq_detailed_a7_sero_dom_denv3_vcov_0.8_baseline_no_nsamp_100_waning_0.rds"),   # Set 3
  
 c("effi_inf_pri_sec_neq_detailed_a7_sero_dom_denv4_vcov_0.8_baseline_yes_nsamp_100_waning_0.rds", 
    "effi_inf_pri_sec_neq_detailed_a7_sero_dom_denv4_vcov_0.8_baseline_no_nsamp_100_waning_0.rds",
    "pri_sec_neq_detailed_a7_sero_dom_denv4_vcov_0.8_baseline_yes_nsamp_100_waning_0.rds",
    "pri_sec_neq_detailed_a7_sero_dom_denv4_vcov_0.8_baseline_no_nsamp_100_waning_0.rds")   # Set 4
)

## grab the start of vaccination year from one of the dataset
t_begin = readRDS(here::here("model_output",set_of_rds_files[[1]][1]) )$v_year 

# General y-axis settings



custom_y_limits1_cases <- c(-10, 40)
custom_y_breaks1_cases <- seq(-10, 40, by = 10)

custom_y_limits2_cases <- c(-24, 68)
custom_y_breaks2_cases <- seq(-20, 60, by = 20)

# Custom y-axis settings for a specific figure (for negative impact)(change it accordingly)
custom_y_limits3_cases <- c(0, 20)
custom_y_breaks3_cases <- seq(0, 20, by = 5)

custom_y_limits4_cases <- c(-20, 30)
custom_y_breaks4_cases <- seq(-20, 30, by = 10)


 ## for hospitalizations
custom_y_limits1_hosp <- c(-10, 41)
custom_y_breaks1_hosp <- seq(-10, 40, by = 10)

custom_y_limits2_hosp <- c(-30, 68)
custom_y_breaks2_hosp <- seq(-30, 60, by = 15)

# Custom y-axis settings for a specific figure (for negative impact)(change it accordingly)
custom_y_limits3_hosp <- c(0, 25)
custom_y_breaks3_hosp <- seq(0, 25, by = 5)

custom_y_limits4_hosp <- c(-0.05, 30)
custom_y_breaks4_hosp <- seq(0, 30, by = 5)



## Generate figure now
plot_fig <- get_arranged_plot_averted_with_without_effi_inf_combined(set_of_rds_files = set_of_rds_files,
                                                                              variable_name1 = "symp_sample_age",
                                                                              variable_name2 = "hosp_sample_age",
                                                                              y_lab1 = "Reported cases averted (%)", 
                                                                              y_lab2 = "Hospitalizations averted (%)",
                                                                              t_begin = t_begin,
                                                                              t_end = t_begin + 9)

figure_name <- "percent_averted_effi_inf_symp_hosp_combined.jpg"

### save
ggsave(
  filename = file.path(here("figure"), figure_name),  # Combine folder path and file name
  plot = plot_fig,                                            # The plot object to save
  width = 29*2,                                           # Width in inches
  height = 80,                                          # Height in inches
  dpi = 300,
  units = "cm")                                  # DPI (resolution)



```



### Population Impact of Prescreening on cases as percentage
```{r}
# 
# get_agg_over_age <- function(arr) {
#   arr_agg_age <- apply(arr, c(1,2,4), sum)
#   return(arr_agg_age)
# }
# 
# ## cumulative number over year
# get_cumulative_over_time <- function(arr, t_begin, t_end) {
#   arr_cum_time <- apply(arr[, , t_begin:t_end], c(1, 2), sum)
#   return(arr_cum_time)
# }
# 
# 
# ## extract variable from .rds file
# extract_variable <- function(rds_file, variable_name) {
#   
#   result <- readRDS(here::here("model_output",  rds_file) )
#   
#   out_v <- as.data.frame(result$output, stringsAsFactors = FALSE)
#   
#   n_vac_age = result$n_vac_age
#   n_sample = result$n_sample
#   n_age = result$n_age
#   n_year = result$n_year
#   
#   x <- out_v[,colnames(out_v) == variable_name] 
#   
#   y <- array(NA, dim = c(n_vac_age,n_sample, n_age, n_year))
#   
#   for (i in 1:n_vac_age) {
#     
#     y[i,,,] <- x[[paste0("result.", i)]]
#   }
#   
#   return(y)
# }
# 
# 
# get_averted_screening <- function(nv_output, v_output,  t_begin, t_end){
#   
#   nv_agg_age <- get_agg_over_age(nv_output)
#   v_agg_age <-  get_agg_over_age(v_output)
#   
#   nv_cum_t <- get_cumulative_over_time( nv_agg_age, t_begin = t_begin, t_end = t_end)
#   v_cum_t <- get_cumulative_over_time( v_agg_age, t_begin = t_begin, t_end = t_end)
#   
#   averted_screening <- 100*(nv_cum_t - v_cum_t)/nv_cum_t   
#   
#   return( averted_screening)
# }
# 
# 
# get_plot_averted_screening <- function(df_with_screening, df_without_screening, y_limits, y_breaks) 
#   
#   {
#   
#   
#   # Add a column for age groups
#   df_with_screening$age <- 1:nrow(df_with_screening)
#   df_without_screening$age <- 1:nrow(df_without_screening)
#   
#   
#   # Reshape the dataframes to long format
#   df_with_screening_long <- gather(df_with_screening, key = "Realization", value = "Output", -age)
#   df_without_screening_long <- gather(df_without_screening, key = "Realization", value = "Output", -age)
#   
#   
#   # Add a column to indicate the vaccine coverage for each dataset
#   df_with_screening_long$screening_type <- "With pre-screening"
#   df_without_screening_long$screening_type <- "Without pre-screening"
#   
#   # Combine all datasets into one long dataframe
#   df_long <- bind_rows(df_with_screening_long, df_without_screening_long)
#   
#   # Calculate the mean and 95% confidence interval for each age group and vaccine coverage
#   summary_df <- df_long %>%
#     group_by(age, screening_type) %>%
#     summarise(
#       mean_output = mean(Output),
#       lower_bound = quantile(Output, 0.025),
#       upper_bound = quantile(Output, 0.975)
#     ) %>%
#     ungroup()
#   
#   # Define colors for different vaccine coverages
#   screening_type_barcolors <- c("With pre-screening" = "#d8b365", "Without pre-screening" = "#5ab4ac")
#   screening_type_errorbar_colors <- c("With pre-screening" = "#8c510a", "Without pre-screening" = "#01665e")
#   # Define the dodge position for side-by-side plotting
#   dodge <- position_dodge(width = 0.5)
#   
#   # Plot using ggplot2
#   p <- ggplot(summary_df, aes(x = factor(age), y = mean_output, fill = screening_type)) +
#     # geom_point(size = 9, position = dodge, shape = 16) +  # Points for the mean with dodge
#     geom_bar(stat = "identity", position = position_dodge(width = 0.75), width = 0.65) +
#     
#     geom_errorbar(aes(ymin = lower_bound, ymax = upper_bound, color = screening_type), 
#                   width = 0.0, size = 1.8, position = position_dodge(width = 0.75)) +
#     
#     scale_fill_manual(values = screening_type_barcolors, name = "") + # Custom colors for bars
#     scale_color_manual(values = screening_type_errorbar_colors,  name = "") + # Custom colors for error bars
#     # scale_color_manual(values = poptype_colors, name = "") + 
#     scale_x_discrete(
#       breaks = c(1, 2, 3, 4, 5, 6, 7),   # Set the positions of the x-axis ticks
#       labels = c("6-16", "17-30", "31-40", "41-50", "51-60", "61-70", "71-80")  # Labels for age groups
#     ) +
#     # labs(x = "Age at vaccination", y = ylab, color = NULL) +  # Labels for x and y axes
#     scale_y_continuous(limits = y_limits, breaks = y_breaks) +  # Define y-axis tick points )+
#     theme_bw() +  # Clean theme
#     theme(
#       axis.ticks.length = unit(0.4, "cm"),        # Increase the length of the ticks
#       axis.ticks = element_line(size = 1.5),      # Increase the thickness of the ticks
#       panel.border = element_rect(color = "black", size = 2),  # Thicker border
#       plot.margin = margin(t=10, r=10, b=20, l=25),
#       axis.text.x = element_text(size = 35, color="black", angle= 30, margin = margin(t = 10, b = 20)),
#       axis.text.y = element_text(size = 35,color="black", margin = margin(r = 10, l = 30)),
#       # axis.title = element_text(size = 35, color = "black"),
#       axis.title = element_blank(),
#       legend.position = "top",
#       legend.direction = "horizontal",
#       legend.text = element_text(size = 40),
#       legend.key.size = unit(2, "cm"),  # Increase size of legend keys
#       legend.key.height = unit(1.5, "cm"),  # Increase height of legend keys
#       legend.key.width = unit(2.5, "cm"),  # Increase width of legend keys
#       legend.background = element_blank()
#     )
#   
#   
#   
# }
# 
# 
# 
# get_arranged_plot_averted_screening <- function(set_of_rds_files, variable_name, y_lab, t_begin, t_end) {
#   
#   plot_list <- list()
#   
#   for (i in seq_along(set_of_rds_files)) {
#     
#     rds_files <- set_of_rds_files[[i]]
#     
#     ## for total population
#     nv_total_without_screening <- 1*extract_variable(rds_file = rds_files[1] , 
#                                  variable_name = variable_name) + 
#       1*extract_variable(rds_file =  rds_files[1], 
#                        variable_name = paste0(variable_name, "_v"))
#     
#     
#     v_without_screening <- 1*extract_variable(rds_file = rds_files[2] , 
#                                            variable_name = variable_name) + 
#       1*extract_variable(rds_file =  rds_files[2], 
#                        variable_name = paste0(variable_name, "_v"))
#     
#     
#     nv_total_with_screening <- 1*extract_variable(rds_file = rds_files[3] , 
#                                  variable_name = variable_name) + 
#     1*extract_variable(rds_file =  rds_files[3], 
#                        variable_name = paste0(variable_name, "_v"))
#     
#     
#     v_with_screening <- 1*extract_variable(rds_file = rds_files[4] , 
#                                         variable_name = variable_name) + 
#       1*extract_variable(rds_file =  rds_files[4], 
#                        variable_name = paste0(variable_name, "_v"))
#     
#  
#     averted_without_screening <- get_averted_screening(nv_output = nv_total_without_screening,
#                                                             v_output = v_without_screening,
#                                                             t_begin = t_begin,
#                                                             t_end = t_end)
#     
#     averted_with_screening <- get_averted_screening(nv_output = nv_total_with_screening,
#                                                          v_output = v_with_screening,
#                                                          t_begin = t_begin,
#                                                          t_end = t_end)
#     
#  
#     df_averted_without_screening <- as.data.frame(averted_without_screening)
#     df_averted_with_screening <- as.data.frame(averted_with_screening )
#     
#     # Determine y-axis settings for this figure
#     if (i == 1 ) {  # Example: The second figure requires different limits
#       y_limits <- custom_y_limits1
#       y_breaks <- custom_y_breaks1
#       
#     } else if (i == 2) {
#       y_limits <- custom_y_limits2
#       y_breaks <- custom_y_breaks2
#       
#     }else if (i == 3) {
#       y_limits <- custom_y_limits3
#       y_breaks <- custom_y_breaks3
#       
#     }else if (i == 4) {
#       y_limits <- custom_y_limits4
#       y_breaks <- custom_y_breaks4
#       
#     }
#     
#     
#     averted_plot_screening <- get_plot_averted_screening(
#       df_with_screening =  df_averted_with_screening ,
#       df_without_screening = df_averted_without_screening,
#       y_limits = y_limits,
#       y_breaks = y_breaks)
#     
#     
#     
#     plot_list[[i]] <-  averted_plot_screening 
#     
#   }
#   
#   ## remove legend in each of the figure
#   plot_list_wo_legend <- list()
#   
#   for (i in seq_along(plot_list)) {
#     plot_list_wo_legend[[i]] <- plot_list[[i]] + theme(legend.position = "none")
#   }  
#   
#   ## extrct the legend  
#   legend_plot <- get_legend( averted_plot_screening )  
#   
#   # Create the grid of plots without individual x and y labels
#   plot_wo_labels <- plot_grid(
#     plotlist = plot_list_wo_legend,
#     nrow = 2,
#     ncol = 2,
#     align = "hv",
#     axis = "tblr",
#     labels = c("(a)", "(b)", "(c)", "(d)"),  # Add subfigure labels
#     label_size = 40,                        # Adjust label size
#     label_x = 0.03,                         # Adjust horizontal position of labels
#     label_y = 1.08                          # Adjust vertical position of labels
#   )
#   
#   plot_with_labels <- ggdraw() +
#     draw_plot(plot_wo_labels, x = 0, y = 0, width = 1, height = 1) +   
#     draw_label(y_lab, x = 0.01, y = 0.55, angle = 90, size = 45, fontface = "bold") +  # Y-axis label
#     draw_label("Age at vaccination (year)", x = 0.5, y = 0.025, angle = 0, size = 45, fontface = "bold")           # X-axis label
#   
#   # make grid of plots  
#   final_plot_with_legend <- plot_grid(
#     legend_plot,
#     plot_with_labels,
#     nrow = 2, 
#     rel_heights = c(0.1,1)  
#   )
#   
#   return(final_plot_with_legend)
#   
# }  
# 
# 
# 
# ### Inputs
# 
# ## List all the datasets that we want to plot together
# set_of_rds_files <- list(
#   c("pri_sec_neq_detailed_a7_sero_dom_denv1_vcov_0.8_baseline_yes_nsamp_100_waning_0.rds",
#     "pri_sec_neq_detailed_a7_sero_dom_denv1_vcov_0.8_baseline_no_nsamp_100_waning_0.rds",
#     "pri_sec_neq_detailed_a7_sero_dom_denv1_vcov_0.8_baseline_yes_nsamp_100_waning_0_prescrng_1.rds",
#     "pri_sec_neq_detailed_a7_sero_dom_denv1_vcov_0.8_baseline_no_nsamp_100_waning_0_prescrng_1.rds"),  # Set 1
# 
#  c("pri_sec_neq_detailed_a7_sero_dom_denv2_vcov_0.8_baseline_yes_nsamp_100_waning_0.rds",
#     "pri_sec_neq_detailed_a7_sero_dom_denv2_vcov_0.8_baseline_no_nsamp_100_waning_0.rds",
#     "pri_sec_neq_detailed_a7_sero_dom_denv2_vcov_0.8_baseline_yes_nsamp_100_waning_0_prescrng_1.rds",
#     "pri_sec_neq_detailed_a7_sero_dom_denv2_vcov_0.8_baseline_no_nsamp_100_waning_0_prescrng_1.rds"), # Set 2
#  
#  c("pri_sec_neq_detailed_a7_sero_dom_denv3_vcov_0.8_baseline_yes_nsamp_100_waning_0.rds",
#     "pri_sec_neq_detailed_a7_sero_dom_denv3_vcov_0.8_baseline_no_nsamp_100_waning_0.rds",
#     "pri_sec_neq_detailed_a7_sero_dom_denv3_vcov_0.8_baseline_yes_nsamp_100_waning_0_prescrng_1.rds",
#     "pri_sec_neq_detailed_a7_sero_dom_denv3_vcov_0.8_baseline_no_nsamp_100_waning_0_prescrng_1.rds"), # Set 3
#  
#  c("pri_sec_neq_detailed_a7_sero_dom_denv4_vcov_0.8_baseline_yes_nsamp_100_waning_0.rds",
#     "pri_sec_neq_detailed_a7_sero_dom_denv4_vcov_0.8_baseline_no_nsamp_100_waning_0.rds",
#     "pri_sec_neq_detailed_a7_sero_dom_denv4_vcov_0.8_baseline_yes_nsamp_100_waning_0_prescrng_1.rds",
#     "pri_sec_neq_detailed_a7_sero_dom_denv4_vcov_0.8_baseline_no_nsamp_100_waning_0_prescrng_1.rds") # set 4
# )
# 
# 
# ## grab the start of vaccination year from one of the dataset
# t_begin = readRDS(here::here("model_output",set_of_rds_files[[1]][1]) )$v_year 
# 
# 
# custom_y_limits1 <- c(0, 15)
# custom_y_breaks1 <- seq(0, 15, by = 3)
# 
# custom_y_limits2 <- c(0, 15)
# custom_y_breaks2 <- seq(0, 15, by = 3)
# 
# # Custom y-axis settings for a specific figure (for negative impact)(change it accordingly)
# custom_y_limits3 <- c(0,15)
# custom_y_breaks3 <- seq(0, 15, by = 3)
# 
# custom_y_limits4 <- c(-20, 15)
# custom_y_breaks4 <- seq(-20, 15, by = 5)
# 
# 
# 
# ## Generate figure now
# plot_fig <- get_arranged_plot_averted_screening(set_of_rds_files = set_of_rds_files,
#                                                                     variable_name = "symp_sample_age",
#                                                                     y_lab = "Reported cases averted (%)", 
#                                                                     t_begin = t_begin,
#                                                                     t_end = t_begin + 9)
# 
# figure_name <- "percent_symp_averted_screening_population.jpg"
# 
# ### save
# ggsave(
#   filename = file.path(here("figure"), figure_name),  # Combine folder path and file name
#   plot = plot_fig,                                            # The plot object to save
#   width = 29*2,                                           # Width in inches
#   height = 40,                                          # Height in inches
#   dpi = 300,
#   units = "cm")                                  # DPI (resolution)
# ```
# 
# 
# 
# ### Population Impact of Prescreening on hospitalizations
# 
# ```{r}
# 
# get_agg_over_age <- function(arr) {
#   arr_agg_age <- apply(arr, c(1,2,4), sum)
#   return(arr_agg_age)
# }
# 
# ## cumulative number over year
# get_cumulative_over_time <- function(arr, t_begin, t_end) {
#   arr_cum_time <- apply(arr[, , t_begin:t_end], c(1, 2), sum)
#   return(arr_cum_time)
# }
# 
# 
# ## extract variable from .rds file
# extract_variable <- function(rds_file, variable_name) {
#   
#   result <- readRDS(here::here("model_output",  rds_file) )
#   
#   out_v <- as.data.frame(result$output, stringsAsFactors = FALSE)
#   
#   n_vac_age = result$n_vac_age
#   n_sample = result$n_sample
#   n_age = result$n_age
#   n_year = result$n_year
#   
#   x <- out_v[,colnames(out_v) == variable_name] 
#   
#   y <- array(NA, dim = c(n_vac_age,n_sample, n_age, n_year))
#   
#   for (i in 1:n_vac_age) {
#     
#     y[i,,,] <- x[[paste0("result.", i)]]
#   }
#   
#   return(y)
# }
# 
# 
# get_averted_screening <- function(nv_output, v_output,  t_begin, t_end){
#   
#   nv_agg_age <- get_agg_over_age(nv_output)
#   v_agg_age <-  get_agg_over_age(v_output)
#   
#   nv_cum_t <- get_cumulative_over_time( nv_agg_age, t_begin = t_begin, t_end = t_end)
#   v_cum_t <- get_cumulative_over_time( v_agg_age, t_begin = t_begin, t_end = t_end)
#   
#   averted_screening <- 100*(nv_cum_t - v_cum_t)/nv_cum_t 
#   
#   return( averted_screening)
# }
# 
# 
# get_plot_averted_screening <- function(df_with_screening, df_without_screening, y_limits, y_breaks) 
#   
#   {
#   
#   
#   # Add a column for age groups
#   df_with_screening$age <- 1:nrow(df_with_screening)
#   df_without_screening$age <- 1:nrow(df_without_screening)
#   
#   
#   # Reshape the dataframes to long format
#   df_with_screening_long <- gather(df_with_screening, key = "Realization", value = "Output", -age)
#   df_without_screening_long <- gather(df_without_screening, key = "Realization", value = "Output", -age)
#   
#   
#   # Add a column to indicate the vaccine coverage for each dataset
#   df_with_screening_long$screening_type <- "With pre-screening"
#   df_without_screening_long$screening_type <- "Without pre-screening"
#   
#   # Combine all datasets into one long dataframe
#   df_long <- bind_rows(df_with_screening_long, df_without_screening_long)
#   
#   # Calculate the mean and 95% confidence interval for each age group and vaccine coverage
#   summary_df <- df_long %>%
#     group_by(age, screening_type) %>%
#     summarise(
#       mean_output = mean(Output),
#       lower_bound = quantile(Output, 0.025),
#       upper_bound = quantile(Output, 0.975)
#     ) %>%
#     ungroup()
#   
#   # Define colors for different vaccine coverages
#   screening_type_barcolors <- c("With pre-screening" = "#d8b365", "Without pre-screening" = "#5ab4ac")
#   screening_type_errorbar_colors <- c("With pre-screening" = "#8c510a", "Without pre-screening" = "#01665e")
#   # Define the dodge position for side-by-side plotting
#   dodge <- position_dodge(width = 0.5)
#   
#   # Plot using ggplot2
#   p <- ggplot(summary_df, aes(x = factor(age), y = mean_output, fill = screening_type)) +
#     # geom_point(size = 9, position = dodge, shape = 16) +  # Points for the mean with dodge
#     geom_bar(stat = "identity", position = position_dodge(width = 0.75), width = 0.65) +
#     
#     geom_errorbar(aes(ymin = lower_bound, ymax = upper_bound, color = screening_type), 
#                   width = 0.0, size = 1.8, position = position_dodge(width = 0.75)) +
#     # geom_errorbar(aes(ymin = lower_bound, ymax = upper_bound), 
#     #               width = 0.0, size = 1.8, position = dodge) +  # Error bars with dodge
#     scale_fill_manual(values = screening_type_barcolors, name = "") + # Custom colors for bars
#     scale_color_manual(values = screening_type_errorbar_colors,  name = "") + # Custom colors for error bars
#     # scale_color_manual(values = poptype_colors, name = "") + 
#     scale_x_discrete(
#       breaks = c(1, 2, 3, 4, 5, 6, 7),   # Set the positions of the x-axis ticks
#       labels = c("6-16", "17-30", "31-40", "41-50", "51-60", "61-70", "71-80")  # Labels for age groups
#     ) +
#     
#     scale_y_continuous(limits = y_limits, breaks = y_breaks) +  # Define y-axis tick points )+
#     theme_bw() +  # Clean theme
#     theme(
#       axis.ticks.length = unit(0.4, "cm"),        # Increase the length of the ticks
#       axis.ticks = element_line(size = 1.5),      # Increase the thickness of the ticks
#       panel.border = element_rect(color = "black", size = 2),  # Thicker border
#       plot.margin = margin(t=10, r=10, b=20, l=25),
#       axis.text.x = element_text(size = 35, color="black", angle= 30, margin = margin(t = 10, b = 20)),
#       axis.text.y = element_text(size = 35,color="black", margin = margin(r = 10, l = 30)),
#       # axis.title = element_text(size = 35, color = "black"),
#       axis.title = element_blank(),
#       legend.position = "top",
#       legend.direction = "horizontal",
#       legend.text = element_text(size = 40),
#       legend.key.size = unit(2, "cm"),  # Increase size of legend keys
#       legend.key.height = unit(1.5, "cm"),  # Increase height of legend keys
#       legend.key.width = unit(2.5, "cm"),  # Increase width of legend keys
#       legend.background = element_blank()
#     )
#   
#   
#   
# }
# 
# 
# 
# get_arranged_plot_averted_screening <- function(set_of_rds_files, variable_name, y_lab, t_begin, t_end) {
#   
#   plot_list <- list()
#   
#   for (i in seq_along(set_of_rds_files)) {
#     
#     rds_files <- set_of_rds_files[[i]]
#     
#     ## for total population
#     nv_total_without_screening <- 1*extract_variable(rds_file = rds_files[1] , 
#                                  variable_name = variable_name) + 
#       1*extract_variable(rds_file =  rds_files[1], 
#                        variable_name = paste0(variable_name, "_v"))
#     
#     
#     v_without_screening <- 1*extract_variable(rds_file = rds_files[2] , 
#                                            variable_name = variable_name) + 
#       1*extract_variable(rds_file =  rds_files[2], 
#                        variable_name = paste0(variable_name, "_v"))
#     
#     
#     nv_total_with_screening <- 1*extract_variable(rds_file = rds_files[3] , 
#                                  variable_name = variable_name) + 
#     1*extract_variable(rds_file =  rds_files[3], 
#                        variable_name = paste0(variable_name, "_v"))
#     
#     
#     v_with_screening <- 1*extract_variable(rds_file = rds_files[4] , 
#                                         variable_name = variable_name) + 
#       1*extract_variable(rds_file =  rds_files[4], 
#                        variable_name = paste0(variable_name, "_v"))
#  
#     
#     averted_with_screening <- get_averted_screening(nv_output = nv_total_with_screening,
#                                                          v_output = v_with_screening,
#                                                          t_begin = t_begin,
#                                                          t_end = t_end)
#     
#     averted_without_screening <- get_averted_screening(nv_output = nv_total_without_screening,
#                                                             v_output = v_without_screening,
#                                                             t_begin = t_begin,
#                                                             t_end = t_end)
#     
#     df_averted_with_screening <- as.data.frame(averted_with_screening )
#     
#     df_averted_without_screening <- as.data.frame(averted_without_screening)
#     
#     
#     # Determine y-axis settings for this figure
#     if (i == 1 ) {  # Example: The second figure requires different limits
#       y_limits <- custom_y_limits1
#       y_breaks <- custom_y_breaks1
#       
#     } else if (i == 2) {
#       y_limits <- custom_y_limits2
#       y_breaks <- custom_y_breaks2
#       
#     }else if (i == 3) {
#       y_limits <- custom_y_limits3
#       y_breaks <- custom_y_breaks3
#       
#     }else if (i == 4) {
#       y_limits <- custom_y_limits4
#       y_breaks <- custom_y_breaks4
#       
#     }
#     
#     
#     averted_plot_screening <- get_plot_averted_screening(
#       df_with_screening =  df_averted_with_screening ,
#       df_without_screening = df_averted_without_screening,
#       y_limits = y_limits,
#       y_breaks = y_breaks)
#     
#     
#     
#     plot_list[[i]] <-  averted_plot_screening 
#     
#   }
#   
#   ## remove legend in each of the figure
#   plot_list_wo_legend <- list()
#   
#   for (i in seq_along(plot_list)) {
#     plot_list_wo_legend[[i]] <- plot_list[[i]] + theme(legend.position = "none")
#   }  
#   
#   ## extrct the legend  
#   legend_plot <- get_legend( averted_plot_screening )  
#   
#   # Create the grid of plots without individual x and y labels
#   plot_wo_labels <- plot_grid(
#     plotlist = plot_list_wo_legend,
#     nrow = 2,
#     ncol = 2,
#     align = "hv",
#     axis = "tblr",
#     labels = c("(a)", "(b)", "(c)", "(d)"),  # Add subfigure labels
#     label_size = 40,                        # Adjust label size
#     label_x = 0.03,                         # Adjust horizontal position of labels
#     label_y = 1.08                          # Adjust vertical position of labels
#   )
#   
#   plot_with_labels <- ggdraw() +
#     draw_plot(plot_wo_labels, x = 0, y = 0, width = 1, height = 1) +   
#     draw_label(y_lab, x = 0.01, y = 0.55, angle = 90, size = 45, fontface = "bold") +  # Y-axis label
#     draw_label("Age at vaccination (year)", x = 0.5, y = 0.025, angle = 0, size = 45, fontface = "bold")           # X-axis label
#   
#   # make grid of plots  
#   final_plot_with_legend <- plot_grid(
#     legend_plot,
#     plot_with_labels,
#     nrow = 2, 
#     rel_heights = c(0.1,1)  
#   )
#   
#   return(final_plot_with_legend)
#   
# }  
# 
# 
# 
# ### Inputs
# 
# ## List all the datasets that we want to plot together
# set_of_rds_files <- list(
#   c("pri_sec_neq_detailed_a7_sero_dom_denv1_vcov_0.8_baseline_yes_nsamp_100_waning_0.rds",
#     "pri_sec_neq_detailed_a7_sero_dom_denv1_vcov_0.8_baseline_no_nsamp_100_waning_0.rds",
#     "pri_sec_neq_detailed_a7_sero_dom_denv1_vcov_0.8_baseline_yes_nsamp_100_waning_0_prescrng_1.rds",
#     "pri_sec_neq_detailed_a7_sero_dom_denv1_vcov_0.8_baseline_no_nsamp_100_waning_0_prescrng_1.rds"),  # Set 1
# 
#  c("pri_sec_neq_detailed_a7_sero_dom_denv2_vcov_0.8_baseline_yes_nsamp_100_waning_0.rds",
#     "pri_sec_neq_detailed_a7_sero_dom_denv2_vcov_0.8_baseline_no_nsamp_100_waning_0.rds",
#     "pri_sec_neq_detailed_a7_sero_dom_denv2_vcov_0.8_baseline_yes_nsamp_100_waning_0_prescrng_1.rds",
#     "pri_sec_neq_detailed_a7_sero_dom_denv2_vcov_0.8_baseline_no_nsamp_100_waning_0_prescrng_1.rds"), # Set 2
#  
#  c("pri_sec_neq_detailed_a7_sero_dom_denv3_vcov_0.8_baseline_yes_nsamp_100_waning_0.rds",
#     "pri_sec_neq_detailed_a7_sero_dom_denv3_vcov_0.8_baseline_no_nsamp_100_waning_0.rds",
#     "pri_sec_neq_detailed_a7_sero_dom_denv3_vcov_0.8_baseline_yes_nsamp_100_waning_0_prescrng_1.rds",
#     "pri_sec_neq_detailed_a7_sero_dom_denv3_vcov_0.8_baseline_no_nsamp_100_waning_0_prescrng_1.rds"), # Set 3
#  
#  c("pri_sec_neq_detailed_a7_sero_dom_denv4_vcov_0.8_baseline_yes_nsamp_100_waning_0.rds",
#     "pri_sec_neq_detailed_a7_sero_dom_denv4_vcov_0.8_baseline_no_nsamp_100_waning_0.rds",
#     "pri_sec_neq_detailed_a7_sero_dom_denv4_vcov_0.8_baseline_yes_nsamp_100_waning_0_prescrng_1.rds",
#     "pri_sec_neq_detailed_a7_sero_dom_denv4_vcov_0.8_baseline_no_nsamp_100_waning_0_prescrng_1.rds") # set 4
# )
# 
# 
# 
# ## grab the start of vaccination year from one of the dataset
# t_begin = readRDS(here::here("model_output",set_of_rds_files[[1]][1]) )$v_year 
# 
# 
# custom_y_limits1 <- c(0, 20)
# custom_y_breaks1 <- seq(0, 20, by = 5)
# 
# custom_y_limits2 <- c(0, 20)
# custom_y_breaks2 <- seq(0, 20, by = 5)
# 
# # Custom y-axis settings for a specific figure (for negative impact)(change it accordingly)
# custom_y_limits3 <- c(0, 20)
# custom_y_breaks3 <- seq(0, 20, by = 5)
# 
# custom_y_limits4 <- c(-1, 20)
# custom_y_breaks4 <- seq(0, 20, by = 5)
# 
# 
# ## Generate figure now
# plot_fig <- get_arranged_plot_averted_screening(set_of_rds_files = set_of_rds_files,
#                                                                     variable_name = "hosp_sample_age",
#                                                                     y_lab = "Hospitalizations averted (%)", 
#                                                                     t_begin = t_begin,
#                                                                     t_end = t_begin + 9)
# 
# figure_name <- "percent_hosp_averted_screening_population.jpg"
# 
# ### save
# ggsave(
#   filename = file.path(here("figure"), figure_name),  # Combine folder path and file name
#   plot = plot_fig,                                            # The plot object to save
#   width = 29*2,                                           # Width in inches
#   height = 40,                                          # Height in inches
#   dpi = 300,
#   units = "cm")                                  # DPI (resolution)
# 
# 
# 
# 
# 
# ```
# 
# 
# ### Individual (only among vaccinated) Impact of Prescreening on cases as percentage
# ```{r eval=FALSE}
# 
# get_agg_over_age <- function(arr) {
#   arr_agg_age <- apply(arr, c(1,2,4), sum)
#   return(arr_agg_age)
# }
# 
# ## cumulative number over year
# get_cumulative_over_time <- function(arr, t_begin, t_end) {
#   arr_cum_time <- apply(arr[, , t_begin:t_end], c(1, 2), sum)
#   return(arr_cum_time)
# }
# 
# 
# ## extract variable from .rds file
# extract_variable <- function(rds_file, variable_name) {
#   
#   result <- readRDS(here::here("model_output",  rds_file) )
#   
#   out_v <- as.data.frame(result$output, stringsAsFactors = FALSE)
#   
#   n_vac_age = result$n_vac_age
#   n_sample = result$n_sample
#   n_age = result$n_age
#   n_year = result$n_year
#   
#   x <- out_v[,colnames(out_v) == variable_name] 
#   
#   y <- array(NA, dim = c(n_vac_age,n_sample, n_age, n_year))
#   
#   for (i in 1:n_vac_age) {
#     
#     y[i,,,] <- x[[paste0("result.", i)]]
#   }
#   
#   return(y)
# }
# 
# 
# get_averted_screening <- function(nv_output, v_output,  t_begin, t_end){
#   
#   nv_agg_age <- get_agg_over_age(nv_output)
#   v_agg_age <-  get_agg_over_age(v_output)
#   
#   nv_cum_t <- get_cumulative_over_time( nv_agg_age, t_begin = t_begin, t_end = t_end)
#   v_cum_t <- get_cumulative_over_time( v_agg_age, t_begin = t_begin, t_end = t_end)
#   
#   averted_screening <- 100*(nv_cum_t - v_cum_t)/nv_cum_t   
#   
#   return( averted_screening)
# }
# 
# 
# get_plot_averted_screening <- function(df_with_screening, df_without_screening, y_limits, y_breaks) 
#   
#   {
#   
#   
#   # Add a column for age groups
#   df_with_screening$age <- 1:nrow(df_with_screening)
#   df_without_screening$age <- 1:nrow(df_without_screening)
#   
#   
#   # Reshape the dataframes to long format
#   df_with_screening_long <- gather(df_with_screening, key = "Realization", value = "Output", -age)
#   df_without_screening_long <- gather(df_without_screening, key = "Realization", value = "Output", -age)
#   
#   
#   # Add a column to indicate the vaccine coverage for each dataset
#   df_with_screening_long$screening_type <- "With pre-screening"
#   df_without_screening_long$screening_type <- "Without pre-screening"
#   
#   # Combine all datasets into one long dataframe
#   df_long <- bind_rows(df_with_screening_long, df_without_screening_long)
#   
#   # Calculate the mean and 95% confidence interval for each age group and vaccine coverage
#   summary_df <- df_long %>%
#     group_by(age, screening_type) %>%
#     summarise(
#       mean_output = mean(Output),
#       lower_bound = quantile(Output, 0.025),
#       upper_bound = quantile(Output, 0.975)
#     ) %>%
#     ungroup()
#   
#   # Define colors for different vaccine coverages
#   screening_type_barcolors <- c("With pre-screening" = "#d8b365", "Without pre-screening" = "#5ab4ac")
#   screening_type_errorbar_colors <- c("With pre-screening" = "#8c510a", "Without pre-screening" = "#01665e")
#   # Define the dodge position for side-by-side plotting
#   dodge <- position_dodge(width = 0.5)
#   
#   # Plot using ggplot2
#   p <- ggplot(summary_df, aes(x = factor(age), y = mean_output, fill = screening_type)) +
#     # geom_point(size = 9, position = dodge, shape = 16) +  # Points for the mean with dodge
#     geom_bar(stat = "identity", position = position_dodge(width = 0.75), width = 0.65) +
#     
#     geom_errorbar(aes(ymin = lower_bound, ymax = upper_bound, color = screening_type), 
#                   width = 0.0, size = 1.8, position = position_dodge(width = 0.75)) +
#     
#     scale_fill_manual(values = screening_type_barcolors, name = "") + # Custom colors for bars
#     scale_color_manual(values = screening_type_errorbar_colors,  name = "") + # Custom colors for error bars
#     # scale_color_manual(values = poptype_colors, name = "") + 
#     scale_x_discrete(
#       breaks = c(1, 2, 3, 4, 5, 6, 7),   # Set the positions of the x-axis ticks
#       labels = c("6-16", "17-30", "31-40", "41-50", "51-60", "61-70", "71-80")  # Labels for age groups
#     ) +
#     # labs(x = "Age at vaccination", y = ylab, color = NULL) +  # Labels for x and y axes
#     scale_y_continuous(limits = y_limits, breaks = y_breaks) +  # Define y-axis tick points )+
#     theme_bw() +  # Clean theme
#     theme(
#       axis.ticks.length = unit(0.4, "cm"),        # Increase the length of the ticks
#       axis.ticks = element_line(size = 1.5),      # Increase the thickness of the ticks
#       panel.border = element_rect(color = "black", size = 2),  # Thicker border
#       plot.margin = margin(t=10, r=10, b=20, l=25),
#       axis.text.x = element_text(size = 35, color="black", angle= 30, margin = margin(t = 10, b = 20)),
#       axis.text.y = element_text(size = 35,color="black", margin = margin(r = 10, l = 30)),
#       # axis.title = element_text(size = 35, color = "black"),
#       axis.title = element_blank(),
#       legend.position = "top",
#       legend.direction = "horizontal",
#       legend.text = element_text(size = 40),
#       legend.key.size = unit(2, "cm"),  # Increase size of legend keys
#       legend.key.height = unit(1.5, "cm"),  # Increase height of legend keys
#       legend.key.width = unit(2.5, "cm"),  # Increase width of legend keys
#       legend.background = element_blank()
#     )
#   
#   
#   
# }
# 
# 
# 
# get_arranged_plot_averted_screening <- function(set_of_rds_files, variable_name, y_lab, t_begin, t_end) {
#   
#   plot_list <- list()
#   
#   for (i in seq_along(set_of_rds_files)) {
#     
#     rds_files <- set_of_rds_files[[i]]
#     
#     ## for total population
#     nv_total_without_screening <- 0*extract_variable(rds_file = rds_files[1] , 
#                                  variable_name = variable_name) + 
#       1*extract_variable(rds_file =  rds_files[1], 
#                        variable_name = paste0(variable_name, "_v"))
#     
#     
#     v_without_screening <- 0*extract_variable(rds_file = rds_files[2] , 
#                                            variable_name = variable_name) + 
#       1*extract_variable(rds_file =  rds_files[2], 
#                        variable_name = paste0(variable_name, "_v"))
#     
#     
#     nv_total_with_screening <- 0*extract_variable(rds_file = rds_files[3] , 
#                                  variable_name = variable_name) + 
#     1*extract_variable(rds_file =  rds_files[3], 
#                        variable_name = paste0(variable_name, "_v"))
#     
#     
#     v_with_screening <- 0*extract_variable(rds_file = rds_files[4] , 
#                                         variable_name = variable_name) + 
#       1*extract_variable(rds_file =  rds_files[4], 
#                        variable_name = paste0(variable_name, "_v"))
#     
#  
#     averted_without_screening <- get_averted_screening(nv_output = nv_total_without_screening,
#                                                             v_output = v_without_screening,
#                                                             t_begin = t_begin,
#                                                             t_end = t_end)
#     
#     averted_with_screening <- get_averted_screening(nv_output = nv_total_with_screening,
#                                                          v_output = v_with_screening,
#                                                          t_begin = t_begin,
#                                                          t_end = t_end)
#     
#  
#     df_averted_without_screening <- as.data.frame(averted_without_screening)
#     df_averted_with_screening <- as.data.frame(averted_with_screening )
#     
#     # Determine y-axis settings for this figure
#     if (i == 1 ) {  # Example: The second figure requires different limits
#       y_limits <- custom_y_limits1
#       y_breaks <- custom_y_breaks1
#       
#     } else if (i == 2) {
#       y_limits <- custom_y_limits2
#       y_breaks <- custom_y_breaks2
#       
#     }else if (i == 3) {
#       y_limits <- custom_y_limits3
#       y_breaks <- custom_y_breaks3
#       
#     }else if (i == 4) {
#       y_limits <- custom_y_limits4
#       y_breaks <- custom_y_breaks4
#       
#     }
#     
#     
#     averted_plot_screening <- get_plot_averted_screening(
#       df_with_screening =  df_averted_with_screening ,
#       df_without_screening = df_averted_without_screening,
#       y_limits = y_limits,
#       y_breaks = y_breaks)
#     
#     
#     
#     plot_list[[i]] <-  averted_plot_screening 
#     
#   }
#   
#   ## remove legend in each of the figure
#   plot_list_wo_legend <- list()
#   
#   for (i in seq_along(plot_list)) {
#     plot_list_wo_legend[[i]] <- plot_list[[i]] + theme(legend.position = "none")
#   }  
#   
#   ## extrct the legend  
#   legend_plot <- get_legend( averted_plot_screening )  
#   
#   # Create the grid of plots without individual x and y labels
#   plot_wo_labels <- plot_grid(
#     plotlist = plot_list_wo_legend,
#     nrow = 2,
#     ncol = 2,
#     align = "hv",
#     axis = "tblr",
#     labels = c("(a)", "(b)", "(c)", "(d)"),  # Add subfigure labels
#     label_size = 40,                        # Adjust label size
#     label_x = 0.03,                         # Adjust horizontal position of labels
#     label_y = 1.08                          # Adjust vertical position of labels
#   )
#   
#   plot_with_labels <- ggdraw() +
#     draw_plot(plot_wo_labels, x = 0, y = 0, width = 1, height = 1) +   
#     draw_label(y_lab, x = 0.01, y = 0.55, angle = 90, size = 45, fontface = "bold") +  # Y-axis label
#     draw_label("Age at vaccination (year)", x = 0.5, y = 0.025, angle = 0, size = 45, fontface = "bold")           # X-axis label
#   
#   # make grid of plots  
#   final_plot_with_legend <- plot_grid(
#     legend_plot,
#     plot_with_labels,
#     nrow = 2, 
#     rel_heights = c(0.1,1)  
#   )
#   
#   return(final_plot_with_legend)
#   
# }  
# 
# 
# 
# ### Inputs
# 
# ## List all the datasets that we want to plot together
# set_of_rds_files <- list(
#   c("pri_sec_neq_detailed_a7_sero_dom_denv1_vcov_0.8_baseline_yes_nsamp_100_waning_0.rds",
#     "pri_sec_neq_detailed_a7_sero_dom_denv1_vcov_0.8_baseline_no_nsamp_100_waning_0.rds",
#     "pri_sec_neq_detailed_a7_sero_dom_denv1_vcov_0.8_baseline_yes_nsamp_100_waning_0_prescrng_1.rds",
#     "pri_sec_neq_detailed_a7_sero_dom_denv1_vcov_0.8_baseline_no_nsamp_100_waning_0_prescrng_1.rds"),  # Set 1
# 
#  c("pri_sec_neq_detailed_a7_sero_dom_denv2_vcov_0.8_baseline_yes_nsamp_100_waning_0.rds",
#     "pri_sec_neq_detailed_a7_sero_dom_denv2_vcov_0.8_baseline_no_nsamp_100_waning_0.rds",
#     "pri_sec_neq_detailed_a7_sero_dom_denv2_vcov_0.8_baseline_yes_nsamp_100_waning_0_prescrng_1.rds",
#     "pri_sec_neq_detailed_a7_sero_dom_denv2_vcov_0.8_baseline_no_nsamp_100_waning_0_prescrng_1.rds"), # Set 2
#  
#  c("pri_sec_neq_detailed_a7_sero_dom_denv3_vcov_0.8_baseline_yes_nsamp_100_waning_0.rds",
#     "pri_sec_neq_detailed_a7_sero_dom_denv3_vcov_0.8_baseline_no_nsamp_100_waning_0.rds",
#     "pri_sec_neq_detailed_a7_sero_dom_denv3_vcov_0.8_baseline_yes_nsamp_100_waning_0_prescrng_1.rds",
#     "pri_sec_neq_detailed_a7_sero_dom_denv3_vcov_0.8_baseline_no_nsamp_100_waning_0_prescrng_1.rds"), # Set 3
#  
#  c("pri_sec_neq_detailed_a7_sero_dom_denv4_vcov_0.8_baseline_yes_nsamp_100_waning_0.rds",
#     "pri_sec_neq_detailed_a7_sero_dom_denv4_vcov_0.8_baseline_no_nsamp_100_waning_0.rds",
#     "pri_sec_neq_detailed_a7_sero_dom_denv4_vcov_0.8_baseline_yes_nsamp_100_waning_0_prescrng_1.rds",
#     "pri_sec_neq_detailed_a7_sero_dom_denv4_vcov_0.8_baseline_no_nsamp_100_waning_0_prescrng_1.rds") # set 4
# )
# 
# 
# ## grab the start of vaccination year from one of the dataset
# t_begin = readRDS(here::here("model_output",set_of_rds_files[[1]][1]) )$v_year 
# 
# # 
# custom_y_limits1 <- c(0, 75)
# custom_y_breaks1 <- seq(0, 75, by = 15)
# 
# custom_y_limits2 <- c(0, 75)
# custom_y_breaks2 <- seq(0, 75, by = 15)
# 
# # Custom y-axis settings for a specific figure (for negative impact)(change it accordingly)
# custom_y_limits3 <- c(0,75)
# custom_y_breaks3 <- seq(0, 75, by = 15)
# 
# custom_y_limits4 <- c(-125, 75)
# custom_y_breaks4 <- seq(-125, 75, by = 25)
# 
# 
# 
# 
# ## Generate figure now
# plot_fig <- get_arranged_plot_averted_screening(set_of_rds_files = set_of_rds_files,
#                                                                     variable_name = "symp_sample_age",
#                                                                     y_lab = "Reported cases averted among vaccinated (%)", 
#                                                                     t_begin = t_begin,
#                                                                     t_end = t_begin + 9)
# 
# figure_name <- "percent_symp_averted_screening_individual.jpg"
# 
# ### save
# ggsave(
#   filename = file.path(here("figure"), figure_name),  # Combine folder path and file name
#   plot = plot_fig,                                            # The plot object to save
#   width = 29*2,                                           # Width in inches
#   height = 40,                                          # Height in inches
#   dpi = 300,
#   units = "cm")                                  # DPI (resolution)
```



### Individual Impact of Prescreening on hospitalizations

```{r eval=FALSE}

# get_agg_over_age <- function(arr) {
#   arr_agg_age <- apply(arr, c(1,2,4), sum)
#   return(arr_agg_age)
# }
# 
# ## cumulative number over year
# get_cumulative_over_time <- function(arr, t_begin, t_end) {
#   arr_cum_time <- apply(arr[, , t_begin:t_end], c(1, 2), sum)
#   return(arr_cum_time)
# }
# 
# 
# ## extract variable from .rds file
# extract_variable <- function(rds_file, variable_name) {
#   
#   result <- readRDS(here::here("model_output",  rds_file) )
#   
#   out_v <- as.data.frame(result$output, stringsAsFactors = FALSE)
#   
#   n_vac_age = result$n_vac_age
#   n_sample = result$n_sample
#   n_age = result$n_age
#   n_year = result$n_year
#   
#   x <- out_v[,colnames(out_v) == variable_name] 
#   
#   y <- array(NA, dim = c(n_vac_age,n_sample, n_age, n_year))
#   
#   for (i in 1:n_vac_age) {
#     
#     y[i,,,] <- x[[paste0("result.", i)]]
#   }
#   
#   return(y)
# }
# 
# 
# get_averted_screening <- function(nv_output, v_output,  t_begin, t_end){
#   
#   nv_agg_age <- get_agg_over_age(nv_output)
#   v_agg_age <-  get_agg_over_age(v_output)
#   
#   nv_cum_t <- get_cumulative_over_time( nv_agg_age, t_begin = t_begin, t_end = t_end)
#   v_cum_t <- get_cumulative_over_time( v_agg_age, t_begin = t_begin, t_end = t_end)
#   
#   averted_screening <- 100*(nv_cum_t - v_cum_t)/nv_cum_t 
#   
#   return( averted_screening)
# }
# 
# 
# get_plot_averted_screening <- function(df_with_screening, df_without_screening, y_limits, y_breaks) 
#   
#   {
#   
#   
#   # Add a column for age groups
#   df_with_screening$age <- 1:nrow(df_with_screening)
#   df_without_screening$age <- 1:nrow(df_without_screening)
#   
#   
#   # Reshape the dataframes to long format
#   df_with_screening_long <- gather(df_with_screening, key = "Realization", value = "Output", -age)
#   df_without_screening_long <- gather(df_without_screening, key = "Realization", value = "Output", -age)
#   
#   
#   # Add a column to indicate the vaccine coverage for each dataset
#   df_with_screening_long$screening_type <- "With pre-screening"
#   df_without_screening_long$screening_type <- "Without pre-screening"
#   
#   # Combine all datasets into one long dataframe
#   df_long <- bind_rows(df_with_screening_long, df_without_screening_long)
#   
#   # Calculate the mean and 95% confidence interval for each age group and vaccine coverage
#   summary_df <- df_long %>%
#     group_by(age, screening_type) %>%
#     summarise(
#       mean_output = mean(Output),
#       lower_bound = quantile(Output, 0.025),
#       upper_bound = quantile(Output, 0.975)
#     ) %>%
#     ungroup()
#   
#   # Define colors for different vaccine coverages
#   screening_type_barcolors <- c("With pre-screening" = "#d8b365", "Without pre-screening" = "#5ab4ac")
#   screening_type_errorbar_colors <- c("With pre-screening" = "#8c510a", "Without pre-screening" = "#01665e")
#   # Define the dodge position for side-by-side plotting
#   dodge <- position_dodge(width = 0.5)
#   
#   # Plot using ggplot2
#   p <- ggplot(summary_df, aes(x = factor(age), y = mean_output, fill = screening_type)) +
#     # geom_point(size = 9, position = dodge, shape = 16) +  # Points for the mean with dodge
#     geom_bar(stat = "identity", position = position_dodge(width = 0.75), width = 0.65) +
#     
#     geom_errorbar(aes(ymin = lower_bound, ymax = upper_bound, color = screening_type), 
#                   width = 0.0, size = 1.8, position = position_dodge(width = 0.75)) +
#     # geom_errorbar(aes(ymin = lower_bound, ymax = upper_bound), 
#     #               width = 0.0, size = 1.8, position = dodge) +  # Error bars with dodge
#     scale_fill_manual(values = screening_type_barcolors, name = "") + # Custom colors for bars
#     scale_color_manual(values = screening_type_errorbar_colors,  name = "") + # Custom colors for error bars
#     # scale_color_manual(values = poptype_colors, name = "") + 
#     scale_x_discrete(
#       breaks = c(1, 2, 3, 4, 5, 6, 7),   # Set the positions of the x-axis ticks
#       labels = c("6-16", "17-30", "31-40", "41-50", "51-60", "61-70", "71-80")  # Labels for age groups
#     ) +
#     
#     scale_y_continuous(limits = y_limits, breaks = y_breaks) +  # Define y-axis tick points )+
#     theme_bw() +  # Clean theme
#     theme(
#       axis.ticks.length = unit(0.4, "cm"),        # Increase the length of the ticks
#       axis.ticks = element_line(size = 1.5),      # Increase the thickness of the ticks
#       panel.border = element_rect(color = "black", size = 2),  # Thicker border
#       plot.margin = margin(t=10, r=10, b=20, l=25),
#       axis.text.x = element_text(size = 35, color="black", angle= 30, margin = margin(t = 10, b = 20)),
#       axis.text.y = element_text(size = 35,color="black", margin = margin(r = 10, l = 30)),
#       # axis.title = element_text(size = 35, color = "black"),
#       axis.title = element_blank(),
#       legend.position = "top",
#       legend.direction = "horizontal",
#       legend.text = element_text(size = 40),
#       legend.key.size = unit(2, "cm"),  # Increase size of legend keys
#       legend.key.height = unit(1.5, "cm"),  # Increase height of legend keys
#       legend.key.width = unit(2.5, "cm"),  # Increase width of legend keys
#       legend.background = element_blank()
#     )
#   
#   
#   
# }
# 
# 
# 
# get_arranged_plot_averted_screening <- function(set_of_rds_files, variable_name, y_lab, t_begin, t_end) {
#   
#   plot_list <- list()
#   
#   for (i in seq_along(set_of_rds_files)) {
#     
#     rds_files <- set_of_rds_files[[i]]
#     
#     ## for total population
#     nv_total_without_screening <- 0*extract_variable(rds_file = rds_files[1] , 
#                                  variable_name = variable_name) + 
#       1*extract_variable(rds_file =  rds_files[1], 
#                        variable_name = paste0(variable_name, "_v"))
#     
#     
#     v_without_screening <- 0*extract_variable(rds_file = rds_files[2] , 
#                                            variable_name = variable_name) + 
#       1*extract_variable(rds_file =  rds_files[2], 
#                        variable_name = paste0(variable_name, "_v"))
#     
#     
#     nv_total_with_screening <- 0*extract_variable(rds_file = rds_files[3] , 
#                                  variable_name = variable_name) + 
#     1*extract_variable(rds_file =  rds_files[3], 
#                        variable_name = paste0(variable_name, "_v"))
#     
#     
#     v_with_screening <- 0*extract_variable(rds_file = rds_files[4] , 
#                                         variable_name = variable_name) + 
#       1*extract_variable(rds_file =  rds_files[4], 
#                        variable_name = paste0(variable_name, "_v"))
#  
#     
#     averted_with_screening <- get_averted_screening(nv_output = nv_total_with_screening,
#                                                          v_output = v_with_screening,
#                                                          t_begin = t_begin,
#                                                          t_end = t_end)
#     
#     averted_without_screening <- get_averted_screening(nv_output = nv_total_without_screening,
#                                                             v_output = v_without_screening,
#                                                             t_begin = t_begin,
#                                                             t_end = t_end)
#     
#     df_averted_with_screening <- as.data.frame(averted_with_screening )
#     
#     df_averted_without_screening <- as.data.frame(averted_without_screening)
#     
#     
#     # Determine y-axis settings for this figure
#     if (i == 1 ) {  # Example: The second figure requires different limits
#       y_limits <- custom_y_limits1
#       y_breaks <- custom_y_breaks1
#       
#     } else if (i == 2) {
#       y_limits <- custom_y_limits2
#       y_breaks <- custom_y_breaks2
#       
#     }else if (i == 3) {
#       y_limits <- custom_y_limits3
#       y_breaks <- custom_y_breaks3
#       
#     }else if (i == 4) {
#       y_limits <- custom_y_limits4
#       y_breaks <- custom_y_breaks4
#       
#     }
#     
#     
#     averted_plot_screening <- get_plot_averted_screening(
#       df_with_screening =  df_averted_with_screening ,
#       df_without_screening = df_averted_without_screening,
#       y_limits = y_limits,
#       y_breaks = y_breaks)
#     
#     
#     
#     plot_list[[i]] <-  averted_plot_screening 
#     
#   }
#   
#   ## remove legend in each of the figure
#   plot_list_wo_legend <- list()
#   
#   for (i in seq_along(plot_list)) {
#     plot_list_wo_legend[[i]] <- plot_list[[i]] + theme(legend.position = "none")
#   }  
#   
#   ## extrct the legend  
#   legend_plot <- get_legend( averted_plot_screening )  
#   
#   # Create the grid of plots without individual x and y labels
#   plot_wo_labels <- plot_grid(
#     plotlist = plot_list_wo_legend,
#     nrow = 2,
#     ncol = 2,
#     align = "hv",
#     axis = "tblr",
#     labels = c("(a)", "(b)", "(c)", "(d)"),  # Add subfigure labels
#     label_size = 40,                        # Adjust label size
#     label_x = 0.03,                         # Adjust horizontal position of labels
#     label_y = 1.08                          # Adjust vertical position of labels
#   )
#   
#   plot_with_labels <- ggdraw() +
#     draw_plot(plot_wo_labels, x = 0, y = 0, width = 1, height = 1) +   
#     draw_label(y_lab, x = 0.01, y = 0.55, angle = 90, size = 45, fontface = "bold") +  # Y-axis label
#     draw_label("Age at vaccination (year)", x = 0.5, y = 0.025, angle = 0, size = 45, fontface = "bold")           # X-axis label
#   
#   # make grid of plots  
#   final_plot_with_legend <- plot_grid(
#     legend_plot,
#     plot_with_labels,
#     nrow = 2, 
#     rel_heights = c(0.1,1)  
#   )
#   
#   return(final_plot_with_legend)
#   
# }  
# 
# 
# 
# ### Inputs
# 
# ## List all the datasets that we want to plot together
# set_of_rds_files <- list(
#   c("pri_sec_neq_detailed_a7_sero_dom_denv1_vcov_0.8_baseline_yes_nsamp_100_waning_0.rds",
#     "pri_sec_neq_detailed_a7_sero_dom_denv1_vcov_0.8_baseline_no_nsamp_100_waning_0.rds",
#     "pri_sec_neq_detailed_a7_sero_dom_denv1_vcov_0.8_baseline_yes_nsamp_100_waning_0_prescrng_1.rds",
#     "pri_sec_neq_detailed_a7_sero_dom_denv1_vcov_0.8_baseline_no_nsamp_100_waning_0_prescrng_1.rds"),  # Set 1
# 
#  c("pri_sec_neq_detailed_a7_sero_dom_denv2_vcov_0.8_baseline_yes_nsamp_100_waning_0.rds",
#     "pri_sec_neq_detailed_a7_sero_dom_denv2_vcov_0.8_baseline_no_nsamp_100_waning_0.rds",
#     "pri_sec_neq_detailed_a7_sero_dom_denv2_vcov_0.8_baseline_yes_nsamp_100_waning_0_prescrng_1.rds",
#     "pri_sec_neq_detailed_a7_sero_dom_denv2_vcov_0.8_baseline_no_nsamp_100_waning_0_prescrng_1.rds"), # Set 2
#  
#  c("pri_sec_neq_detailed_a7_sero_dom_denv3_vcov_0.8_baseline_yes_nsamp_100_waning_0.rds",
#     "pri_sec_neq_detailed_a7_sero_dom_denv3_vcov_0.8_baseline_no_nsamp_100_waning_0.rds",
#     "pri_sec_neq_detailed_a7_sero_dom_denv3_vcov_0.8_baseline_yes_nsamp_100_waning_0_prescrng_1.rds",
#     "pri_sec_neq_detailed_a7_sero_dom_denv3_vcov_0.8_baseline_no_nsamp_100_waning_0_prescrng_1.rds"), # Set 3
#  
#  c("pri_sec_neq_detailed_a7_sero_dom_denv4_vcov_0.8_baseline_yes_nsamp_100_waning_0.rds",
#     "pri_sec_neq_detailed_a7_sero_dom_denv4_vcov_0.8_baseline_no_nsamp_100_waning_0.rds",
#     "pri_sec_neq_detailed_a7_sero_dom_denv4_vcov_0.8_baseline_yes_nsamp_100_waning_0_prescrng_1.rds",
#     "pri_sec_neq_detailed_a7_sero_dom_denv4_vcov_0.8_baseline_no_nsamp_100_waning_0_prescrng_1.rds") # set 4
# )
# 
# 
# 
# ## grab the start of vaccination year from one of the dataset
# t_begin = readRDS(here::here("model_output",set_of_rds_files[[1]][1]) )$v_year 
# 
# 
# custom_y_limits1 <- c(0, 90)
# custom_y_breaks1 <- seq(0, 90, by = 15)
# 
# custom_y_limits2 <- c(0, 90)
# custom_y_breaks2 <- seq(0, 90, by = 15)
# 
# # Custom y-axis settings for a specific figure (for negative impact)(change it accordingly)
# custom_y_limits3 <- c(0, 90)
# custom_y_breaks3 <- seq(0, 90, by = 15)
# 
# custom_y_limits4 <- c(-2, 90)
# custom_y_breaks4 <- seq(0, 90, by = 15)
# 
# 
# ## Generate figure now
# plot_fig <- get_arranged_plot_averted_screening(set_of_rds_files = set_of_rds_files,
#                                                                     variable_name = "hosp_sample_age",
#                                                                     y_lab = "Hospitalizations averted among vaccinated (%)", 
#                                                                     t_begin = t_begin,
#                                                                     t_end = t_begin + 9)
# 
# figure_name <- "percent_hosp_averted_screening_individual.jpg"
# 
# ### save
# ggsave(
#   filename = file.path(here("figure"), figure_name),  # Combine folder path and file name
#   plot = plot_fig,                                            # The plot object to save
#   width = 29*2,                                           # Width in inches
#   height = 40,                                          # Height in inches
#   dpi = 300,
#   units = "cm")                                  # DPI (resolution)
# 
# 
# 


```


### Plotting population and individual impact  of screening together (for cases)

```{r}
get_agg_over_age <- function(arr) {
  arr_agg_age <- apply(arr, c(1,2,4), sum)
  return(arr_agg_age)
}

## cumulative number over year
get_cumulative_over_time <- function(arr, t_begin, t_end) {
  arr_cum_time <- apply(arr[, , t_begin:t_end], c(1, 2), sum)
  return(arr_cum_time)
}


## extract variable from .rds file
extract_variable <- function(rds_file, variable_name) {
  
  result <- readRDS(here::here("model_output",  rds_file) )
  
  out_v <- as.data.frame(result$output, stringsAsFactors = FALSE)
  
  n_vac_age = result$n_vac_age
  n_sample = result$n_sample
  n_age = result$n_age
  n_year = result$n_year
  
  x <- out_v[,colnames(out_v) == variable_name] 
  
  y <- array(NA, dim = c(n_vac_age,n_sample, n_age, n_year))
  
  for (i in 1:n_vac_age) {
    
    y[i,,,] <- x[[paste0("result.", i)]]
  }
  
  return(y)
}


get_averted_screening <- function(nv_output, v_output,  t_begin, t_end){
  
  nv_agg_age <- get_agg_over_age(nv_output)
  v_agg_age <-  get_agg_over_age(v_output)
  
  nv_cum_t <- get_cumulative_over_time( nv_agg_age, t_begin = t_begin, t_end = t_end)
  v_cum_t <- get_cumulative_over_time( v_agg_age, t_begin = t_begin, t_end = t_end)
  
  averted_screening <- 100*(nv_cum_t - v_cum_t)/nv_cum_t   
  
  return( averted_screening)
}


get_plot_averted_screening <- function(df_with_screening, df_without_screening, y_limits, y_breaks) 
  
  {
  
  
  # Add a column for age groups
  df_with_screening$age <- 1:nrow(df_with_screening)
  df_without_screening$age <- 1:nrow(df_without_screening)
  
  
  # Reshape the dataframes to long format
  df_with_screening_long <- gather(df_with_screening, key = "Realization", value = "Output", -age)
  df_without_screening_long <- gather(df_without_screening, key = "Realization", value = "Output", -age)
  
  
  # Add a column to indicate the vaccine coverage for each dataset
  df_with_screening_long$screening_type <- "With pre-screening"
  df_without_screening_long$screening_type <- "Without pre-screening"
  
  # Combine all datasets into one long dataframe
  df_long <- bind_rows(df_with_screening_long, df_without_screening_long)
  
  # Calculate the mean and 95% confidence interval for each age group and vaccine coverage
  summary_df <- df_long %>%
    group_by(age, screening_type) %>%
    summarise(
      mean_output = mean(Output),
      lower_bound = quantile(Output, 0.025),
      upper_bound = quantile(Output, 0.975)
    ) %>%
    ungroup()
  
  # Define colors for different vaccine coverages
  screening_type_barcolors <- c("With pre-screening" = "#d8b365", "Without pre-screening" = "#5ab4ac")
  screening_type_errorbar_colors <- c("With pre-screening" = "#8c510a", "Without pre-screening" = "#01665e")
  # Define the dodge position for side-by-side plotting
  dodge <- position_dodge(width = 0.5)
  
  # Plot using ggplot2
  p <- ggplot(summary_df, aes(x = factor(age), y = mean_output, fill = screening_type)) +
    # geom_point(size = 9, position = dodge, shape = 16) +  # Points for the mean with dodge
    geom_bar(stat = "identity", position = position_dodge(width = 0.75), width = 0.65) +
    
    geom_errorbar(aes(ymin = lower_bound, ymax = upper_bound, color = screening_type), 
                  width = 0.0, size = 1.8, position = position_dodge(width = 0.75)) +
    
    scale_fill_manual(values = screening_type_barcolors, name = "") + # Custom colors for bars
    scale_color_manual(values = screening_type_errorbar_colors,  name = "") + # Custom colors for error bars
    # scale_color_manual(values = poptype_colors, name = "") + 
    scale_x_discrete(
      breaks = c(1, 2, 3, 4, 5, 6, 7),   # Set the positions of the x-axis ticks
      labels = c("6-16", "17-30", "31-40", "41-50", "51-60", "61-70", "71-80")  # Labels for age groups
    ) +
    # labs(x = "Age at vaccination", y = ylab, color = NULL) +  # Labels for x and y axes
    scale_y_continuous(limits = y_limits, breaks = y_breaks) +  # Define y-axis tick points )+
    theme_bw() +  # Clean theme
    theme(
      axis.ticks.length = unit(0.4, "cm"),        # Increase the length of the ticks
      axis.ticks = element_line(size = 1.5),      # Increase the thickness of the ticks
      panel.border = element_rect(color = "black", size = 2),  # Thicker border
      plot.margin = margin(t=10, r=10, b=20, l=25),
      axis.text.x = element_text(size = 35, color="black", angle= 30, margin = margin(t = 10, b = 20)),
      axis.text.y = element_text(size = 35,color="black", margin = margin(r = 10, l = 30)),
      # axis.title = element_text(size = 35, color = "black"),
      axis.title = element_blank(),
      legend.position = "top",
      legend.direction = "horizontal",
      legend.text = element_text(size = 40),
      legend.key.size = unit(2, "cm"),  # Increase size of legend keys
      legend.key.height = unit(1.5, "cm"),  # Increase height of legend keys
      legend.key.width = unit(2.5, "cm"),  # Increase width of legend keys
      legend.background = element_blank()
    )
  
  
  
}



get_arranged_plot_averted_screening <- function(set_of_rds_files, variable_name, y_lab, t_begin, t_end) {
  
  plot_list_population <- list()
  plot_list_individual <- list()
  
  for (i in seq_along(set_of_rds_files)) {
    
    rds_files <- set_of_rds_files[[i]]
    
    
    ## FOR population level
    
    ## for total population
    nv_total_without_screening_population <- 1*extract_variable(rds_file = rds_files[1] , 
                                 variable_name = variable_name) + 
      1*extract_variable(rds_file =  rds_files[1], 
                       variable_name = paste0(variable_name, "_v"))
    
    
    v_without_screening_population <- 1*extract_variable(rds_file = rds_files[2] , 
                                           variable_name = variable_name) + 
      1*extract_variable(rds_file =  rds_files[2], 
                       variable_name = paste0(variable_name, "_v"))
    
    
    nv_total_with_screening_population <- 1*extract_variable(rds_file = rds_files[3] , 
                                 variable_name = variable_name) + 
    1*extract_variable(rds_file =  rds_files[3], 
                       variable_name = paste0(variable_name, "_v"))
    
    
    v_with_screening_population <- 1*extract_variable(rds_file = rds_files[4] , 
                                        variable_name = variable_name) + 
      1*extract_variable(rds_file =  rds_files[4], 
                       variable_name = paste0(variable_name, "_v"))
    
 
    averted_without_screening_population <- get_averted_screening(nv_output = nv_total_without_screening_population,
                                                            v_output = v_without_screening_population,
                                                            t_begin = t_begin,
                                                            t_end = t_end)
    
    averted_with_screening_population <- get_averted_screening(nv_output = nv_total_with_screening_population,
                                                         v_output = v_with_screening_population,
                                                         t_begin = t_begin,
                                                         t_end = t_end)
    
 
    df_averted_without_screening_population <- as.data.frame(averted_without_screening_population)
    df_averted_with_screening_population <- as.data.frame(averted_with_screening_population )
    
    # Determine y-axis settings for this figure
    if (i == 1 ) {  # Example: The second figure requires different limits
      y_limits <- custom_y_limits1_pop
      y_breaks <- custom_y_breaks1_pop
      
    } else if (i == 2) {
      y_limits <- custom_y_limits2_pop
      y_breaks <- custom_y_breaks2_pop
      
    }else if (i == 3) {
      y_limits <- custom_y_limits3_pop
      y_breaks <- custom_y_breaks3_pop
      
    }else if (i == 4) {
      y_limits <- custom_y_limits4_pop
      y_breaks <- custom_y_breaks4_pop
      
    }
    
    
    averted_plot_screening_population <- get_plot_averted_screening(
      df_with_screening =  df_averted_with_screening_population ,
      df_without_screening = df_averted_without_screening_population,
      y_limits = y_limits,
      y_breaks = y_breaks)
    
    
    
    plot_list_population[[i]] <-  averted_plot_screening_population
    
  }
  
  
  ### now for individual level
  
   for (i in seq_along(set_of_rds_files)) {
    
    rds_files <- set_of_rds_files[[i]]
    
    ## for total population
    nv_total_without_screening_individual <- 0*extract_variable(rds_file = rds_files[1] , 
                                 variable_name = variable_name) + 
      1*extract_variable(rds_file =  rds_files[1], 
                       variable_name = paste0(variable_name, "_v"))
    
    
    v_without_screening_individual <- 0*extract_variable(rds_file = rds_files[2] , 
                                           variable_name = variable_name) + 
      1*extract_variable(rds_file =  rds_files[2], 
                       variable_name = paste0(variable_name, "_v"))
    
    
    nv_total_with_screening_individual <- 0*extract_variable(rds_file = rds_files[3] , 
                                 variable_name = variable_name) + 
    1*extract_variable(rds_file =  rds_files[3], 
                       variable_name = paste0(variable_name, "_v"))
    
    
    v_with_screening_individual <- 0*extract_variable(rds_file = rds_files[4] , 
                                        variable_name = variable_name) + 
      1*extract_variable(rds_file =  rds_files[4], 
                       variable_name = paste0(variable_name, "_v"))
    
 
    averted_without_screening_individual <- get_averted_screening(nv_output = nv_total_without_screening_individual,
                                                            v_output = v_without_screening_individual,
                                                            t_begin = t_begin,
                                                            t_end = t_end)
    
    averted_with_screening_individual <- get_averted_screening(nv_output = nv_total_with_screening_individual,
                                                         v_output = v_with_screening_individual,
                                                         t_begin = t_begin,
                                                         t_end = t_end)
    
 
    df_averted_without_screening_individual <- as.data.frame(averted_without_screening_individual)
    df_averted_with_screening_individual <- as.data.frame(averted_with_screening_individual)
    
    # Determine y-axis settings for this figure
    if (i == 1 ) {  # Example: The second figure requires different limits
      y_limits <- custom_y_limits1_indi
      y_breaks <- custom_y_breaks1_indi
      
    } else if (i == 2) {
      y_limits <- custom_y_limits2_indi
      y_breaks <- custom_y_breaks2_indi
      
    }else if (i == 3) {
      y_limits <- custom_y_limits3_indi
      y_breaks <- custom_y_breaks3_indi
      
    }else if (i == 4) {
      y_limits <- custom_y_limits4_indi
      y_breaks <- custom_y_breaks4_indi
      
    }
    
    
    averted_plot_screening_individual <- get_plot_averted_screening(
      df_with_screening =  df_averted_with_screening_individual ,
      df_without_screening = df_averted_without_screening_individual,
      y_limits = y_limits,
      y_breaks = y_breaks)
    
    
    
    plot_list_individual[[i]] <-  averted_plot_screening_individual
    
  }
  
  
  
  
  plot_list <- c(plot_list_population, plot_list_individual)
  
  ## remove legend in each of the figure
  plot_list_wo_legend <- list()
  
  for (i in seq_along(plot_list)) {
    plot_list_wo_legend[[i]] <- plot_list[[i]] + theme(legend.position = "none")
  }  
  
  ## extrct the legend  
  legend_plot <- get_legend( averted_plot_screening_population )  
  
  # Create the grid of plots without individual x and y labels
  plot_wo_labels <- plot_grid(
    plotlist = plot_list_wo_legend,
    nrow = 4,
    ncol = 2,
    align = "hv",
    axis = "tblr",
    labels = c("(a)", "(b)", "(c)", "(d)", "(e)", "(f)", "(g)", "(h)"),  # Add subfigure labels
    label_size = 40,                        # Adjust label size
    label_x = 0.03,                         # Adjust horizontal position of labels
    label_y = 1.08                          # Adjust vertical position of labels
  )
  
  plot_with_labels <- ggdraw() +
    draw_plot(plot_wo_labels, x = 0, y = 0, width = 1, height = 1) +   
    draw_label(y_lab, x = 0.01, y = 0.55, angle = 90, size = 45, fontface = "bold") +  # Y-axis label
    draw_label("Age at vaccination (year)", x = 0.5, y = 0.025, angle = 0, size = 45, fontface = "bold")           # X-axis label
  
  # make grid of plots  
  final_plot_with_legend <- plot_grid(
    legend_plot,
    plot_with_labels,
    nrow = 2, 
    rel_heights = c(0.1,1)  
  )
  
  return(final_plot_with_legend)
  
}  



### Inputs

## List all the datasets that we want to plot together
set_of_rds_files <- list(
  c("pri_sec_neq_detailed_a7_sero_dom_denv1_vcov_0.8_baseline_yes_nsamp_100_waning_0.rds",
    "pri_sec_neq_detailed_a7_sero_dom_denv1_vcov_0.8_baseline_no_nsamp_100_waning_0.rds",
    "pri_sec_neq_detailed_a7_sero_dom_denv1_vcov_0.8_baseline_yes_nsamp_100_waning_0_prescrng_1.rds",
    "pri_sec_neq_detailed_a7_sero_dom_denv1_vcov_0.8_baseline_no_nsamp_100_waning_0_prescrng_1.rds"),  # Set 1

 c("pri_sec_neq_detailed_a7_sero_dom_denv2_vcov_0.8_baseline_yes_nsamp_100_waning_0.rds",
    "pri_sec_neq_detailed_a7_sero_dom_denv2_vcov_0.8_baseline_no_nsamp_100_waning_0.rds",
    "pri_sec_neq_detailed_a7_sero_dom_denv2_vcov_0.8_baseline_yes_nsamp_100_waning_0_prescrng_1.rds",
    "pri_sec_neq_detailed_a7_sero_dom_denv2_vcov_0.8_baseline_no_nsamp_100_waning_0_prescrng_1.rds"), # Set 2
 
 c("pri_sec_neq_detailed_a7_sero_dom_denv3_vcov_0.8_baseline_yes_nsamp_100_waning_0.rds",
    "pri_sec_neq_detailed_a7_sero_dom_denv3_vcov_0.8_baseline_no_nsamp_100_waning_0.rds",
    "pri_sec_neq_detailed_a7_sero_dom_denv3_vcov_0.8_baseline_yes_nsamp_100_waning_0_prescrng_1.rds",
    "pri_sec_neq_detailed_a7_sero_dom_denv3_vcov_0.8_baseline_no_nsamp_100_waning_0_prescrng_1.rds"), # Set 3
 
 c("pri_sec_neq_detailed_a7_sero_dom_denv4_vcov_0.8_baseline_yes_nsamp_100_waning_0.rds",
    "pri_sec_neq_detailed_a7_sero_dom_denv4_vcov_0.8_baseline_no_nsamp_100_waning_0.rds",
    "pri_sec_neq_detailed_a7_sero_dom_denv4_vcov_0.8_baseline_yes_nsamp_100_waning_0_prescrng_1.rds",
    "pri_sec_neq_detailed_a7_sero_dom_denv4_vcov_0.8_baseline_no_nsamp_100_waning_0_prescrng_1.rds") # set 4
)


## grab the start of vaccination year from one of the dataset
t_begin = readRDS(here::here("model_output",set_of_rds_files[[1]][1]) )$v_year 


custom_y_limits1_pop <- c(0, 15)
custom_y_breaks1_pop <- seq(0, 15, by = 3)

custom_y_limits2_pop <- c(0, 15)
custom_y_breaks2_pop <- seq(0, 15, by = 3)

# Custom y-axis settings for a specific figure (for negative impact)(change it accordingly)
custom_y_limits3_pop <- c(0,15)
custom_y_breaks3_pop <- seq(0, 15, by = 3)

custom_y_limits4_pop <- c(-20, 15)
custom_y_breaks4_pop <- seq(-20, 15, by = 5)


custom_y_limits1_indi <- c(0, 75)
custom_y_breaks1_indi <- seq(0, 75, by = 15)

custom_y_limits2_indi <- c(0, 75)
custom_y_breaks2_indi <- seq(0, 75, by = 15)

# Custom y-axis settings for a specific figure (for negative impact)(change it accordingly)
custom_y_limits3_indi <- c(0,75)
custom_y_breaks3_indi <- seq(0, 75, by = 15)

custom_y_limits4_indi <- c(-125, 75)
custom_y_breaks4_indi <- seq(-125, 75, by = 25)




## Generate figure now
plot_fig <- get_arranged_plot_averted_screening(set_of_rds_files = set_of_rds_files,
                                                                    variable_name = "symp_sample_age",
                                                                    y_lab = "Reported cases averted (%)", 
                                                                    t_begin = t_begin,
                                                                    t_end = t_begin + 9)

figure_name <- "percent_symp_averted_screening_population_individual.jpg"

### save
ggsave(
  filename = file.path(here("figure"), figure_name),  # Combine folder path and file name
  plot = plot_fig,                                            # The plot object to save
  width = 29*2,                                           # Width in inches
  height = 80,                                          # Height in inches
  dpi = 300,
  units = "cm")         

```


### Plotting population and individual impact  of screening together (for hospitalization)

```{r}
get_agg_over_age <- function(arr) {
  arr_agg_age <- apply(arr, c(1,2,4), sum)
  return(arr_agg_age)
}

## cumulative number over year
get_cumulative_over_time <- function(arr, t_begin, t_end) {
  arr_cum_time <- apply(arr[, , t_begin:t_end], c(1, 2), sum)
  return(arr_cum_time)
}


## extract variable from .rds file
extract_variable <- function(rds_file, variable_name) {
  
  result <- readRDS(here::here("model_output",  rds_file) )
  
  out_v <- as.data.frame(result$output, stringsAsFactors = FALSE)
  
  n_vac_age = result$n_vac_age
  n_sample = result$n_sample
  n_age = result$n_age
  n_year = result$n_year
  
  x <- out_v[,colnames(out_v) == variable_name] 
  
  y <- array(NA, dim = c(n_vac_age,n_sample, n_age, n_year))
  
  for (i in 1:n_vac_age) {
    
    y[i,,,] <- x[[paste0("result.", i)]]
  }
  
  return(y)
}


get_averted_screening <- function(nv_output, v_output,  t_begin, t_end){
  
  nv_agg_age <- get_agg_over_age(nv_output)
  v_agg_age <-  get_agg_over_age(v_output)
  
  nv_cum_t <- get_cumulative_over_time( nv_agg_age, t_begin = t_begin, t_end = t_end)
  v_cum_t <- get_cumulative_over_time( v_agg_age, t_begin = t_begin, t_end = t_end)
  
  averted_screening <- 100*(nv_cum_t - v_cum_t)/nv_cum_t   
  
  return( averted_screening)
}


get_plot_averted_screening <- function(df_with_screening, df_without_screening, y_limits, y_breaks) 
  
  {
  
  
  # Add a column for age groups
  df_with_screening$age <- 1:nrow(df_with_screening)
  df_without_screening$age <- 1:nrow(df_without_screening)
  
  
  # Reshape the dataframes to long format
  df_with_screening_long <- gather(df_with_screening, key = "Realization", value = "Output", -age)
  df_without_screening_long <- gather(df_without_screening, key = "Realization", value = "Output", -age)
  
  
  # Add a column to indicate the vaccine coverage for each dataset
  df_with_screening_long$screening_type <- "With pre-screening"
  df_without_screening_long$screening_type <- "Without pre-screening"
  
  # Combine all datasets into one long dataframe
  df_long <- bind_rows(df_with_screening_long, df_without_screening_long)
  
  # Calculate the mean and 95% confidence interval for each age group and vaccine coverage
  summary_df <- df_long %>%
    group_by(age, screening_type) %>%
    summarise(
      mean_output = mean(Output),
      lower_bound = quantile(Output, 0.025),
      upper_bound = quantile(Output, 0.975)
    ) %>%
    ungroup()
  
  # Define colors for different vaccine coverages
  screening_type_barcolors <- c("With pre-screening" = "#d8b365", "Without pre-screening" = "#5ab4ac")
  screening_type_errorbar_colors <- c("With pre-screening" = "#8c510a", "Without pre-screening" = "#01665e")
  # Define the dodge position for side-by-side plotting
  dodge <- position_dodge(width = 0.5)
  
  # Plot using ggplot2
  p <- ggplot(summary_df, aes(x = factor(age), y = mean_output, fill = screening_type)) +
    # geom_point(size = 9, position = dodge, shape = 16) +  # Points for the mean with dodge
    geom_bar(stat = "identity", position = position_dodge(width = 0.75), width = 0.65) +
    
    geom_errorbar(aes(ymin = lower_bound, ymax = upper_bound, color = screening_type), 
                  width = 0.0, size = 1.8, position = position_dodge(width = 0.75)) +
    
    scale_fill_manual(values = screening_type_barcolors, name = "") + # Custom colors for bars
    scale_color_manual(values = screening_type_errorbar_colors,  name = "") + # Custom colors for error bars
    # scale_color_manual(values = poptype_colors, name = "") + 
    scale_x_discrete(
      breaks = c(1, 2, 3, 4, 5, 6, 7),   # Set the positions of the x-axis ticks
      labels = c("6-16", "17-30", "31-40", "41-50", "51-60", "61-70", "71-80")  # Labels for age groups
    ) +
    # labs(x = "Age at vaccination", y = ylab, color = NULL) +  # Labels for x and y axes
    scale_y_continuous(limits = y_limits, breaks = y_breaks) +  # Define y-axis tick points )+
    theme_bw() +  # Clean theme
    theme(
      axis.ticks.length = unit(0.4, "cm"),        # Increase the length of the ticks
      axis.ticks = element_line(size = 1.5),      # Increase the thickness of the ticks
      panel.border = element_rect(color = "black", size = 2),  # Thicker border
      plot.margin = margin(t=10, r=10, b=20, l=25),
      axis.text.x = element_text(size = 35, color="black", angle= 30, margin = margin(t = 10, b = 20)),
      axis.text.y = element_text(size = 35,color="black", margin = margin(r = 10, l = 30)),
      # axis.title = element_text(size = 35, color = "black"),
      axis.title = element_blank(),
      legend.position = "top",
      legend.direction = "horizontal",
      legend.text = element_text(size = 40),
      legend.key.size = unit(2, "cm"),  # Increase size of legend keys
      legend.key.height = unit(1.5, "cm"),  # Increase height of legend keys
      legend.key.width = unit(2.5, "cm"),  # Increase width of legend keys
      legend.background = element_blank()
    )
  
  
  
}



get_arranged_plot_averted_screening <- function(set_of_rds_files, variable_name, y_lab, t_begin, t_end) {
  
  plot_list_population <- list()
  plot_list_individual <- list()
  
  for (i in seq_along(set_of_rds_files)) {
    
    rds_files <- set_of_rds_files[[i]]
    
    
    ## FOR population level
    
    ## for total population
    nv_total_without_screening_population <- 1*extract_variable(rds_file = rds_files[1] , 
                                 variable_name = variable_name) + 
      1*extract_variable(rds_file =  rds_files[1], 
                       variable_name = paste0(variable_name, "_v"))
    
    
    v_without_screening_population <- 1*extract_variable(rds_file = rds_files[2] , 
                                           variable_name = variable_name) + 
      1*extract_variable(rds_file =  rds_files[2], 
                       variable_name = paste0(variable_name, "_v"))
    
    
    nv_total_with_screening_population <- 1*extract_variable(rds_file = rds_files[3] , 
                                 variable_name = variable_name) + 
    1*extract_variable(rds_file =  rds_files[3], 
                       variable_name = paste0(variable_name, "_v"))
    
    
    v_with_screening_population <- 1*extract_variable(rds_file = rds_files[4] , 
                                        variable_name = variable_name) + 
      1*extract_variable(rds_file =  rds_files[4], 
                       variable_name = paste0(variable_name, "_v"))
    
 
    averted_without_screening_population <- get_averted_screening(nv_output = nv_total_without_screening_population,
                                                            v_output = v_without_screening_population,
                                                            t_begin = t_begin,
                                                            t_end = t_end)
    
    averted_with_screening_population <- get_averted_screening(nv_output = nv_total_with_screening_population,
                                                         v_output = v_with_screening_population,
                                                         t_begin = t_begin,
                                                         t_end = t_end)
    
 
    df_averted_without_screening_population <- as.data.frame(averted_without_screening_population)
    df_averted_with_screening_population <- as.data.frame(averted_with_screening_population )
    
    # Determine y-axis settings for this figure
    if (i == 1 ) {  # Example: The second figure requires different limits
      y_limits <- custom_y_limits1_pop
      y_breaks <- custom_y_breaks1_pop
      
    } else if (i == 2) {
      y_limits <- custom_y_limits2_pop
      y_breaks <- custom_y_breaks2_pop
      
    }else if (i == 3) {
      y_limits <- custom_y_limits3_pop
      y_breaks <- custom_y_breaks3_pop
      
    }else if (i == 4) {
      y_limits <- custom_y_limits4_pop
      y_breaks <- custom_y_breaks4_pop
      
    }
    
    
    averted_plot_screening_population <- get_plot_averted_screening(
      df_with_screening =  df_averted_with_screening_population ,
      df_without_screening = df_averted_without_screening_population,
      y_limits = y_limits,
      y_breaks = y_breaks)
    
    
    
    plot_list_population[[i]] <-  averted_plot_screening_population
    
  }
  
  
  ### now for individual level
  
   for (i in seq_along(set_of_rds_files)) {
    
    rds_files <- set_of_rds_files[[i]]
    
    ## for total population
    nv_total_without_screening_individual <- 0*extract_variable(rds_file = rds_files[1] , 
                                 variable_name = variable_name) + 
      1*extract_variable(rds_file =  rds_files[1], 
                       variable_name = paste0(variable_name, "_v"))
    
    
    v_without_screening_individual <- 0*extract_variable(rds_file = rds_files[2] , 
                                           variable_name = variable_name) + 
      1*extract_variable(rds_file =  rds_files[2], 
                       variable_name = paste0(variable_name, "_v"))
    
    
    nv_total_with_screening_individual <- 0*extract_variable(rds_file = rds_files[3] , 
                                 variable_name = variable_name) + 
    1*extract_variable(rds_file =  rds_files[3], 
                       variable_name = paste0(variable_name, "_v"))
    
    
    v_with_screening_individual <- 0*extract_variable(rds_file = rds_files[4] , 
                                        variable_name = variable_name) + 
      1*extract_variable(rds_file =  rds_files[4], 
                       variable_name = paste0(variable_name, "_v"))
    
 
    averted_without_screening_individual <- get_averted_screening(nv_output = nv_total_without_screening_individual,
                                                            v_output = v_without_screening_individual,
                                                            t_begin = t_begin,
                                                            t_end = t_end)
    
    averted_with_screening_individual <- get_averted_screening(nv_output = nv_total_with_screening_individual,
                                                         v_output = v_with_screening_individual,
                                                         t_begin = t_begin,
                                                         t_end = t_end)
    
 
    df_averted_without_screening_individual <- as.data.frame(averted_without_screening_individual)
    df_averted_with_screening_individual <- as.data.frame(averted_with_screening_individual)
    
    # Determine y-axis settings for this figure
    if (i == 1 ) {  # Example: The second figure requires different limits
      y_limits <- custom_y_limits1_indi
      y_breaks <- custom_y_breaks1_indi
      
    } else if (i == 2) {
      y_limits <- custom_y_limits2_indi
      y_breaks <- custom_y_breaks2_indi
      
    }else if (i == 3) {
      y_limits <- custom_y_limits3_indi
      y_breaks <- custom_y_breaks3_indi
      
    }else if (i == 4) {
      y_limits <- custom_y_limits4_indi
      y_breaks <- custom_y_breaks4_indi
      
    }
    
    
    averted_plot_screening_individual <- get_plot_averted_screening(
      df_with_screening =  df_averted_with_screening_individual ,
      df_without_screening = df_averted_without_screening_individual,
      y_limits = y_limits,
      y_breaks = y_breaks)
    
    
    
    plot_list_individual[[i]] <-  averted_plot_screening_individual
    
  }
  
  
  
  
  plot_list <- c(plot_list_population, plot_list_individual)
  
  ## remove legend in each of the figure
  plot_list_wo_legend <- list()
  
  for (i in seq_along(plot_list)) {
    plot_list_wo_legend[[i]] <- plot_list[[i]] + theme(legend.position = "none")
  }  
  
  ## extrct the legend  
  legend_plot <- get_legend( averted_plot_screening_population )  
  
  # Create the grid of plots without individual x and y labels
  plot_wo_labels <- plot_grid(
    plotlist = plot_list_wo_legend,
    nrow = 4,
    ncol = 2,
    align = "hv",
    axis = "tblr",
    labels = c("(a)", "(b)", "(c)", "(d)", "(e)", "(f)", "(g)", "(h)"),  # Add subfigure labels
    label_size = 40,                        # Adjust label size
    label_x = 0.03,                         # Adjust horizontal position of labels
    label_y = 1.08                          # Adjust vertical position of labels
  )
  
  plot_with_labels <- ggdraw() +
    draw_plot(plot_wo_labels, x = 0, y = 0, width = 1, height = 1) +   
    draw_label(y_lab, x = 0.01, y = 0.55, angle = 90, size = 45, fontface = "bold") +  # Y-axis label
    draw_label("Age at vaccination (year)", x = 0.5, y = 0.025, angle = 0, size = 45, fontface = "bold")           # X-axis label
  
  # make grid of plots  
  final_plot_with_legend <- plot_grid(
    legend_plot,
    plot_with_labels,
    nrow = 2, 
    rel_heights = c(0.1,1)  
  )
  
  return(final_plot_with_legend)
  
}  



### Inputs

## List all the datasets that we want to plot together
set_of_rds_files <- list(
  c("pri_sec_neq_detailed_a7_sero_dom_denv1_vcov_0.8_baseline_yes_nsamp_100_waning_0.rds",
    "pri_sec_neq_detailed_a7_sero_dom_denv1_vcov_0.8_baseline_no_nsamp_100_waning_0.rds",
    "pri_sec_neq_detailed_a7_sero_dom_denv1_vcov_0.8_baseline_yes_nsamp_100_waning_0_prescrng_1.rds",
    "pri_sec_neq_detailed_a7_sero_dom_denv1_vcov_0.8_baseline_no_nsamp_100_waning_0_prescrng_1.rds"),  # Set 1

 c("pri_sec_neq_detailed_a7_sero_dom_denv2_vcov_0.8_baseline_yes_nsamp_100_waning_0.rds",
    "pri_sec_neq_detailed_a7_sero_dom_denv2_vcov_0.8_baseline_no_nsamp_100_waning_0.rds",
    "pri_sec_neq_detailed_a7_sero_dom_denv2_vcov_0.8_baseline_yes_nsamp_100_waning_0_prescrng_1.rds",
    "pri_sec_neq_detailed_a7_sero_dom_denv2_vcov_0.8_baseline_no_nsamp_100_waning_0_prescrng_1.rds"), # Set 2
 
 c("pri_sec_neq_detailed_a7_sero_dom_denv3_vcov_0.8_baseline_yes_nsamp_100_waning_0.rds",
    "pri_sec_neq_detailed_a7_sero_dom_denv3_vcov_0.8_baseline_no_nsamp_100_waning_0.rds",
    "pri_sec_neq_detailed_a7_sero_dom_denv3_vcov_0.8_baseline_yes_nsamp_100_waning_0_prescrng_1.rds",
    "pri_sec_neq_detailed_a7_sero_dom_denv3_vcov_0.8_baseline_no_nsamp_100_waning_0_prescrng_1.rds"), # Set 3
 
 c("pri_sec_neq_detailed_a7_sero_dom_denv4_vcov_0.8_baseline_yes_nsamp_100_waning_0.rds",
    "pri_sec_neq_detailed_a7_sero_dom_denv4_vcov_0.8_baseline_no_nsamp_100_waning_0.rds",
    "pri_sec_neq_detailed_a7_sero_dom_denv4_vcov_0.8_baseline_yes_nsamp_100_waning_0_prescrng_1.rds",
    "pri_sec_neq_detailed_a7_sero_dom_denv4_vcov_0.8_baseline_no_nsamp_100_waning_0_prescrng_1.rds") # set 4
)


## grab the start of vaccination year from one of the dataset
t_begin = readRDS(here::here("model_output",set_of_rds_files[[1]][1]) )$v_year 


custom_y_limits1_pop <- c(0, 20)
custom_y_breaks1_pop <- seq(0, 20, by = 5)

custom_y_limits2_pop <- c(0, 20)
custom_y_breaks2_pop <- seq(0, 20, by = 5)

# Custom y-axis settings for a specific figure (for negative impact)(change it accordingly)
custom_y_limits3_pop <- c(0, 20)
custom_y_breaks3_pop <- seq(0, 20, by = 5)

custom_y_limits4_pop <- c(-1, 20)
custom_y_breaks4_pop <- seq(0, 20, by = 5)


custom_y_limits1_indi <- c(0, 90)
custom_y_breaks1_indi <- seq(0, 90, by = 15)

custom_y_limits2_indi <- c(0, 90)
custom_y_breaks2_indi <- seq(0, 90, by = 15)

# Custom y-axis settings for a specific figure (for negative impact)(change it accordingly)
custom_y_limits3_indi <- c(0, 90)
custom_y_breaks3_indi <- seq(0, 90, by = 15)

custom_y_limits4_indi <- c(-2, 90)
custom_y_breaks4_indi <- seq(0, 90, by = 15)





## Generate figure now
plot_fig <- get_arranged_plot_averted_screening(set_of_rds_files = set_of_rds_files,
                                                                    variable_name = "hosp_sample_age",
                                                                    y_lab = "Hospitalizations averted (%)", 
                                                                    t_begin = t_begin,
                                                                    t_end = t_begin + 9)

figure_name <- "percent_hosp_averted_screening_population_individual.jpg"

### save
ggsave(
  filename = file.path(here("figure"), figure_name),  # Combine folder path and file name
  plot = plot_fig,                                            # The plot object to save
  width = 29*2,                                           # Width in inches
  height = 80,                                          # Height in inches
  dpi = 300,
  units = "cm")         

```








## Supplementary

#### averted matrix for cases

```{r}

get_plot_averted_matrix <- function(df_averted_mean) {
  
  
  age_group_labels <- c("6-16","17-30",
                        "31-40","41-50",
                        "51-60","61-70", "71-80")  
  df <- melt(df_averted_mean)
  
  # Create heatmap using ggplot2
  p <- ggplot(df, aes(x = Var1, y = Var2, fill = value)) +
    geom_tile(color = "white", size = 0.1) +  # Add white borders for 
    # geom_text(aes(label = ifelse(floor(value) != 0, round(value, 1), "")), color = "black", size = 3) +  # Add numbers for non-zero values
    # # geom_text(aes(label = round(value, 1)), color = "white", size = 3) +
    geom_text(aes(label = floor(value)), color = "black", size = 10)+
    
    # Use a diverging color scale to handle negative and positive values
    scale_fill_gradient2(
      low = "#a6611a",       # Color for negative values
      mid = "#ffffbf",      # Color for zero
      high = "#018571",       # Color for positive values
      midpoint = 0,       # Define the midpoint as 0 for neutral color
      name = "Cases \naverted (%)" # Label for the legend
    ) +
    theme_minimal()+
  
    # labs(x = "Vaccinated age group", y = "Age group", title = "") +
    theme(
      # axis.ticks.length = unit(0.4, "cm"),        # Increase the length of the ticks
      # axis.ticks = element_line(size = 1.5),      # Increase the thickness of the ticks
      # panel.border = element_rect(color = "black", size = 2),  # Thicker border
      plot.margin = margin(t=0, r=0, b=20, l=0),
      axis.text.x = element_text(margin = margin(t= 20, b = 0),angle = 45, color = "black", size = 30),
      axis.text.y = element_text(margin = margin(t = 0),angle = 45, color = "black", size = 30),#element_text(angle = 45, hjust = 1.0, vjust = 1.0, color = "black", size = 35),
      axis.title = element_blank(),
      # plot.title = element_text(hjust = 0.5, size = 16, face = "bold"),
      panel.grid.major = element_blank(),  # Remove gridlines
      panel.grid.minor = element_blank(),
      legend.position = "top",
      legend.direction = "horizontal",
      legend.text = element_text(size = 25 ),
      legend.title = element_text(size = 20, face = "bold"),
      legend.key.size = unit(1, "cm"),  # Increase size of legend keys
      legend.key.height = unit(1.0, "cm"),  # Increase height of legend keys
      legend.key.width = unit(1.2, "cm"),  # Increase width of legend keys
      legend.background = element_blank()
      # legend.position = "top",  # Position the legend on the right for clarity
      # legend.direction = "horizontal",
      # legend.key.width = unit(1.0, "cm")  # Make the legend key wider for better visibility
    ) + scale_x_continuous(breaks = 1:7, 
                           labels = age_group_labels) +
    scale_y_continuous(breaks = 1:7, 
                       labels = age_group_labels) +
    coord_fixed()  # Ensure square tiles
  
  
  # p
}


get_cumulative_over_time_age_wise <- function(arr, t_begin, t_end, age_list) {
  arr_cum_time_age <- apply(arr[, , ,t_begin:t_end], c(1, 2, 3), sum)
  
  arr_cum_age_gr <- array(NA, dim = c(dim(arr)[1], dim(arr)[2], nrow(age_list) ))
  
  for (i in 1:nrow(age_list)) {
    
    arr_cum_age_gr[,,i] <-  apply(arr_cum_time_age[,,age_list[i,1]:age_list[i,2]], c(1, 2), sum)
    
    
  }
  
  return(arr_cum_age_gr)
}



get_averted_age <- function(nv_output, v_output, t_begin, t_end, age_list, output_type){
  
  
  nv_cum_t <- get_cumulative_over_time_age_wise( nv_output, t_begin = t_begin, t_end = t_end, age_list)
  v_cum_t <- get_cumulative_over_time_age_wise( v_output, t_begin = t_begin, t_end = t_end, age_list)
  
  if (output_type == "absolute") {
    
    averted <- (nv_cum_t - v_cum_t)
  }
  
  if (output_type == "proportion") {
    
    averted <- 100*(nv_cum_t - v_cum_t)/nv_cum_t
  }
  return(averted)
  
}


get_age_list <- function(rds_file) {
  
  result <- readRDS(here::here("model_output",  rds_file) )
  
  age_list <- result$v_age_list
  
  return(age_list)
}





get_arranged_plot_impact_matrix_age_gr <- function(set_of_rds_files, variable_name, y_lab, t_begin, t_end, age_list) {
  
  plot_list <- list()
  
  for (i in seq_along(set_of_rds_files)) {
    
    rds_files <- set_of_rds_files[[i]]
    
    
    
    nv_symp <- extract_variable(rds_file = rds_files[1], 
                                variable_name = variable_name) +
      extract_variable(rds_file = rds_files[1],
                       variable_name =  paste0(variable_name, "_v"))

    v_symp <- extract_variable(rds_file = rds_files[2], 
                                variable_name = variable_name) +
      extract_variable(rds_file = rds_files[2],
                       variable_name = paste0(variable_name, "_v"))

    
    ## to get rid of small number which will create large number when we divide to get the proportion
    # nv_symp[nv_symp < 10] <- 0
    # v_symp[v_symp < 10] <- 0
    
    averted_inc <- get_averted_age(nv_output = nv_symp,
                                   v_output = v_symp,
                                   t_begin = t_begin,
                                   t_end = t_end,
                                   age_list = age_list,
                                   output_type = "proportion")
    
    averted_inc_mean <-  apply(averted_inc, c(1, 3), mean)
    averted_inc_mean[is.nan(averted_inc_mean)] <- 0 
    
    averted_matrix_plot <- get_plot_averted_matrix(df_averted_mean = (averted_inc_mean))
    
    plot_list[[i]] <-  averted_matrix_plot
    
  }
  

  
  # Create the grid of plots without individual x and y labels
  plot_wo_labels <- plot_grid(
    plotlist = plot_list,
    nrow = 2,
    ncol = 2,
    align = "hv",
    axis = "tblr",
    labels = c("(a)", "(b)", "(c)", "(d)"),  # Add subfigure labels
    label_size = 40,                        # Adjust label size
    label_x = 0.08,                         # Adjust horizontal position of labels
    label_y = 1.0                          # Adjust vertical position of labels
  )
  
  plot_with_labels <- ggdraw() +
    draw_plot(plot_wo_labels, x = 0, y = 0, width = 1, height = 1) +   
    draw_label(y_lab, x = 0.01, y = 0.55, angle = 90, size = 45, fontface = "bold") +  # Y-axis label
    draw_label("Vaccinated age group (year)", x = 0.5, y = 0.023, angle = 0, size = 45, fontface = "bold")           # X-axis label
  

  return(plot_with_labels)
  
}  



### Inputs

set_of_rds_files <- list(
  c("pri_sec_neq_detailed_a7_sero_dom_denv1_vcov_0.8_baseline_yes_nsamp_100_waning_0.rds",
    "pri_sec_neq_detailed_a7_sero_dom_denv1_vcov_0.8_baseline_no_nsamp_100_waning_0.rds"),  # Set 1

  c("pri_sec_neq_detailed_a7_sero_dom_denv2_vcov_0.8_baseline_yes_nsamp_100_waning_0.rds",
    "pri_sec_neq_detailed_a7_sero_dom_denv2_vcov_0.8_baseline_no_nsamp_100_waning_0.rds"),  # Set 2

  c("pri_sec_neq_detailed_a7_sero_dom_denv3_vcov_0.8_baseline_yes_nsamp_100_waning_0.rds",
    "pri_sec_neq_detailed_a7_sero_dom_denv3_vcov_0.8_baseline_no_nsamp_100_waning_0.rds"),  # Set 3

  c("pri_sec_neq_detailed_a7_sero_dom_denv4_vcov_0.8_baseline_yes_nsamp_100_waning_0.rds",
    "pri_sec_neq_detailed_a7_sero_dom_denv4_vcov_0.8_baseline_no_nsamp_100_waning_0.rds")    # Set 4
)

## grab the start of vaccination year from one of the dataset
t_begin = readRDS(here::here("model_output",set_of_rds_files[[1]][1]) )$v_year 

age_list <- get_age_list(rds_file = set_of_rds_files[[1]][1])

## Generate figure now
plot_aggregated_impact_matrix <- get_arranged_plot_impact_matrix_age_gr(set_of_rds_files = set_of_rds_files,
                                                                             variable_name = "symp_sample_age",
                                                                      y_lab = "Age group (year)",
                                                                      t_begin = t_begin,
                                                                      t_end = t_begin + 9, 
                                                                      age_list = age_list)



figure_name <- "impact_matrix_symp_aggregated.jpg"


# # ### save
ggsave(
  filename = file.path(here("figure"), figure_name),  # Combine folder path and file name
  plot = plot_aggregated_impact_matrix,                                            # The plot object to save
  width = 20*2,                                           # Width in inches
  height = 40,                                          # Height in inches
  dpi = 300,
  units = "cm")                                  # DPI (resolution)


```





#### averted matrix for hospitalizations

```{r}

get_plot_averted_matrix <- function(df_averted_mean) {
  
  
  age_group_labels <- c("6-16","17-30",
                        "31-40","41-50",
                        "51-60","61-70", "71-80")  
  df <- melt(df_averted_mean)
  
  # Create heatmap using ggplot2
  p <- ggplot(df, aes(x = Var1, y = Var2, fill = value)) +
    geom_tile(color = "white", size = 0.1) +  # Add white borders for 
    # geom_text(aes(label = ifelse(floor(value) != 0, round(value, 1), "")), color = "black", size = 3) +  # Add numbers for non-zero values
    # # geom_text(aes(label = round(value, 1)), color = "white", size = 3) +
    geom_text(aes(label = floor(value)), color = "black", size = 10)+
    
    # Use a diverging color scale to handle negative and positive values
    scale_fill_gradient2(
      low = "#a6611a",       # Color for negative values
      mid = "#ffffbf",      # Color for zero
      high = "#018571",       # Color for positive values
      midpoint = 0,       # Define the midpoint as 0 for neutral color
      name = "Hospitalizations \naverted (%)" # Label for the legend
    ) +
    theme_minimal()+
  
    # labs(x = "Vaccinated age group", y = "Age group", title = "") +
    theme(
      # axis.ticks.length = unit(0.4, "cm"),        # Increase the length of the ticks
      # axis.ticks = element_line(size = 1.5),      # Increase the thickness of the ticks
      # panel.border = element_rect(color = "black", size = 2),  # Thicker border
      plot.margin = margin(t=0, r=0, b=20, l=0),
      axis.text.x = element_text(margin = margin(t= 20, b = 0),angle = 45, color = "black", size = 30),
      axis.text.y = element_text(margin = margin(t = 0),angle = 45, color = "black", size = 30),#element_text(angle = 45, hjust = 1.0, vjust = 1.0, color = "black", size = 35),
      axis.title = element_blank(),
      # plot.title = element_text(hjust = 0.5, size = 16, face = "bold"),
      panel.grid.major = element_blank(),  # Remove gridlines
      panel.grid.minor = element_blank(),
      legend.position = "top",
      legend.direction = "horizontal",
      legend.text = element_text(size = 25 ),
      legend.title = element_text(size = 20, face = "bold"),
      legend.key.size = unit(1, "cm"),  # Increase size of legend keys
      legend.key.height = unit(1.0, "cm"),  # Increase height of legend keys
      legend.key.width = unit(1.2, "cm"),  # Increase width of legend keys
      legend.background = element_blank()
    ) + scale_x_continuous(breaks = 1:7, 
                           labels = age_group_labels) +
    scale_y_continuous(breaks = 1:7, 
                       labels = age_group_labels) +
    coord_fixed()  # Ensure square tiles
  
  
  p
}


get_cumulative_over_time_age_wise <- function(arr, t_begin, t_end, age_list) {
  arr_cum_time_age <- apply(arr[, , ,t_begin:t_end], c(1, 2, 3), sum)
  
  arr_cum_age_gr <- array(NA, dim = c(dim(arr)[1], dim(arr)[2], nrow(age_list) ))
  
  for (i in 1:nrow(age_list)) {
    
    arr_cum_age_gr[,,i] <-  apply(arr_cum_time_age[,,age_list[i,1]:age_list[i,2]], c(1, 2), sum)
    
    
  }
  
  return(arr_cum_age_gr)
}



get_averted_age <- function(nv_output, v_output, t_begin, t_end, age_list, output_type){
  
  
  nv_cum_t <- get_cumulative_over_time_age_wise( nv_output, t_begin = t_begin, t_end = t_end, age_list)
  v_cum_t <- get_cumulative_over_time_age_wise( v_output, t_begin = t_begin, t_end = t_end, age_list)
  
  if (output_type == "absolute") {
    
    averted <- (nv_cum_t - v_cum_t)
  }
  
  if (output_type == "proportion") {
    
    averted <- 100*(nv_cum_t - v_cum_t)/nv_cum_t
  }
  return(averted)
  
}


get_age_list <- function(rds_file) {
  
  result <- readRDS(here::here("model_output",  rds_file) )
  
  age_list <- result$v_age_list
  
  return(age_list)
}





get_arranged_plot_impact_matrix_age_gr <- function(set_of_rds_files, variable_name, y_lab, t_begin, t_end, age_list) {
  
  plot_list <- list()
  
  for (i in seq_along(set_of_rds_files)) {
    
    rds_files <- set_of_rds_files[[i]]
    
    
    
    nv_symp <- extract_variable(rds_file = rds_files[1], 
                                variable_name = variable_name) +
      extract_variable(rds_file = rds_files[1],
                       variable_name =  paste0(variable_name, "_v"))

    v_symp <- extract_variable(rds_file = rds_files[2], 
                                variable_name = variable_name) +
      extract_variable(rds_file = rds_files[2],
                       variable_name = paste0(variable_name, "_v"))

    
    averted_inc <- get_averted_age(nv_output = nv_symp,
                                   v_output = v_symp,
                                   t_begin = t_begin,
                                   t_end = t_end,
                                   age_list = age_list,
                                   output_type = "proportion")
    
    averted_inc_mean <-  apply(averted_inc, c(1, 3), mean)
    averted_inc_mean[is.nan(averted_inc_mean)] <- 0 
    
    averted_matrix_plot <- get_plot_averted_matrix(df_averted_mean = (averted_inc_mean))
    
    plot_list[[i]] <-  averted_matrix_plot
    
  }
  

  
  # Create the grid of plots without individual x and y labels
  plot_wo_labels <- plot_grid(
    plotlist = plot_list,
    nrow = 2,
    ncol = 2,
    align = "hv",
    axis = "tblr",
    labels = c("(a)", "(b)", "(c)", "(d)"),  # Add subfigure labels
    label_size = 40,                        # Adjust label size
    label_x = 0.08,                         # Adjust horizontal position of labels
    label_y = 1.0                          # Adjust vertical position of labels
  )
  
  plot_with_labels <- ggdraw() +
    draw_plot(plot_wo_labels, x = 0, y = 0, width = 1, height = 1) +   
    draw_label(y_lab, x = 0.01, y = 0.55, angle = 90, size = 45, fontface = "bold") +  # Y-axis label
    draw_label("Vaccinated age group (year)", x = 0.5, y = 0.023, angle = 0, size = 45, fontface = "bold")           # X-axis label
  

  return(plot_with_labels)
  
}  



### Inputs

set_of_rds_files <- list(
  c("pri_sec_neq_detailed_a7_sero_dom_denv1_vcov_0.8_baseline_yes_nsamp_100_waning_0.rds",
    "pri_sec_neq_detailed_a7_sero_dom_denv1_vcov_0.8_baseline_no_nsamp_100_waning_0.rds"),  # Set 1

  c("pri_sec_neq_detailed_a7_sero_dom_denv2_vcov_0.8_baseline_yes_nsamp_100_waning_0.rds",
    "pri_sec_neq_detailed_a7_sero_dom_denv2_vcov_0.8_baseline_no_nsamp_100_waning_0.rds"),  # Set 2

  c("pri_sec_neq_detailed_a7_sero_dom_denv3_vcov_0.8_baseline_yes_nsamp_100_waning_0.rds",
    "pri_sec_neq_detailed_a7_sero_dom_denv3_vcov_0.8_baseline_no_nsamp_100_waning_0.rds"),  # Set 3

  c("pri_sec_neq_detailed_a7_sero_dom_denv4_vcov_0.8_baseline_yes_nsamp_100_waning_0.rds",
    "pri_sec_neq_detailed_a7_sero_dom_denv4_vcov_0.8_baseline_no_nsamp_100_waning_0.rds")    # Set 4
)

## grab the start of vaccination year from one of the dataset
t_begin = readRDS(here::here("model_output",set_of_rds_files[[1]][1]) )$v_year 

age_list <- get_age_list(rds_file = set_of_rds_files[[1]][1])

## Generate figure now
plot_aggregated_impact_matrix <- get_arranged_plot_impact_matrix_age_gr(set_of_rds_files = set_of_rds_files,
                                                                             variable_name = "hosp_sample_age",
                                                                      y_lab = "Age group (year)",
                                                                      t_begin = t_begin,
                                                                      t_end = t_begin + 9, 
                                                                      age_list = age_list)



figure_name <- "impact_matrix_symp_aggregated_hosp.jpg"


# # ### save
ggsave(
  filename = file.path(here("figure"), figure_name),  # Combine folder path and file name
  plot = plot_aggregated_impact_matrix,                                            # The plot object to save
  width = 20*2,                                           # Width in inches
  height = 40,                                          # Height in inches
  dpi = 300,
  units = "cm")                                  # DPI (resolution)


```



## sensitivity on reporting rate for cases


```{r}

## aggregate over all the age groups
get_agg_over_age <- function(arr) {
  arr_agg_age <- apply(arr, c(1,2,4), sum)
  return(arr_agg_age)
}

## cumulative number over year
get_cumulative_over_time <- function(arr, t_begin, t_end) {
  arr_cum_time <- apply(arr[, , t_begin:t_end], c(1, 2), sum)
  return(arr_cum_time)
}

## calculate the averted 
get_averted <- function(nv_output, v_output, t_begin, t_end, output_type){
  
  nv_agg_age <- get_agg_over_age(nv_output)
  v_agg_age <-  get_agg_over_age(v_output)
  
  nv_cum_t <- get_cumulative_over_time( nv_agg_age, t_begin = t_begin, t_end = t_end)
  v_cum_t <- get_cumulative_over_time( v_agg_age, t_begin = t_begin, t_end = t_end)
  
  if (output_type == "absolute") {
    
    averted <- (nv_cum_t - v_cum_t)
  }
  
  if (output_type == "proportion") {
    
    averted <- 100*(nv_cum_t - v_cum_t)/nv_cum_t
  }
  
  return(averted)
}


## extract variable from .rds file
extract_variable <- function(rds_file, variable_name) {
  
  result <- readRDS(here::here("model_output",  rds_file) )
  
  out_v <- as.data.frame(result$output, stringsAsFactors = FALSE)
  
  n_vac_age = result$n_vac_age
  n_sample = result$n_sample
  n_age = result$n_age
  n_year = result$n_year
  
  x <- out_v[,colnames(out_v) == variable_name] 
  
  y <- array(NA, dim = c(n_vac_age,n_sample, n_age, n_year))
  
  for (i in 1:n_vac_age) {
    
    y[i,,,] <- x[[paste0("result.", i)]]
  }
  
  return(y)
}

## make single figure
get_plot_averted <- function(df_scenario1, df_scenario2, df_scenario3, y_limits, y_breaks) {
  
  # Add a column for age groups
  df_scenario1$age <- 1:nrow(df_scenario1)
  df_scenario2$age <- 1:nrow(df_scenario2)
  df_scenario3$age <- 1:nrow(df_scenario3)
  
  # Reshape the dataframes to long format
  df_scenario1_long <- gather(df_scenario1, key = "Realization", value = "Output", -age)
  df_scenario2_long <- gather(df_scenario2, key = "Realization", value = "Output", -age)
  df_scenario3_long <- gather(df_scenario3, key = "Realization", value = "Output", -age)
  
  # Add a column to indicate the vaccine coverage for each dataset
  df_scenario1_long$assumption <- "Assumption 1"
  df_scenario2_long$assumption <- "Assumption 2"
  df_scenario3_long$assumption <- "Assumption 3"
  
  # Combine all datasets into one long dataframe
  df_long <- bind_rows(df_scenario1_long, df_scenario2_long, df_scenario3_long)
  
  # Calculate the mean and 95% confidence interval for each age group and vaccine coverage
  summary_df <- df_long %>%
    group_by(age, assumption ) %>%
    summarise(
      mean_output =  quantile(Output, 0.5), #mean(Output),
      lower_bound = quantile(Output, 0.025),
      upper_bound = quantile(Output, 0.975)
    ) %>%
    ungroup()

  # 
  
  # Define colors for different vaccine coverages
  assumption_colors <- c("Assumption 1" = "#fb8072", "Assumption 2" = "#80b1d3", "Assumption 3" = "#fdb462")
  
  # Define the dodge position for side-by-side plotting
  dodge <- position_dodge(width = 0.3)
  
  # Plot using ggplot2
  p <- ggplot(summary_df, aes(x = factor(age), y = mean_output, color = assumption)) +
    geom_point(size = 9, position = dodge, shape = 15) +  # Points for the mean with dodge
    geom_errorbar(aes(ymin = lower_bound, ymax = upper_bound), 
                  width = 0.0, size = 1.8, position = dodge) +  # Error bars with dodge
    scale_color_manual(values = assumption_colors, name = "") + 
    scale_x_discrete(
      breaks = c(1, 2, 3, 4, 5, 6, 7),   # Set the positions of the x-axis ticks
      labels = c("6-16", "17-30", "31-40", "41-50", "51-60", "61-70", "71-80")  # Labels for age groups
    ) +
    # labs(x = "Age at vaccination", y = ylab, color = NULL) +  # Labels for x and y axes
    scale_y_continuous(limits = y_limits, breaks = y_breaks) +  # Define y-axis tick points )+
    theme_bw() +  # Clean theme
    theme(
      axis.ticks.length = unit(0.4, "cm"),        # Increase the length of the ticks
      axis.ticks = element_line(size = 1.5),      # Increase the thickness of the ticks
      panel.border = element_rect(color = "black", size = 2),  # Thicker border
      plot.margin = margin(t=10, r=10, b=10, l=10),
      axis.text.x = element_text(size = 35, color="black", angle= 30, margin = margin(t = 10, b = 10)),
      axis.text.y = element_text(size = 35,color="black", margin = margin(r = 10, l = 30)),
      # axis.title = element_text(size = 35, color = "black"),
      axis.title = element_blank(),
      legend.position = "top",
      legend.direction = "horizontal",
      legend.text = element_text(size = 40),
      legend.key.size = unit(2, "cm"),  # Increase size of legend keys
      legend.key.height = unit(1.5, "cm"),  # Increase height of legend keys
      legend.key.width = unit(2.5, "cm"),  # Increase width of legend keys
      legend.background = element_blank()
    )
  
  return(list(plot = p, summary = summary_df))
  
}


get_arranged_plot_avert_percent <- function(set_of_rds_files, variable_name, y_lab, t_begin, t_end) {
  
  plot_list <- list()
  summary_list <- list()

  for (i in seq_along(set_of_rds_files)) {
    
    rds_files <- set_of_rds_files[[i]]
    
    nv_scenario1 <- extract_variable(rds_file = rds_files[1] , 
                            variable_name = variable_name) + 
      extract_variable(rds_file =  rds_files[1], 
                       variable_name = paste0(variable_name, "_v"))
    
    v_scenario1 <- extract_variable(rds_file = rds_files[2] , 
                             variable_name = variable_name) + 
      extract_variable(rds_file =  rds_files[2], 
                       variable_name = paste0(variable_name, "_v"))
    
    
      nv_scenario2 <- extract_variable(rds_file = rds_files[3] , 
                            variable_name = variable_name) + 
      extract_variable(rds_file =  rds_files[3], 
                       variable_name = paste0(variable_name, "_v"))
    
    v_scenario2 <- extract_variable(rds_file = rds_files[4] , 
                             variable_name = variable_name) + 
      extract_variable(rds_file =  rds_files[4], 
                       variable_name = paste0(variable_name, "_v"))
    
      nv_scenario3 <- extract_variable(rds_file = rds_files[5] , 
                            variable_name = variable_name) + 
      extract_variable(rds_file =  rds_files[5], 
                       variable_name = paste0(variable_name, "_v"))
    
    v_scenario3 <- extract_variable(rds_file = rds_files[6] , 
                             variable_name = variable_name) + 
      extract_variable(rds_file =  rds_files[6], 
                       variable_name = paste0(variable_name, "_v"))
    
    
    
    averted_inc_scenario1 <- get_averted(nv_output = nv_scenario1,
                                   v_output = v_scenario1,
                                   t_begin = t_begin,
                                   t_end = t_end,
                                   output_type = "proportion")
    
    averted_inc_scenario2 <- get_averted(nv_output = nv_scenario2,
                                   v_output = v_scenario2,
                                   t_begin = t_begin,
                                   t_end = t_end,
                                   output_type = "proportion")
    
    averted_inc_scenario3 <- get_averted(nv_output = nv_scenario3,
                                   v_output = v_scenario3,
                                   t_begin = t_begin,
                                   t_end = t_end,
                                   output_type = "proportion")
    
    
    df_scenario1 <- as.data.frame(averted_inc_scenario1)
    df_scenario2 <- as.data.frame(averted_inc_scenario2)
    df_scenario3 <- as.data.frame(averted_inc_scenario3)
    
    
    
  # Determine y-axis settings for this figure
    if (i == 1 ) {  # Example: The second figure requires different limits
      y_limits <- custom_y_limits1
      y_breaks <- custom_y_breaks1
      
    } else if (i == 2) {
      y_limits <- custom_y_limits2
      y_breaks <- custom_y_breaks2
      
    } else if (i == 3) {
      y_limits <- custom_y_limits3
      y_breaks <- custom_y_breaks3
      
    }  else if (i == 4) {
      y_limits <- custom_y_limits4
      y_breaks <- custom_y_breaks4
    }

    
    result <- get_plot_averted(df_scenario1 = df_scenario1, 
                               df_scenario2 = df_scenario2, 
                               df_scenario3 = df_scenario3, 
                                     y_limits = y_limits, y_breaks = y_breaks )
    
    averted_plot <- result$plot
    plot_list[[i]] <- averted_plot
    
    ## save estimates presented in the figure
    
    summary_list[[i]] <- result$summary
    
  }
  
  


## remove legend in each of the figure
  plot_list_wo_legend <- list()
  
  for (i in seq_along(plot_list)){
    plot_list_wo_legend[[i]] <- plot_list[[i]] + theme(legend.position = "none")
  }  
  
## extrct the legend  
legend_plot <- get_legend(averted_plot)  

# Create the grid of plots without individual x and y labels
plot_wo_labels <- plot_grid(
  plotlist = plot_list_wo_legend,
  nrow = 2,
  ncol = 2,
  align = "hv",
  axis = "tblr",
  labels = c("(a)", "(b)", "(c)", "(d)"),  # Add subfigure labels
  label_size = 40,                        # Adjust label size
  label_x = 0.03,                         # Adjust horizontal position of labels
  label_y = 1.08                          # Adjust vertical position of labels
)

plot_with_labels <- ggdraw() +
  draw_plot(plot_wo_labels, x = 0, y = 0, width = 1, height = 1) +   
  draw_label(y_lab, x = 0.01, y = 0.5, angle = 90, size = 45, fontface = "bold") +  # Y-axis label
  draw_label("Age at vaccination (year)", x = 0.5, y = 0.025, angle = 0, size = 45, fontface = "bold")           # X-axis label

# make grid of plots  
final_plot_with_legend <- plot_grid(
  legend_plot,
  plot_with_labels,
  nrow = 2, 
  rel_heights = c(0.1,1)  
)

return(final_plot_with_legend)
  
}  



### Inputs

## List all the datasets that we want to plot together
set_of_rds_files <- list(
  c("pri_sec_neq_detailed_a7_sero_dom_denv1_vcov_0.8_baseline_yes_nsamp_100_waning_0.rds", 
    "pri_sec_neq_detailed_a7_sero_dom_denv1_vcov_0.8_baseline_no_nsamp_100_waning_0.rds",
    
    "pri_sec_eq_detailed_a7_sero_dom_denv1_vcov_0.8_baseline_yes_nsamp_100_waning_0.rds",
    "pri_sec_eq_detailed_a7_sero_dom_denv1_vcov_0.8_baseline_no_nsamp_100_waning_0.rds",
    
    "pri_sec_neq_eq_hosp_detailed_a7_sero_dom_denv1_vcov_0.8_baseline_yes_nsamp_100_waning_0.rds",
    "pri_sec_neq_eq_hosp_detailed_a7_sero_dom_denv1_vcov_0.8_baseline_no_nsamp_100_waning_0.rds"), # set 1
  
  
    c("pri_sec_neq_detailed_a7_sero_dom_denv2_vcov_0.8_baseline_yes_nsamp_100_waning_0.rds", 
    "pri_sec_neq_detailed_a7_sero_dom_denv2_vcov_0.8_baseline_no_nsamp_100_waning_0.rds",
    
    "pri_sec_eq_detailed_a7_sero_dom_denv2_vcov_0.8_baseline_yes_nsamp_100_waning_0.rds",
    "pri_sec_eq_detailed_a7_sero_dom_denv2_vcov_0.8_baseline_no_nsamp_100_waning_0.rds",
    
    "pri_sec_neq_eq_hosp_detailed_a7_sero_dom_denv2_vcov_0.8_baseline_yes_nsamp_100_waning_0.rds",
    "pri_sec_neq_eq_hosp_detailed_a7_sero_dom_denv2_vcov_0.8_baseline_no_nsamp_100_waning_0.rds"), #set 2
  
  
    c("pri_sec_neq_detailed_a7_sero_dom_denv3_vcov_0.8_baseline_yes_nsamp_100_waning_0.rds", 
    "pri_sec_neq_detailed_a7_sero_dom_denv3_vcov_0.8_baseline_no_nsamp_100_waning_0.rds",
    
    "pri_sec_eq_detailed_a7_sero_dom_denv3_vcov_0.8_baseline_yes_nsamp_100_waning_0.rds",
    "pri_sec_eq_detailed_a7_sero_dom_denv3_vcov_0.8_baseline_no_nsamp_100_waning_0.rds",
    
    "pri_sec_neq_eq_hosp_detailed_a7_sero_dom_denv3_vcov_0.8_baseline_yes_nsamp_100_waning_0.rds",
    "pri_sec_neq_eq_hosp_detailed_a7_sero_dom_denv3_vcov_0.8_baseline_no_nsamp_100_waning_0.rds"), #set 3
  
  
    c("pri_sec_neq_detailed_a7_sero_dom_denv4_vcov_0.8_baseline_yes_nsamp_100_waning_0.rds", 
    "pri_sec_neq_detailed_a7_sero_dom_denv4_vcov_0.8_baseline_no_nsamp_100_waning_0.rds",
    
    "pri_sec_eq_detailed_a7_sero_dom_denv4_vcov_0.8_baseline_yes_nsamp_100_waning_0.rds",
    "pri_sec_eq_detailed_a7_sero_dom_denv4_vcov_0.8_baseline_no_nsamp_100_waning_0.rds",
    
    "pri_sec_neq_eq_hosp_detailed_a7_sero_dom_denv4_vcov_0.8_baseline_yes_nsamp_100_waning_0.rds",
    "pri_sec_neq_eq_hosp_detailed_a7_sero_dom_denv4_vcov_0.8_baseline_no_nsamp_100_waning_0.rds") #set 4
    
 
)

## grab the start of vaccination year from one of the dataset
t_begin = readRDS(here::here("model_output",set_of_rds_files[[1]][1]) )$v_year 

custom_y_limits1 <- c(0, 15)
custom_y_breaks1 <- seq(0, 15, by = 3)


custom_y_limits2 <- c(0, 15)
custom_y_breaks2 <- seq(0, 15, by = 3)

# Custom y-axis settings for a specific figure (for negative impact)(change it accordingly)
custom_y_limits3 <- c(0, 15)
custom_y_breaks3 <- seq(0, 15, by = 3)

custom_y_limits4 <- c(-30, 15)
custom_y_breaks4 <- seq(-30, 15, by = 5)


## Generate figure now
plot_impact_hosp_dominating_sero <- get_arranged_plot_avert_percent(set_of_rds_files = set_of_rds_files,
                                                       variable_name = "symp_sample_age",
                                                       y_lab = "Reported cases averted (%)", 
                                                       t_begin = t_begin,
                                                       t_end = t_begin + 9)

figure_name <- "sensitivity_reporting_rate_symp.jpg"

# ## save
ggsave(
  filename = file.path(here("figure"), figure_name),  # Combine folder path and file name
  plot = plot_impact_hosp_dominating_sero,                                            # The plot object to save
  width = 29*2,                                           # Width in inches
  height = 40,                                          # Height in inches
  dpi = 300,
  units = "cm")                                  # DPI (resolution)





```


## sensitivity on reporting rate for hospitalizations
```{r}

## aggregate over all the age groups
get_agg_over_age <- function(arr) {
  arr_agg_age <- apply(arr, c(1,2,4), sum)
  return(arr_agg_age)
}

## cumulative number over year
get_cumulative_over_time <- function(arr, t_begin, t_end) {
  arr_cum_time <- apply(arr[, , t_begin:t_end], c(1, 2), sum)
  return(arr_cum_time)
}

## calculate the averted 
get_averted <- function(nv_output, v_output, t_begin, t_end, output_type){
  
  nv_agg_age <- get_agg_over_age(nv_output)
  v_agg_age <-  get_agg_over_age(v_output)
  
  nv_cum_t <- get_cumulative_over_time( nv_agg_age, t_begin = t_begin, t_end = t_end)
  v_cum_t <- get_cumulative_over_time( v_agg_age, t_begin = t_begin, t_end = t_end)
  
  if (output_type == "absolute") {
    
    averted <- (nv_cum_t - v_cum_t)
  }
  
  if (output_type == "proportion") {
    
    averted <- 100*(nv_cum_t - v_cum_t)/nv_cum_t
  }
  
  return(averted)
}


## extract variable from .rds file
extract_variable <- function(rds_file, variable_name) {
  
  result <- readRDS(here::here("model_output",  rds_file) )
  
  out_v <- as.data.frame(result$output, stringsAsFactors = FALSE)
  
  n_vac_age = result$n_vac_age
  n_sample = result$n_sample
  n_age = result$n_age
  n_year = result$n_year
  
  x <- out_v[,colnames(out_v) == variable_name] 
  
  y <- array(NA, dim = c(n_vac_age,n_sample, n_age, n_year))
  
  for (i in 1:n_vac_age) {
    
    y[i,,,] <- x[[paste0("result.", i)]]
  }
  
  return(y)
}

## make single figure
get_plot_averted <- function(df_scenario1, df_scenario2, df_scenario3, y_limits, y_breaks) {
  
  # Add a column for age groups
  df_scenario1$age <- 1:nrow(df_scenario1)
  df_scenario2$age <- 1:nrow(df_scenario2)
  df_scenario3$age <- 1:nrow(df_scenario3)
  
  # Reshape the dataframes to long format
  df_scenario1_long <- gather(df_scenario1, key = "Realization", value = "Output", -age)
  df_scenario2_long <- gather(df_scenario2, key = "Realization", value = "Output", -age)
  df_scenario3_long <- gather(df_scenario3, key = "Realization", value = "Output", -age)
  
  # Add a column to indicate the vaccine coverage for each dataset
  df_scenario1_long$assumption <- "Assumption 1"
  df_scenario2_long$assumption <- "Assumption 2"
  df_scenario3_long$assumption <- "Assumption 3"
  
  # Combine all datasets into one long dataframe
  df_long <- bind_rows(df_scenario1_long, df_scenario2_long, df_scenario3_long)
  
  # Calculate the mean and 95% confidence interval for each age group and vaccine coverage
  summary_df <- df_long %>%
    group_by(age, assumption ) %>%
    summarise(
      mean_output =  quantile(Output, 0.5), #mean(Output),
      lower_bound = quantile(Output, 0.025),
      upper_bound = quantile(Output, 0.975)
    ) %>%
    ungroup()

  # 
  
  # Define colors for different vaccine coverages
  assumption_colors <- c("Assumption 1" = "#fb8072", "Assumption 2" = "#80b1d3", "Assumption 3" = "#fdb462")
  
  # Define the dodge position for side-by-side plotting
  dodge <- position_dodge(width = 0.3)
  
  # Plot using ggplot2
  p <- ggplot(summary_df, aes(x = factor(age), y = mean_output, color = assumption)) +
    geom_point(size = 9, position = dodge, shape = 15) +  # Points for the mean with dodge
    geom_errorbar(aes(ymin = lower_bound, ymax = upper_bound), 
                  width = 0.0, size = 1.8, position = dodge) +  # Error bars with dodge
    scale_color_manual(values = assumption_colors, name = "") + 
    scale_x_discrete(
      breaks = c(1, 2, 3, 4, 5, 6, 7),   # Set the positions of the x-axis ticks
      labels = c("6-16", "17-30", "31-40", "41-50", "51-60", "61-70", "71-80")  # Labels for age groups
    ) +
    # labs(x = "Age at vaccination", y = ylab, color = NULL) +  # Labels for x and y axes
    scale_y_continuous(limits = y_limits, breaks = y_breaks) +  # Define y-axis tick points )+
    theme_bw() +  # Clean theme
    theme(
      axis.ticks.length = unit(0.4, "cm"),        # Increase the length of the ticks
      axis.ticks = element_line(size = 1.5),      # Increase the thickness of the ticks
      panel.border = element_rect(color = "black", size = 2),  # Thicker border
      plot.margin = margin(t=10, r=10, b=10, l=10),
      axis.text.x = element_text(size = 35, color="black", angle= 30, margin = margin(t = 10, b = 10)),
      axis.text.y = element_text(size = 35,color="black", margin = margin(r = 10, l = 30)),
      # axis.title = element_text(size = 35, color = "black"),
      axis.title = element_blank(),
      legend.position = "top",
      legend.direction = "horizontal",
      legend.text = element_text(size = 40),
      legend.key.size = unit(2, "cm"),  # Increase size of legend keys
      legend.key.height = unit(1.5, "cm"),  # Increase height of legend keys
      legend.key.width = unit(2.5, "cm"),  # Increase width of legend keys
      legend.background = element_blank()
    )
  
  return(list(plot = p, summary = summary_df))
  
}


get_arranged_plot_avert_percent <- function(set_of_rds_files, variable_name, y_lab, t_begin, t_end) {
  
  plot_list <- list()
  summary_list <- list()

  for (i in seq_along(set_of_rds_files)) {
    
    rds_files <- set_of_rds_files[[i]]
    
    nv_scenario1 <- extract_variable(rds_file = rds_files[1] , 
                            variable_name = variable_name) + 
      extract_variable(rds_file =  rds_files[1], 
                       variable_name = paste0(variable_name, "_v"))
    
    v_scenario1 <- extract_variable(rds_file = rds_files[2] , 
                             variable_name = variable_name) + 
      extract_variable(rds_file =  rds_files[2], 
                       variable_name = paste0(variable_name, "_v"))
    
    
      nv_scenario2 <- extract_variable(rds_file = rds_files[3] , 
                            variable_name = variable_name) + 
      extract_variable(rds_file =  rds_files[3], 
                       variable_name = paste0(variable_name, "_v"))
    
    v_scenario2 <- extract_variable(rds_file = rds_files[4] , 
                             variable_name = variable_name) + 
      extract_variable(rds_file =  rds_files[4], 
                       variable_name = paste0(variable_name, "_v"))
    
      nv_scenario3 <- extract_variable(rds_file = rds_files[5] , 
                            variable_name = variable_name) + 
      extract_variable(rds_file =  rds_files[5], 
                       variable_name = paste0(variable_name, "_v"))
    
    v_scenario3 <- extract_variable(rds_file = rds_files[6] , 
                             variable_name = variable_name) + 
      extract_variable(rds_file =  rds_files[6], 
                       variable_name = paste0(variable_name, "_v"))
    
    
    
    averted_inc_scenario1 <- get_averted(nv_output = nv_scenario1,
                                   v_output = v_scenario1,
                                   t_begin = t_begin,
                                   t_end = t_end,
                                   output_type = "proportion")
    
    averted_inc_scenario2 <- get_averted(nv_output = nv_scenario2,
                                   v_output = v_scenario2,
                                   t_begin = t_begin,
                                   t_end = t_end,
                                   output_type = "proportion")
    
    averted_inc_scenario3 <- get_averted(nv_output = nv_scenario3,
                                   v_output = v_scenario3,
                                   t_begin = t_begin,
                                   t_end = t_end,
                                   output_type = "proportion")
    
    
    df_scenario1 <- as.data.frame(averted_inc_scenario1)
    df_scenario2 <- as.data.frame(averted_inc_scenario2)
    df_scenario3 <- as.data.frame(averted_inc_scenario3)
    
    
    
  # Determine y-axis settings for this figure
    if (i == 1 ) {  # Example: The second figure requires different limits
      y_limits <- custom_y_limits1
      y_breaks <- custom_y_breaks1
      
    } else if (i == 2) {
      y_limits <- custom_y_limits2
      y_breaks <- custom_y_breaks2
      
    } else if (i == 3) {
      y_limits <- custom_y_limits3
      y_breaks <- custom_y_breaks3
      
    }  else if (i == 4) {
      y_limits <- custom_y_limits4
      y_breaks <- custom_y_breaks4
    }

    
    result <- get_plot_averted(df_scenario1 = df_scenario1, 
                               df_scenario2 = df_scenario2, 
                               df_scenario3 = df_scenario3, 
                                     y_limits = y_limits, y_breaks = y_breaks )
    
    averted_plot <- result$plot
    plot_list[[i]] <- averted_plot
    
    ## save estimates presented in the figure
    
    summary_list[[i]] <- result$summary
    
  }
  
  


## remove legend in each of the figure
  plot_list_wo_legend <- list()
  
  for (i in seq_along(plot_list)){
    plot_list_wo_legend[[i]] <- plot_list[[i]] + theme(legend.position = "none")
  }  
  
## extrct the legend  
legend_plot <- get_legend(averted_plot)  

# Create the grid of plots without individual x and y labels
plot_wo_labels <- plot_grid(
  plotlist = plot_list_wo_legend,
  nrow = 2,
  ncol = 2,
  align = "hv",
  axis = "tblr",
  labels = c("(a)", "(b)", "(c)", "(d)"),  # Add subfigure labels
  label_size = 40,                        # Adjust label size
  label_x = 0.03,                         # Adjust horizontal position of labels
  label_y = 1.08                          # Adjust vertical position of labels
)

plot_with_labels <- ggdraw() +
  draw_plot(plot_wo_labels, x = 0, y = 0, width = 1, height = 1) +   
  draw_label(y_lab, x = 0.01, y = 0.5, angle = 90, size = 45, fontface = "bold") +  # Y-axis label
  draw_label("Age at vaccination (year)", x = 0.5, y = 0.025, angle = 0, size = 45, fontface = "bold")           # X-axis label

# make grid of plots  
final_plot_with_legend <- plot_grid(
  legend_plot,
  plot_with_labels,
  nrow = 2, 
  rel_heights = c(0.1,1)  
)

return(final_plot_with_legend)
  
}  



### Inputs

## List all the datasets that we want to plot together
set_of_rds_files <- list(
  c("pri_sec_neq_detailed_a7_sero_dom_denv1_vcov_0.8_baseline_yes_nsamp_100_waning_0.rds", 
    "pri_sec_neq_detailed_a7_sero_dom_denv1_vcov_0.8_baseline_no_nsamp_100_waning_0.rds",
    
    "pri_sec_eq_detailed_a7_sero_dom_denv1_vcov_0.8_baseline_yes_nsamp_100_waning_0.rds",
    "pri_sec_eq_detailed_a7_sero_dom_denv1_vcov_0.8_baseline_no_nsamp_100_waning_0.rds",
    
    "pri_sec_neq_eq_hosp_detailed_a7_sero_dom_denv1_vcov_0.8_baseline_yes_nsamp_100_waning_0.rds",
    "pri_sec_neq_eq_hosp_detailed_a7_sero_dom_denv1_vcov_0.8_baseline_no_nsamp_100_waning_0.rds"), # set 1
  
  
    c("pri_sec_neq_detailed_a7_sero_dom_denv2_vcov_0.8_baseline_yes_nsamp_100_waning_0.rds", 
    "pri_sec_neq_detailed_a7_sero_dom_denv2_vcov_0.8_baseline_no_nsamp_100_waning_0.rds",
    
    "pri_sec_eq_detailed_a7_sero_dom_denv2_vcov_0.8_baseline_yes_nsamp_100_waning_0.rds",
    "pri_sec_eq_detailed_a7_sero_dom_denv2_vcov_0.8_baseline_no_nsamp_100_waning_0.rds",
    
    "pri_sec_neq_eq_hosp_detailed_a7_sero_dom_denv2_vcov_0.8_baseline_yes_nsamp_100_waning_0.rds",
    "pri_sec_neq_eq_hosp_detailed_a7_sero_dom_denv2_vcov_0.8_baseline_no_nsamp_100_waning_0.rds"), #set 2
  
  
    c("pri_sec_neq_detailed_a7_sero_dom_denv3_vcov_0.8_baseline_yes_nsamp_100_waning_0.rds", 
    "pri_sec_neq_detailed_a7_sero_dom_denv3_vcov_0.8_baseline_no_nsamp_100_waning_0.rds",
    
    "pri_sec_eq_detailed_a7_sero_dom_denv3_vcov_0.8_baseline_yes_nsamp_100_waning_0.rds",
    "pri_sec_eq_detailed_a7_sero_dom_denv3_vcov_0.8_baseline_no_nsamp_100_waning_0.rds",
    
    "pri_sec_neq_eq_hosp_detailed_a7_sero_dom_denv3_vcov_0.8_baseline_yes_nsamp_100_waning_0.rds",
    "pri_sec_neq_eq_hosp_detailed_a7_sero_dom_denv3_vcov_0.8_baseline_no_nsamp_100_waning_0.rds"), #set 3
  
  
    c("pri_sec_neq_detailed_a7_sero_dom_denv4_vcov_0.8_baseline_yes_nsamp_100_waning_0.rds", 
    "pri_sec_neq_detailed_a7_sero_dom_denv4_vcov_0.8_baseline_no_nsamp_100_waning_0.rds",
    
    "pri_sec_eq_detailed_a7_sero_dom_denv4_vcov_0.8_baseline_yes_nsamp_100_waning_0.rds",
    "pri_sec_eq_detailed_a7_sero_dom_denv4_vcov_0.8_baseline_no_nsamp_100_waning_0.rds",
    
    "pri_sec_neq_eq_hosp_detailed_a7_sero_dom_denv4_vcov_0.8_baseline_yes_nsamp_100_waning_0.rds",
    "pri_sec_neq_eq_hosp_detailed_a7_sero_dom_denv4_vcov_0.8_baseline_no_nsamp_100_waning_0.rds") #set 4
    
 
)

## grab the start of vaccination year from one of the dataset
t_begin = readRDS(here::here("model_output",set_of_rds_files[[1]][1]) )$v_year 

custom_y_limits1 <- c(0, 17)
custom_y_breaks1 <- seq(0, 15, by = 3)


custom_y_limits2 <- c(0, 17)
custom_y_breaks2 <- seq(0, 15, by = 3)

# Custom y-axis settings for a specific figure (for negative impact)(change it accordingly)
custom_y_limits3 <- c(-15, 17)
custom_y_breaks3 <- seq(-15, 15, by = 5)

custom_y_limits4 <- c(-20, 17)
custom_y_breaks4 <- seq(-20, 15, by = 5)



## Generate figure now
plot_impact_hosp_dominating_sero <- get_arranged_plot_avert_percent(set_of_rds_files = set_of_rds_files,
                                                       variable_name = "hosp_sample_age",
                                                       y_lab = "Hospitalizations averted (%)", 
                                                       t_begin = t_begin,
                                                       t_end = t_begin + 9)

figure_name <- "sensitivity_reporting_rate_hosp.jpg"

# ## save
ggsave(
  filename = file.path(here("figure"), figure_name),  # Combine folder path and file name
  plot = plot_impact_hosp_dominating_sero,                                            # The plot object to save
  width = 29*2,                                           # Width in inches
  height = 40,                                          # Height in inches
  dpi = 300,
  units = "cm")                                  # DPI (resolution)

```


### VE efficacy estimate plot
```{r}
source(here("utils","utils_vac_efficacy.R"))

# call function to grab the data from excel
excel_efficacy = read_xlsx( here("data","qdenga_efficacy.xlsx"), 
                            sheet = "cumulative_54" )

# grab serotype stratified VE estimates
df_efficacy <- get_raw_ve_from_trial(excel_efficacy = excel_efficacy)

# Make sure factor levels are ordered correctly
df_plot <- df_efficacy %>%
  mutate(
    group1 = factor(group1, levels = c("DENV1", "DENV2", "DENV3", "DENV4"),
                            labels = c("DENV-1", "DENV-2", "DENV-3", "DENV-4")),
    group2 = factor(group2, levels = c("Sero+", "Sero-")),
    group3 = factor(group3, levels = c("VCD", "Hospitalized"))
  )
# Create the plot with facet_wrap
p <- ggplot(df_plot, aes(x = group1,  y = ve, color = group3)) +
  geom_point(show.legend = FALSE, size = 9) +
  geom_errorbar(aes(ymin = ve_low, ymax = ve_up),
                width = 0.2,
                size = 1.8,
                show.legend = FALSE) +
  geom_hline(yintercept = 0, linetype = "dashed", color = "black") +
  facet_wrap(~ group3 + group2, ncol = 2,  scales = "free_y") +
  scale_color_manual(values = c("VCD" = "#E74C3C", "Hospitalized" = "#00BFC4")) +
  xlab("Serotype") +
  ylab("Vaccine efficacy") +
  theme_bw() +
  # coord_fixed(ratio = 1) +  # Adjust aspect ratio as needed
  theme(
    axis.ticks.length = unit(0.4, "cm"),        # Increase the length of the ticks
    axis.ticks = element_line(size = 1.5),      # Increase the thickness of the ticks
    panel.border = element_rect(color = "black", size = 2),  # Thicker border
    # plot.title = element_text(hjust = 0.5, face = "bold", size = 16),
    axis.text = element_text(size = 40,  color = "black"),
    axis.title.x = element_text(size = 45, face = "bold",  color = "black"),
    axis.title.y = element_text(size = 45, face = "bold",  color = "black"),
    strip.text = element_text(size = 40,   color = "black"),
    strip.background = element_rect(fill = "gray90", color = "black", size = 2)  # <-- border for strip

  )


figure_name <- "cumulative_ve_estimates_from_trial.jpg"

# ## save
ggsave(
  filename = file.path(here("figure"), figure_name),  # Combine folder path and file name
  plot = p,                                            # The plot object to save
  width = 28*2,                                           # Width in inches
  height = 40,                                          # Height in inches
  dpi = 300,
  units = "cm")                                  # DPI (resolution)

 
```

## Model fititing associated diagnostics
## Plot the trace plot
```{r}
posterior_chain = readRDS(here("fitting/fitting_output","posterior_rep_rate.rds"))

# make it data frame
df_chain = data.frame(posterior_chain)
# Sample parameter labels as expressions
param_labels <- c(
  "rho_2_a1" = "rho[2]^'0-4y'",
  "rho_2_a2" = "rho[2]^'5-14y'",
  "rho_2_a3" = "rho[2]^'15-24y'",
  "rho_2_a4" = "rho[2]^'25-34y'",
  "rho_2_a5" = "rho[2]^'35-44y'",
  "rho_2_a6" = "rho[2]^'45-54y'",
  "rho_2_a7" = "rho[2]^'55-64y'",
  "rho_2_a8" = "rho[2]^'65+y'"
)

# Add iteration index
df_chain <- df_chain %>%
  mutate(iteration = row_number())

# Reshape to long format
df_long <- df_chain %>%
  pivot_longer(cols = starts_with("rho_2_a"),
               names_to = "parameter", values_to = "value")

# Assign expression labels
df_long <- df_long %>%
  mutate(
    parameter_label = factor(param_labels[parameter], levels = param_labels)
  )

# Trace plot with expression parsing
p <- ggplot(df_long, aes(x = iteration, y = value)) +
  geom_line(color = "black", linewidth = 0.6) +
  facet_wrap(~ parameter_label, ncol = 2, scales = "free_y", labeller = label_parsed) +
  labs(x = "Iteration", y = "Parameter value") +
  theme_bw() +
  theme(
     axis.ticks.length = unit(0.4, "cm"),        # Increase the length of the ticks
    axis.ticks = element_line(size = 1.5),      # Increase the thickness of the ticks
    panel.border = element_rect(color = "black", size = 2),  # Thicker border
    # plot.title = element_text(hjust = 0.5, face = "bold", size = 16),
    axis.text = element_text(size = 40,  color = "black"),
    axis.title.x = element_text(size = 45, face = "bold",  color = "black"),
    axis.title.y = element_text(size = 45, face = "bold",  color = "black"),
    strip.text = element_text(size = 30,   color = "black"),
    strip.background = element_rect(fill = "gray90", color = "black", size = 2)  # <-- border for strip

  )

figure_name <- "trace_plot.jpg"

# ## save
ggsave(
  filename = file.path(here("figure"), figure_name),  # Combine folder path and file name
  plot = p,                                            # The plot object to save
  width = 28*2,                                           # Width in inches
  height = 40,                                          # Height in inches
  dpi = 300,
  units = "cm")   

```


## model fitting with data

```{r}
## model generated incidence from fitting
Sampled_posterior_state <- readRDS(here("fitting/fitting_output","state.rds"))

## read the reported incidence data (yearly)
data_reported_age_yearly = read_xlsx(here("data","serotype_share_age_cases.xlsx" ), sheet = "age_case_2014_20")

# select the incidence per 100k data
df_age_rep_inc <- select(data_reported_age_yearly, year,contains("_inc_") )
# 

# since it's an array first get all the rownames with the function rownames
row_names <- dimnames(Sampled_posterior_state)[[1]]

# Now extract the rows with incidence
inc_only_array <- Sampled_posterior_state[row_names[grepl("^inc[0-9]+", row_names)],,]

## average over time for each of the realizations
mean_inc <- apply(inc_only_array[, , 2:8], c(1, 2), mean)

# function to calculate quantiles
calculate_quantiles <- function(matrix_data, probs = c(0.05, 0.5, 0.95)) {
  apply(matrix_data, 1, quantile, probs = probs, na.rm = TRUE)
}

# incidence with median and 95% credible interval for each of the age groups
inc_with_uncertainty <- calculate_quantiles(mean_inc)

## before plotting arrange the data
df_long <- df_age_rep_inc %>%
  pivot_longer(
    cols = -year,
    names_to = "age_group",
    values_to = "incidence"
  ) %>%
  mutate(
    age_group = gsub("y_inc_p_100k", "", age_group)
  )

# Convert to data frame and add quantile as a column
df_model <- as.data.frame(t(inc_with_uncertainty))
colnames(df_model) <- c("q5", "q50", "q95")

age_levels <- c("0-4", "5-14", "15-24", "25-34", "35-44", "45-54", "55-64", "65+")

# Apply to both dataframes
df_model$age_group <- c("0-4", "5-14", "15-24", "25-34", "35-44", "45-54", "55-64", "65+")

df_long$age_group <- factor(df_long$age_group, levels = age_levels)
df_model$age_group <- factor(df_model$age_group, levels = age_levels)

df_long$source <- "Data (2014-2020)"
df_model$source <- "Model"


source_color <- c("Data (2014-2020)" = "gray60", "Model" = "#B22222")

p <- ggplot() +
    geom_line(data = df_long,
            aes(x = age_group, y = incidence, group = year, color = "Data (2014-2020)"),
            size = 3, alpha = 0.6) +

  # Model ribbon
  geom_ribbon(data = df_model,
              aes(x = age_group, ymin = q5, ymax = q95, fill = "Model", group = 1),
              alpha = 0.3, color = NA, show.legend = FALSE) +

  # Model median line
  geom_line(data = df_model,
            aes(x = age_group, y = q50, color = "Model", group = 1),
            size = 4) +
  labs(
    x = "Age group (year)",
    y = "Incidence of dengue cases \nper 100000 population",
    color = "source"
  ) +
  scale_color_manual(values = source_color, name = "") +
  scale_fill_manual(values = source_color, name = "") +
  scale_y_continuous(limits = c(0,800), breaks =  seq(0, 800, by = 100)) +  
  theme_bw() +
  theme(
    axis.ticks.length = unit(0.4, "cm"),        # Increase the length of the ticks
    axis.ticks = element_line(size = 1.5),      # Increase the thickness of the ticks
    panel.border = element_rect(color = "black", size = 4),  # Thicker border
    axis.text.x = element_text(size = 45, angle = 30, color = "black",  margin = margin(t = 30, b = 5)),
    axis.text.y = element_text(size = 45, angle = 0, color = "black",  margin = margin(l = 10, r = 10)),
    axis.title.x = element_text(size = 50,  face = "bold",  color = "black"),
    axis.title.y = element_text(size = 50, face = "bold",  color = "black"),
    legend.title = element_text(size = 50, face = "bold"),
    legend.text = element_text(size = 45, color = "black"),
    legend.key.size = unit(3, "cm"),
    legend.position = c(0.7, 0.70),
    legend.background = element_blank()


  )


figure_name <- "model_fitting.jpg"

# ## save
ggsave(
  filename = file.path(here("figure"), figure_name),  # Combine folder path and file name
  plot = p,                                            # The plot object to save
  width = 50,                                           # Width in inches
  height = 40,                                          # Height in inches
  dpi = 300,
  units = "cm")  

```



### Serotype share in dengue infecation (baseline scenario)
```{r}

extract_variable_sero <- function(rds_file, variable_name) {
  
  result <- readRDS(here::here("model_output",  rds_file) )
  
  out_v <- as.data.frame(result$output, stringsAsFactors = FALSE)
  
  
  
  n_sample = result$n_sample
  n_sero = result$n_sero
  n_year = result$n_year
  n_vac_age = result$n_vac_age
  
  x <- out_v[,colnames(out_v) == variable_name] 
  
  y <- array(NA, dim = c(n_vac_age,n_sample,n_sero, n_year))
  
  for (i in 1:n_vac_age) {
    
    y[i,,,] <- x[[paste0("result.", i)]]
  }
  
  return(y)
}


get_aggregated_sero_share_plot <- function(df_inf, t_begin, t_end){
  
  ## select only one scenario and one sample as the infection will remain same
  inf_sero_select <- df_inf[1,1,,t_begin:t_end]
  
  # Calculate the percentage of infection for each serotype
  # total_infection <- rowSums(inf_sero_select)
  percentage_vector <- 100*rowSums(inf_sero_select)/sum(inf_sero_select)
  
  serotypes <- paste("DENV", 1:4, sep = "-")
  
  df <- data.frame(
    serotype = serotypes,
    percentage = percentage_vector)
  # Plot stacked area plot using ggplot2 with improved aesthetics
  ggplot(df, aes(x = serotype, y = percentage, fill = serotype)) +
    geom_bar(stat = "identity", position = "stack", width = 0.8, alpha = 0.9) +  # Stacked bar plot
    # labs(title = "",
    #      x = "Serotype", y = "Percentage of infection") +
    # Manually defining colors for the four serotypes
    scale_fill_manual(values = c("DENV-1" = "#8da0cb",   # Tomato
                                 "DENV-2" = "#e78ac3",   # SteelBlue
                                 "DENV-3" = "#a6d854",   # LimeGreen
                                 "DENV-4" = "#ffd92f"),
                      name="") + # Gold
    scale_y_continuous(limits = y_limits, breaks = y_breaks) + 
    theme_bw() + # Classic theme for a clean look
    theme(
      axis.ticks.length = unit(0.4, "cm"),        # Increase the length of the ticks
      axis.ticks = element_line(size = 1.5),      # Increase the thickness of the ticks
      panel.border = element_rect(color = "black", size = 2),  # Thicker border
      plot.margin = margin(t = 40, r = 10, b = 10, l=40),
      axis.text.x = element_text(size = 35, color="black", angle= 30, margin = margin(t = 30, b = 10)),
      axis.text.y = element_text(size = 35,color="black", margin = margin(r = 10, l = 10)),
      # axis.title = element_text(size = 35, color = "black"),
      axis.title = element_blank(),
      legend.position = "top",
      legend.direction = "horizontal",
      legend.text = element_text(size = 40),
      legend.key.size = unit(2, "cm"),  # Increase size of legend keys
      legend.key.height = unit(1.5, "cm"),  # Increase height of legend keys
      legend.key.width = unit(2.5, "cm"),  # Increase width of legend keys
      legend.background = element_blank()
      
    )
  
}


get_arranged_plot_aggregated_sero_share <- function(set_of_rds_files, y_lab, t_begin, t_end) {
  
  plot_list <- list()
  
  for (i in seq_along(set_of_rds_files)) {
    
    rds_files <- set_of_rds_files[[i]]
    
    inf_sero <- extract_variable_sero(rds_file = rds_files, variable_name = "inf_sample_sero") +
      extract_variable_sero(rds_file = rds_files, variable_name = "inf_sample_sero_v") 
    
    
    aggregated_sero_share_plot <- get_aggregated_sero_share_plot(df_inf = inf_sero, t_begin = t_begin, t_end = t_end )
    
    plot_list[[i]] <-  aggregated_sero_share_plot
    
  }
  
  ## remove legend in each of the figure
  plot_list_wo_legend <- list()
  
  for (i in seq_along(plot_list)){
    plot_list_wo_legend[[i]] <- plot_list[[i]] + theme(legend.position = "none")
  }  
  
  ## extract the legend  
  legend_plot <- get_legend(aggregated_sero_share_plot)  
  
  # Create the grid of plots without individual x and y labels
  plot_wo_labels <- plot_grid(
    plotlist = plot_list_wo_legend,
    nrow = 2,
    ncol = 2,
    align = "hv",
    axis = "tblr",
    labels = c("(a)", "(b)", "(c)", "(d)"),  # Add subfigure labels
    label_size = 40,                        # Adjust label size
    label_x = 0.03,                         # Adjust horizontal position of labels
    label_y = 1.02                          # Adjust vertical position of labels
  )
  
  plot_with_labels <- ggdraw() +
    draw_plot(plot_wo_labels, x = 0, y = 0, width = 1, height = 1) +   
    draw_label(y_lab, x = 0.015, y = 0.55, angle = 90, size = 45, fontface = "bold") +  # Y-axis label
    draw_label("Serotype", x = 0.55, y = 0.025, angle = 0, size = 45, fontface = "bold")           # X-axis label
  
  # make grid of plots  
  # final_plot_with_legend <- plot_grid(
  #   legend_plot,
  #   plot_with_labels,
  #   nrow = 2, 
  #   rel_heights = c(0.12,1)  
  # )
  # # 
  # return(final_plot_with_legend)
  
  return(plot_with_labels)
  
}  


### Inputs

## List all the datasets that we want to plot together
set_of_rds_files <- list(
  "pri_sec_neq_detailed_a7_sero_dom_denv1_vcov_0.8_baseline_yes_nsamp_100_waning_0.rds", 
  "pri_sec_neq_detailed_a7_sero_dom_denv2_vcov_0.8_baseline_yes_nsamp_100_waning_0.rds", 
  "pri_sec_neq_detailed_a7_sero_dom_denv3_vcov_0.8_baseline_yes_nsamp_100_waning_0.rds", 
  "pri_sec_neq_detailed_a7_sero_dom_denv4_vcov_0.8_baseline_yes_nsamp_100_waning_0.rds"
  )   


## grab the start of vaccination year from one of the dataset
t_begin = readRDS(here::here("model_output",set_of_rds_files[[1]]) )$v_year 

y_limits <- c(0, 80)
y_breaks <- seq(0, 80, by = 20)
## Generate figure now
plot_aggregated_sero_share <- get_arranged_plot_aggregated_sero_share(set_of_rds_files = set_of_rds_files,
                                                                              y_lab = "Share of infection(%)",
                                                                              t_begin = t_begin,
                                                                              t_end = t_begin + 9)

# plot_aggregated_sero_share

figure_name <- "aggregated_sero_share_infection.jpg"




# # ### save
ggsave(
  filename = file.path(here("figure"), figure_name),  # Combine folder path and file name
  plot = plot_aggregated_sero_share,                                            # The plot object to save
  width = 20*2,                                           # Width in inches
  height = 40,                                          # Height in inches
  dpi = 300,
  units = "cm")                                  # DPI (resolution)

```

```{r}
source(here("utils","utils_sero_prevalence.R"))
# Read the data
data_sero <- read_xlsx( here("data","dengue_sero_prevalence_singapore.xlsx"),
                          sheet = "dengue_sero_p_2013_17" )

## select the sero_prevalence data
sero_year = 2013

# extract the data from the year 2013 
data_sero_year = data_sero[data_sero$`year` == sero_year,]

### calculating average age
age_str <- data_sero_year$age
# Function to extract numeric values from the age ranges
extract_numeric <- function(age_range) {
  # Split the string based on the "-"
  age_parts <- strsplit(age_range, "-|y")[[1]]
  
  if (length(age_parts) == 2) {
    return(as.numeric(age_parts))
  } else if (length(age_parts) == 1) {
    if (age_parts == "60+") {
      return(c(61,71))
    } }
}

# Apply the function to each element of the array
numeric_age <- sapply(age_str, extract_numeric)

avg_age <- array(NA, dim = dim(numeric_age)[2] )

for (i in 1:dim(numeric_age)[2]){
  avg_age[i] <- (1/2)*(numeric_age[,i][1]+numeric_age[,i][2]) + 0.5
}

## make dataframe for data
# Create dataframe for points
df_points <- data.frame(
  age = avg_age,
  value = data_sero_year$sero_p,
  type = "data"
)


### Now get the seroprevalence
get_sero <- get_sero_p(sero_year = sero_year )

# Assuming get_sero is your list containing se_p, pri, sec
age <- 0:90

# Create a tidy dataframe for ggplot
df_sero <- data.frame(
  age = age,
  se_p = 100*get_sero$se_p,
  pri = 100*get_sero$pri,
  sec = 100*get_sero$sec
) %>%
  pivot_longer(cols = c(se_p, pri, sec), names_to = "type", values_to = "value")


## combined dataframe
df_combined <- bind_rows(
  df_sero,
  df_points
)


p <- ggplot(df_combined, aes(x = age, y = value, color = type, linetype = type, shape = type)) +
  geom_line(data = filter(df_combined, type != "data"), size = 5) +   # smooth model lines
  geom_point(data = filter(df_combined, type == "data"), size = 12, stroke = 4) +  # data points
  scale_color_manual(
    values = c("se_p" = "red", "pri" = "lightseagreen", "sec" = "royalblue", "data" = "black"),
    labels = c("se_p" = "Seropositive", "pri" = "One exposure", "sec" = "Two or more exposures", "data" = "Seroprevalence data"),
    name = ""
  ) +
  scale_linetype_manual(
    values = c("se_p" = "solid", "pri" = "solid", "sec" = "solid", "data" = "blank"),
    labels = c("se_p" = "Seropositive", "pri" = "One exposure", "sec" = "Two or more exposures", "data" = "Seroprevalence data"),
    name = ""
  ) +
  scale_shape_manual(
    values = c("se_p" = NA, "pri" = NA, "sec" = NA, "data" = 1),  # 16 = solid circle
    labels = c("se_p" = "Seropositive", "pri" = "One exposure", "sec" = "Two or more exposures", "data" = "Seroprevalence data"),
    name = ""
  ) +
  labs(x = "Age", y = "Percentage of individuals", title = "") +
  scale_y_continuous(limits = c(0, 100), breaks = seq(0, 100, by = 20)) +  
  scale_x_continuous(limits = c(0, 90), breaks = seq(0, 90, by = 10)) +  
  theme_bw() +
  theme(
    axis.ticks.length = unit(0.4, "cm"),
    axis.ticks = element_line(size = 1.5),
    panel.border = element_rect(color = "black", size = 4),
    axis.text.x = element_text(size = 45, angle = 0, color = "black",  margin = margin(t = 10, b = 10)),
    axis.text.y = element_text(size = 45, angle = 0, color = "black",  margin = margin(l = 10, r = 10)),
    axis.title.x = element_text(size = 50,  face = "bold",  color = "black"),
    axis.title.y = element_text(size = 50, face = "bold",  color = "black"),
    legend.title = element_text(size = 50, face = "bold"),
    legend.text = element_text(size = 45, color = "black"),
    legend.key.size = unit(3, "cm"),
    legend.position = c(0.3, 0.85),
    legend.background = element_blank()
  )


figure_name <- "sero_prevalence.jpg"

# # ### save
ggsave(
  filename = file.path(here("figure"), figure_name),  # Combine folder path and file name
  plot = p,                                            # The plot object to save
  width = 29*2,                                           # Width in inches
  height = 40,                                          # Height in inches
  dpi = 300,
  units = "cm")                                  # DPI (resolution)


```

## Percentage of Cases averted stratified with baseline serostatus for alternative age brackets

```{r message=FALSE}
get_agg_over_age <- function(arr) {
  arr_agg_age <- apply(arr, c(1,2,4), sum)
  return(arr_agg_age)
}

## cumulative number over year
get_cumulative_over_time <- function(arr, t_begin, t_end) {
  arr_cum_time <- apply(arr[, , t_begin:t_end], c(1, 2), sum)
  return(arr_cum_time)
}


## extract variable from .rds file
extract_variable <- function(rds_file, variable_name) {
  
  result <- readRDS(here::here("model_output",  rds_file) )
  
  out_v <- as.data.frame(result$output, stringsAsFactors = FALSE)
  
  n_vac_age = result$n_vac_age
  n_sample = result$n_sample
  n_age = result$n_age
  n_year = result$n_year
  
  x <- out_v[,colnames(out_v) == variable_name] 
  
  y <- array(NA, dim = c(n_vac_age,n_sample, n_age, n_year))
  
  for (i in 1:n_vac_age) {
    
    y[i,,,] <- x[[paste0("result.", i)]]
  }
  
  return(y)
}


get_averted_serostatus <- function(nv_output, v_output, t_begin, t_end){
  
  nv_agg_age <- get_agg_over_age(nv_output)
  v_agg_age <-  get_agg_over_age(v_output)
  # total_vac_agg_age <- get_agg_over_age(total_vac_output)
  
  nv_cum_t <- get_cumulative_over_time( nv_agg_age, t_begin = t_begin, t_end = t_end)
  v_cum_t <- get_cumulative_over_time( v_agg_age, t_begin = t_begin, t_end = t_end)
  # total_vac_cum_t <- get_cumulative_over_time(total_vac_agg_age, t_begin = t_begin, t_end = t_end)
  
  averted_serostatus <- 100*(nv_cum_t - v_cum_t)/nv_cum_t
  
  
  return(averted_serostatus)
  
}



get_plot_averted_serostatus <- function(df_total, df_seroneg, df_seropos, y_limits, y_breaks) {
  
  
  # Add a column for age groups
  df_total$age <- 1:nrow(df_total)
  df_seroneg$age <- 1:nrow(df_seroneg)
  df_seropos$age <- 1:nrow(df_seropos)
  
  # Reshape the dataframes to long format
  df_total_long <- gather(df_total, key = "Realization", value = "Output", -age)
  df_seroneg_long <- gather(df_seroneg, key = "Realization", value = "Output", -age)
  df_seropos_long <- gather(df_seropos, key = "Realization", value = "Output", -age)
  
  # Add a column to indicate the vaccine coverage for each dataset
  df_total_long$poptype <- "All"
  df_seroneg_long$poptype <- "Seronegative"
  df_seropos_long$poptype <- "Seropositive"
  
  # Combine all datasets into one long dataframe
  df_long <- bind_rows(df_total_long, df_seroneg_long, df_seropos_long)
  
  # Calculate the mean and 95% confidence interval for each age group and vaccine coverage
  summary_df <- df_long %>%
    group_by(age, poptype) %>%
    summarise(
      mean_output = mean(Output),
      lower_bound = quantile(Output, 0.025),
      upper_bound = quantile(Output, 0.975)
    ) %>%
    ungroup()
  
  
  
  # Define colors for different vaccine coverages
  poptype_barcolors <- c("All" = "#8dd3c7", "Seronegative" = "#fdb462", "Seropositive" = "#b3de69")
  
  poptype_errorbar_colors <- c("All" = "#55a39b", "Seronegative" = "#e08d3e", "Seropositive" = "#85a84e")
  
  # Define the dodge position for side-by-side plotting
  dodge <- position_dodge(width = 0.3)
  
  # Plot using ggplot2
  p <- ggplot(summary_df, aes(x = factor(age), y = mean_output, fill = poptype)) +
    # geom_point(size = 9, position = dodge, shape = 16) +  # Points for the mean with dodge
    geom_bar(stat = "identity", position = position_dodge(width = 0.75), width = 0.65) +
    
    geom_errorbar(aes(ymin = lower_bound, ymax = upper_bound, color = poptype), 
                  width = 0.0, size = 1.8, position = position_dodge(width = 0.75)) +
    # geom_errorbar(aes(ymin = lower_bound, ymax = upper_bound), 
    #               width = 0.0, size = 1.8, position = dodge) +  # Error bars with dodge
    scale_fill_manual(values = poptype_barcolors, name = "") + # Custom colors for bars
    scale_color_manual(values = poptype_errorbar_colors,  name = "") + # Custom colors for error bars
    # scale_color_manual(values = poptype_colors, name = "") + 
    scale_x_discrete(
      breaks = c(1, 2, 3, 4, 5, 6, 7),   # Set the positions of the x-axis ticks
      labels = c("6-16", "17-30", "31-60", "30+", "40+", "50+", "60+")  # Labels for age groups
    ) +
    # labs(x = "Age at vaccination", y = ylab, color = NULL) +  # Labels for x and y axes
    scale_y_continuous(limits = y_limits, breaks = y_breaks) +  # Define y-axis tick points )+
    theme_bw() +  # Clean theme
    theme(
      axis.ticks.length = unit(0.4, "cm"),        # Increase the length of the ticks
      axis.ticks = element_line(size = 1.5),      # Increase the thickness of the ticks
      panel.border = element_rect(color = "black", size = 2),  # Thicker border
      plot.margin = margin(t=10, r=10, b=20, l=25),
      axis.text.x = element_text(size = 35, color="black", angle= 30, margin = margin(t = 10, b = 20)),
      axis.text.y = element_text(size = 35,color="black", margin = margin(r = 10, l = 30)),
      # axis.title = element_text(size = 35, color = "black"),
      axis.title = element_blank(),
      legend.position = "top",
      legend.direction = "horizontal",
      legend.text = element_text(size = 40),
      legend.key.size = unit(2, "cm"),  # Increase size of legend keys
      legend.key.height = unit(1.5, "cm"),  # Increase height of legend keys
      legend.key.width = unit(2.5, "cm"),  # Increase width of legend keys
      legend.background = element_blank()
    )
  
   return(list(plot = p, summary = summary_df))
  
}


get_arranged_plot_averted_serostatus <- function(set_of_rds_files, variable_name, y_lab, t_begin, t_end) {
  
  plot_list <- list()
  summary_list <- list()
  
  for (i in seq_along(set_of_rds_files)) {
    
    rds_files <- set_of_rds_files[[i]]
    
    ## for total population
    nv_total <- extract_variable(rds_file = rds_files[1] , 
                            variable_name = variable_name) + 
      extract_variable(rds_file =  rds_files[1], 
                       variable_name = paste0(variable_name, "_v"))
    
    
    v_total <- extract_variable(rds_file = rds_files[2] , 
                                 variable_name = variable_name) + 
      extract_variable(rds_file =  rds_files[2], 
                       variable_name = paste0(variable_name, "_v"))
    
    ## seronegative
    nv_seroneg <- extract_variable(rds_file = rds_files[1] , 
                                 variable_name = paste0(variable_name, "_primary")) + 
      extract_variable(rds_file =  rds_files[1], 
                       variable_name = paste0(variable_name, "_v_primary"))
    
    
    v_seroneg <- extract_variable(rds_file = rds_files[2] , 
                                variable_name = paste0(variable_name, "_primary")) + 
      extract_variable(rds_file =  rds_files[2], 
                       variable_name = paste0(variable_name, "_v_primary"))
    
    ## seropositive
    nv_seropos <- extract_variable(rds_file = rds_files[1] , 
                                   variable_name = paste0(variable_name, "_secondary")) + 
      extract_variable(rds_file =  rds_files[1], 
                       variable_name = paste0(variable_name, "_v_secondary"))
    
    
    v_seropos <- extract_variable(rds_file = rds_files[2] , 
                                  variable_name = paste0(variable_name, "_secondary")) + 
      extract_variable(rds_file =  rds_files[2], 
                       variable_name = paste0(variable_name, "_v_secondary"))
    
    
    averted_serostatus_total <- get_averted_serostatus(nv_output = nv_total,
                                                 v_output = v_total,
                                                 t_begin = t_begin,
                                                 t_end = t_end)
    
    averted_serostatus_seroneg <- get_averted_serostatus(nv_output = nv_seroneg,
                                                   v_output = v_seroneg,
                                                   t_begin = t_begin,
                                                   t_end = t_end)
    
    averted_serostatus_seropos <- get_averted_serostatus(nv_output = nv_seropos,
                                                   v_output = v_seropos,
                                                   t_begin = t_begin,
                                                   t_end = t_end)
    
    df_averted_serostatus_total <- as.data.frame(averted_serostatus_total)
    
    df_averted_serostatus_seroneg <- as.data.frame(averted_serostatus_seroneg)
    
    df_averted_serostatus_seropos <- as.data.frame(averted_serostatus_seropos)
    
    
    
    
    # Determine y-axis settings for this figure
    if (i == 1 ) {  # Example: The second figure requires different limits
      y_limits <- custom_y_limits1
      y_breaks <- custom_y_breaks1
      
    } else if (i == 2) {
      y_limits <- custom_y_limits2
      y_breaks <- custom_y_breaks2
      
    } else if (i == 3) {
      y_limits <- custom_y_limits3
      y_breaks <- custom_y_breaks3
      
    }  else if (i == 4) {
      y_limits <- custom_y_limits4
      y_breaks <- custom_y_breaks4
    }
    
    
  
    result <- get_plot_averted_serostatus(
      df_total = df_averted_serostatus_total,
      df_seroneg = df_averted_serostatus_seroneg,
      df_seropos = df_averted_serostatus_seropos,
      y_limits = y_limits,
      y_breaks = y_breaks)
   
    averted_plot_serostatus <- result$plot
    
    plot_list[[i]] <-  averted_plot_serostatus
    summary_list[[i]] <- result$summary
    
  }
  
  
## store the estimates in a file for future reference
  names(summary_list) <- c("DENV1", "DENV2", "DENV3", "DENV4")
  combined_summary <- dplyr::bind_rows(summary_list, .id = "Sero")
  ## saving upto 3 decimal place
  combined_summary <- combined_summary %>%
  dplyr::mutate(
    mean_output = round(mean_output, 3),
    lower_bound = round(lower_bound, 3),
    upper_bound = round(upper_bound, 3)
  )
  # write.table(combined_summary,
  #           file = here::here("output_estimate_figure", "percent_symp_averted_serop_seron.txt"),
  #           sep = "\t",
  #           row.names = FALSE,
  #           quote = FALSE)
  
  
  
  ## remove legend in each of the figure
  plot_list_wo_legend <- list()
  
  for (i in seq_along(plot_list)) {
    plot_list_wo_legend[[i]] <- plot_list[[i]] + theme(legend.position = "none")
  }  
  
  ## extrct the legend  
  legend_plot <- get_legend(averted_plot_serostatus)  
  
  # Create the grid of plots without individual x and y labels
  plot_wo_labels <- plot_grid(
    plotlist = plot_list_wo_legend,
    nrow = 2,
    ncol = 2,
    align = "hv",
    axis = "tblr",
    labels = c("(a)", "(b)", "(c)", "(d)"),  # Add subfigure labels
    label_size = 40,                        # Adjust label size
    label_x = 0.03,                         # Adjust horizontal position of labels
    label_y = 1.08                          # Adjust vertical position of labels
  )
  
  plot_with_labels <- ggdraw() +
    draw_plot(plot_wo_labels, x = 0, y = 0, width = 1, height = 1) +   
    draw_label(y_lab, x = 0.01, y = 0.55, angle = 90, size = 45, fontface = "bold") +  # Y-axis label
    draw_label("Age at vaccination (year)", x = 0.5, y = 0.025, angle = 0, size = 45, fontface = "bold")           # X-axis label
  
  # make grid of plots  
  final_plot_with_legend <- plot_grid(
    legend_plot,
    plot_with_labels,
    nrow = 2, 
    rel_heights = c(0.1,1)  
  )
  
  return(final_plot_with_legend)
  
}  



### Inputs


## List all the datasets that we want to plot together
set_of_rds_files <- list(
  c("pri_sec_neq_detailed_a7_alter_sero_dom_denv1_vcov_0.8_baseline_yes_nsamp_100_waning_0_prescrng_0.rds",
    "pri_sec_neq_detailed_a7_alter_sero_dom_denv1_vcov_0.8_baseline_no_nsamp_100_waning_0_prescrng_0.rds"),  # Set 1

  c("pri_sec_neq_detailed_a7_alter_sero_dom_denv2_vcov_0.8_baseline_yes_nsamp_100_waning_0_prescrng_0.rds",
    "pri_sec_neq_detailed_a7_alter_sero_dom_denv2_vcov_0.8_baseline_no_nsamp_100_waning_0_prescrng_0.rds"),  # Set 2

  c("pri_sec_neq_detailed_a7_alter_sero_dom_denv3_vcov_0.8_baseline_yes_nsamp_100_waning_0_prescrng_0.rds",
    "pri_sec_neq_detailed_a7_alter_sero_dom_denv3_vcov_0.8_baseline_no_nsamp_100_waning_0_prescrng_0.rds"),  # Set 3

  c("pri_sec_neq_detailed_a7_alter_sero_dom_denv4_vcov_0.8_baseline_yes_nsamp_100_waning_0_prescrng_0.rds",
    "pri_sec_neq_detailed_a7_alter_sero_dom_denv4_vcov_0.8_baseline_no_nsamp_100_waning_0_prescrng_0.rds")    # Set 4
)


## grab the start of vaccination year from one of the dataset
t_begin = readRDS(here::here("model_output",set_of_rds_files[[1]][1]) )$v_year 

custom_y_limits1 <- c(0, 45)
custom_y_breaks1 <- seq(0, 45, by = 15)


custom_y_limits2 <- c(0, 45)
custom_y_breaks2 <- seq(0, 45, by = 15)

# Custom y-axis settings for a specific figure (for negative impact)(change it accordingly)
custom_y_limits3 <- c(-15, 45)
custom_y_breaks3 <- seq(-15, 45, by = 15)

custom_y_limits4 <- c(-150, 60)
custom_y_breaks4 <- seq(-150, 60, by = 30)

## Generate figure now
plot_impact <- get_arranged_plot_averted_serostatus(set_of_rds_files = set_of_rds_files,
                                                                    variable_name = "symp_sample_age",
                                                                    y_lab = "Reported cases averted (%)",
                                                                    t_begin = t_begin,
                                                                    t_end = t_begin + 9)

figure_name <- "percent_symp_averted_serop_seron_alternative_age_bracket.jpg"

## save
ggsave(
  filename = file.path(here("figure"), figure_name),  # Combine folder path and file name
  plot = plot_impact,                                            # The plot object to save
  width = 29*2,                                           # Width in inches
  height = 40,                                          # Height in inches
  dpi = 300,
  units = "cm")                                  # DPI (resolution)


```




## Percentage of Hospitalizations averted stratified with baseline serostatus for alternative age bracket 
```{r}
get_agg_over_age <- function(arr) {
  arr_agg_age <- apply(arr, c(1,2,4), sum)
  return(arr_agg_age)
}

## cumulative number over year
get_cumulative_over_time <- function(arr, t_begin, t_end) {
  arr_cum_time <- apply(arr[, , t_begin:t_end], c(1, 2), sum)
  return(arr_cum_time)
}


## extract variable from .rds file
extract_variable <- function(rds_file, variable_name) {
  
  result <- readRDS(here::here("model_output",  rds_file) )
  
  out_v <- as.data.frame(result$output, stringsAsFactors = FALSE)
  
  n_vac_age = result$n_vac_age
  n_sample = result$n_sample
  n_age = result$n_age
  n_year = result$n_year
  
  x <- out_v[,colnames(out_v) == variable_name] 
  
  y <- array(NA, dim = c(n_vac_age,n_sample, n_age, n_year))
  
  for (i in 1:n_vac_age) {
    
    y[i,,,] <- x[[paste0("result.", i)]]
  }
  
  return(y)
}


get_averted_serostatus <- function(nv_output, v_output, t_begin, t_end){
  
  nv_agg_age <- get_agg_over_age(nv_output)
  v_agg_age <-  get_agg_over_age(v_output)
  
  nv_cum_t <- get_cumulative_over_time( nv_agg_age, t_begin = t_begin, t_end = t_end)
  v_cum_t <- get_cumulative_over_time( v_agg_age, t_begin = t_begin, t_end = t_end)
  
  averted_serostatus <- 100*(nv_cum_t - v_cum_t)/nv_cum_t
  
  
  return(averted_serostatus)
  
}



get_plot_averted_serostatus <- function(df_total, df_seroneg, df_seropos, y_limits, y_breaks) {
  
  
  # Add a column for age groups
  df_total$age <- 1:nrow(df_total)
  df_seroneg$age <- 1:nrow(df_seroneg)
  df_seropos$age <- 1:nrow(df_seropos)
  
  # Reshape the dataframes to long format
  df_total_long <- gather(df_total, key = "Realization", value = "Output", -age)
  df_seroneg_long <- gather(df_seroneg, key = "Realization", value = "Output", -age)
  df_seropos_long <- gather(df_seropos, key = "Realization", value = "Output", -age)
  
  # Add a column to indicate the vaccine coverage for each dataset
  df_total_long$poptype <- "All"
  df_seroneg_long$poptype <- "Seronegative"
  df_seropos_long$poptype <- "Seropositive"
  
  # Combine all datasets into one long dataframe
  df_long <- bind_rows(df_total_long, df_seroneg_long, df_seropos_long)
  
  # Calculate the mean and 95% confidence interval for each age group and vaccine coverage
  summary_df <- df_long %>%
    group_by(age, poptype) %>%
    summarise(
      mean_output = mean(Output),
      lower_bound = quantile(Output, 0.025),
      upper_bound = quantile(Output, 0.975)
    ) %>%
    ungroup()
  
  # Define colors for different vaccine coverages
  poptype_barcolors <- c("All" = "#8dd3c7", "Seronegative" = "#fdb462", "Seropositive" = "#b3de69")
  
  poptype_errorbar_colors <- c("All" = "#55a39b", "Seronegative" = "#e08d3e", "Seropositive" = "#85a84e")
  

  # 
  # Define the dodge position for side-by-side plotting
  dodge <- position_dodge(width = 0.3)
  
  # Plot using ggplot2
  p <- ggplot(summary_df, aes(x = factor(age), y = mean_output, fill = poptype)) +
    # geom_point(size = 9, position = dodge, shape = 16) +  # Points for the mean with dodge
    geom_bar(stat = "identity", position = position_dodge(width = 0.75), width = 0.65) +
    
    geom_errorbar(aes(ymin = lower_bound, ymax = upper_bound, color = poptype), 
                  width = 0.0, size = 1.8, position = position_dodge(width = 0.75)) +
    scale_fill_manual(values = poptype_barcolors, name = "") + # Custom colors for bars
    scale_color_manual(values = poptype_errorbar_colors,  name = "") + # Custom colors for error bars
    scale_x_discrete(
      breaks = c(1, 2, 3, 4, 5, 6, 7),   # Set the positions of the x-axis ticks
      labels = c("6-16", "17-30", "31-60", "30+", "40+", "50+", "60+")   # Labels for age groups
    ) +
    scale_y_continuous(limits = y_limits, breaks = y_breaks) +  # Define y-axis tick points )+
    theme_bw() +  # Clean theme
    theme(
      axis.ticks.length = unit(0.4, "cm"),        # Increase the length of the ticks
      axis.ticks = element_line(size = 1.5),      # Increase the thickness of the ticks
      panel.border = element_rect(color = "black", size = 2),  # Thicker border
      plot.margin = margin(t=10, r=10, b=20, l=25),
      axis.text.x = element_text(size = 35, color="black", angle= 30, margin = margin(t = 10, b = 20)),
      axis.text.y = element_text(size = 35,color="black", margin = margin(r = 10, l = 30)),
      axis.title = element_blank(),
      legend.position = "top",
      legend.direction = "horizontal",
      legend.text = element_text(size = 40),
      legend.key.size = unit(2, "cm"),  # Increase size of legend keys
      legend.key.height = unit(1.5, "cm"),  # Increase height of legend keys
      legend.key.width = unit(2.5, "cm"),  # Increase width of legend keys
      legend.background = element_blank()
    )
  
   return(list(plot = p, summary = summary_df))
  
}


get_arranged_plot_averted_serostatus <- function(set_of_rds_files, variable_name, y_lab, t_begin, t_end) {
  
  plot_list <- list()
  summary_list <- list()
  
  for (i in seq_along(set_of_rds_files)) {
    
    rds_files <- set_of_rds_files[[i]]
    
    ## for total population
    nv_total <- extract_variable(rds_file = rds_files[1] , 
                            variable_name = variable_name) + 
      extract_variable(rds_file =  rds_files[1], 
                       variable_name = paste0(variable_name, "_v"))
    
    
    v_total <- extract_variable(rds_file = rds_files[2] , 
                                 variable_name = variable_name) + 
      extract_variable(rds_file =  rds_files[2], 
                       variable_name = paste0(variable_name, "_v"))
    
    ## seronegative
    nv_seroneg <- extract_variable(rds_file = rds_files[1] , 
                                 variable_name = paste0(variable_name, "_primary")) + 
      extract_variable(rds_file =  rds_files[1], 
                       variable_name = paste0(variable_name, "_v_primary"))
    
    
    v_seroneg <- extract_variable(rds_file = rds_files[2] , 
                                variable_name = paste0(variable_name, "_primary")) + 
      extract_variable(rds_file =  rds_files[2], 
                       variable_name = paste0(variable_name, "_v_primary"))
    
    ## seropositive
    nv_seropos <- extract_variable(rds_file = rds_files[1] , 
                                   variable_name = paste0(variable_name, "_secondary")) + 
      extract_variable(rds_file =  rds_files[1], 
                       variable_name = paste0(variable_name, "_v_secondary"))
    
    
    v_seropos <- extract_variable(rds_file = rds_files[2] , 
                                  variable_name = paste0(variable_name, "_secondary")) + 
      extract_variable(rds_file =  rds_files[2], 
                       variable_name = paste0(variable_name, "_v_secondary"))
    
    
    averted_serostatus_total <- get_averted_serostatus(nv_output = nv_total,
                                                 v_output = v_total,
                                                 t_begin = t_begin,
                                                 t_end = t_end)
    
    averted_serostatus_seroneg <- get_averted_serostatus(nv_output = nv_seroneg,
                                                   v_output = v_seroneg,
                                                   t_begin = t_begin,
                                                   t_end = t_end)
    
    averted_serostatus_seropos <- get_averted_serostatus(nv_output = nv_seropos,
                                                   v_output = v_seropos,
                                                   t_begin = t_begin,
                                                   t_end = t_end)
    
    df_averted_serostatus_total <- as.data.frame(averted_serostatus_total)
    
    df_averted_serostatus_seroneg <- as.data.frame(averted_serostatus_seroneg)
    
    df_averted_serostatus_seropos <- as.data.frame(averted_serostatus_seropos)
    
    # Determine y-axis settings for this figure
    if (i == 1 ) {  # Example: The second figure requires different limits
      y_limits <- custom_y_limits1
      y_breaks <- custom_y_breaks1
      
    } else if (i == 2) {
      y_limits <- custom_y_limits2
      y_breaks <- custom_y_breaks2
      
    } else if (i == 3) {
      y_limits <- custom_y_limits3
      y_breaks <- custom_y_breaks3
      
    }  else if (i == 4) {
      y_limits <- custom_y_limits4
      y_breaks <- custom_y_breaks4
    }
    
    
  
    result <- get_plot_averted_serostatus(
      df_total = df_averted_serostatus_total,
      df_seroneg = df_averted_serostatus_seroneg,
      df_seropos = df_averted_serostatus_seropos,
      y_limits = y_limits,
      y_breaks = y_breaks)
   
    averted_plot_serostatus <- result$plot
    
    plot_list[[i]] <-  averted_plot_serostatus
    summary_list[[i]] <- result$summary
    
  }
  
  
    ## store the estimates in a file for future reference
  names(summary_list) <- c("DENV1", "DENV2", "DENV3", "DENV4")
  combined_summary <- dplyr::bind_rows(summary_list, .id = "Sero")
  ## saving upto 3 decimal place
  combined_summary <- combined_summary %>%
  dplyr::mutate(
    mean_output = round(mean_output, 3),
    lower_bound = round(lower_bound, 3),
    upper_bound = round(upper_bound, 3)
  )
  # write.table(combined_summary,
  #           file = here::here("output_estimate_figure", "percent_hosp_averted_serop_seron.txt"),
  #           sep = "\t",
  #           row.names = FALSE,
  #           quote = FALSE)
  # 
  
  
  ## remove legend in each of the figure
  plot_list_wo_legend <- list()
  
  for (i in seq_along(plot_list)) {
    plot_list_wo_legend[[i]] <- plot_list[[i]] + theme(legend.position = "none")
  }  
  
  ## extrct the legend  
  legend_plot <- get_legend(averted_plot_serostatus)  
  
  # Create the grid of plots without individual x and y labels
  plot_wo_labels <- plot_grid(
    plotlist = plot_list_wo_legend,
    nrow = 2,
    ncol = 2,
    align = "hv",
    axis = "tblr",
    labels = c("(a)", "(b)", "(c)", "(d)"),  # Add subfigure labels
    label_size = 40,                        # Adjust label size
    label_x = 0.03,                         # Adjust horizontal position of labels
    label_y = 1.08                          # Adjust vertical position of labels
  )
  
  plot_with_labels <- ggdraw() +
    draw_plot(plot_wo_labels, x = 0, y = 0, width = 1, height = 1) +   
    draw_label(y_lab, x = 0.01, y = 0.55, angle = 90, size = 45, fontface = "bold") +  # Y-axis label
    draw_label("Age at vaccination (year)", x = 0.5, y = 0.025, angle = 0, size = 45, fontface = "bold")           # X-axis label
  
  # make grid of plots  
  final_plot_with_legend <- plot_grid(
    legend_plot,
    plot_with_labels,
    nrow = 2, 
    rel_heights = c(0.1,1)  
  )
  
  return(final_plot_with_legend)
  
}  



### Inputs

## List all the datasets that we want to plot together
set_of_rds_files <- list(
  c("pri_sec_neq_detailed_a7_alter_sero_dom_denv1_vcov_0.8_baseline_yes_nsamp_100_waning_0_prescrng_0.rds",
    "pri_sec_neq_detailed_a7_alter_sero_dom_denv1_vcov_0.8_baseline_no_nsamp_100_waning_0_prescrng_0.rds"),  # Set 1

  c("pri_sec_neq_detailed_a7_alter_sero_dom_denv2_vcov_0.8_baseline_yes_nsamp_100_waning_0_prescrng_0.rds",
    "pri_sec_neq_detailed_a7_alter_sero_dom_denv2_vcov_0.8_baseline_no_nsamp_100_waning_0_prescrng_0.rds"),  # Set 2

  c("pri_sec_neq_detailed_a7_alter_sero_dom_denv3_vcov_0.8_baseline_yes_nsamp_100_waning_0_prescrng_0.rds",
    "pri_sec_neq_detailed_a7_alter_sero_dom_denv3_vcov_0.8_baseline_no_nsamp_100_waning_0_prescrng_0.rds"),  # Set 3

  c("pri_sec_neq_detailed_a7_alter_sero_dom_denv4_vcov_0.8_baseline_yes_nsamp_100_waning_0_prescrng_0.rds",
    "pri_sec_neq_detailed_a7_alter_sero_dom_denv4_vcov_0.8_baseline_no_nsamp_100_waning_0_prescrng_0.rds")    # Set 4
)


## grab the start of vaccination year from one of the dataset
t_begin = readRDS(here::here("model_output",set_of_rds_files[[1]][1]) )$v_year 

custom_y_limits1 <- c(0, 60)
custom_y_breaks1 <- seq(0, 60, by = 15)


custom_y_limits2 <- c(0, 60)
custom_y_breaks2 <- seq(0, 60, by = 15)

# Custom y-axis settings for a specific figure (for negative impact)(change it accordingly)
custom_y_limits3 <- c(-101, 60)
custom_y_breaks3 <- seq(-90, 60, by = 30)

custom_y_limits4 <- c(-140, 60)
custom_y_breaks4 <- seq(-120, 60, by = 30)

## Generate figure now
plot_impact <- get_arranged_plot_averted_serostatus(set_of_rds_files = set_of_rds_files,
                                                                    variable_name = "hosp_sample_age",
                                                                    y_lab = "Hospitalizations averted (%)",
                                                                    t_begin = t_begin,
                                                                    t_end = t_begin + 9)

figure_name <- "percent_hosp_averted_serop_seron_alternative_age_bracket.jpg"

## save
ggsave(
  filename = file.path(here("figure"), figure_name),  # Combine folder path and file name
  plot = plot_impact,                                            # The plot object to save
  width = 29*2,                                           # Width in inches
  height = 40,                                          # Height in inches
  dpi = 300,
  units = "cm")                                  # DPI (resolution)


```



#### number of vaccine used for 10 years program
```{r message=FALSE}

get_agg_over_age <- function(arr) {
  arr_agg_age <- apply(arr, c(1,2,4), sum)
  return(arr_agg_age)
}

## cumulative number over year
get_cumulative_over_time <- function(arr, t_begin, t_end) {
  arr_cum_time <- apply(arr[, , t_begin:t_end], c(1, 2), sum)
  return(arr_cum_time)
}


## extract variable from .rds file
extract_variable <- function(rds_file, variable_name) {
  
  result <- readRDS(here::here("model_output",  rds_file) )
  
  out_v <- as.data.frame(result$output, stringsAsFactors = FALSE)
  
  n_vac_age = result$n_vac_age
  n_sample = result$n_sample
  n_age = result$n_age
  n_year = result$n_year
  
  x <- out_v[,colnames(out_v) == variable_name] 
  
  y <- array(NA, dim = c(n_vac_age,n_sample, n_age, n_year))
  
  for (i in 1:n_vac_age) {
    
    y[i,,,] <- x[[paste0("result.", i)]]
  }
  
  return(y)
}


get_plot_total_vaccination <- function(rds_files, y_lab, t_begin, t_end) {
  
    
  total_vaccinated <- extract_variable(rds_file = rds_files[2], 
                                 variable_name = "new_vac_sample_age") 
    
    
  total_vac_agg_age <- get_agg_over_age(total_vaccinated)

  total_vac_cum_t <- (1/1000000)*get_cumulative_over_time(total_vac_agg_age, 
                                                         t_begin = t_begin, 
                                                         t_end = t_end)
    
  df_total_vac_cum_t<- as.data.frame(total_vac_cum_t)
  df_total_vac_cum_t$age <- 1:nrow( df_total_vac_cum_t)
  # Reshape the dataframes to long format
  df_long <- gather( df_total_vac_cum_t, key = "Realization", value = "Output", -age)
    # df_long <- bind_rows(df_total_long)
  
  # Calculate the mean and 95% confidence interval for each age group and vaccine coverage
  summary_df <- df_long %>%
    group_by(age) %>%
    summarise(
      mean_output = mean(Output),
      lower_bound = quantile(Output, 0.025),
      upper_bound = quantile(Output, 0.975)
    ) %>%
    ungroup()

  
  # Define the dodge position for side-by-side plotting
  # dodge <- position_dodge(width = 0.3)
  
  # Plot using ggplot2
  p <- ggplot(summary_df, aes(x = factor(age), y = mean_output)) +
    # geom_point(size = 9, position = dodge, shape = 16) +  # Points for the mean with dodge
    geom_bar(stat = "identity", position = position_dodge(width = 0.75), width = 0.65, fill="steelblue") +
    
    # geom_errorbar(aes(ymin = lower_bound, ymax = upper_bound), 
    #               width = 0.0, size = 1.8, position = position_dodge(width = 0.75)) +
    # 
    scale_x_discrete(
      breaks = c(1, 2, 3, 4, 5, 6, 7),   # Set the positions of the x-axis ticks
      labels = c("6-16", "17-30", "31-60", "30+", "40+", "50+", "60+")  # Labels for age groups
    ) +
    labs(x = "Age at vaccination (year)", y = y_lab) +  # Labels for x and y axes
    scale_y_continuous(limits = y_limits, breaks = y_breaks) +  # Define y-axis tick points )+
    theme_bw() +  # Clean theme
    theme(
      axis.ticks.length = unit(0.4, "cm"),        # Increase the length of the ticks
      axis.ticks = element_line(size = 1.5),      # Increase the thickness of the ticks
      panel.border = element_rect(color = "black", size = 4),  # Thicker border
      plot.margin = margin(t=10, r=10, b=20, l=25),
      axis.text.x = element_text(size = 45, color="black",  angle= 0, margin = margin(t = 10, b = 20)),
      axis.text.y = element_text(size = 45,color="black", margin = margin(r = 10, l = 30)),
      axis.title.x = element_text(size = 50, color = "black", face="bold"),
      axis.title.y = element_text(size = 50, color = "black", face="bold")
      # # axis.title = element_blank(size = 35, color = "black"),
      # legend.position = "top",
      # legend.direction = "horizontal",
      # legend.text = element_text(size = 40),
      # legend.key.size = unit(2, "cm"),  # Increase size of legend keys
      # legend.key.height = unit(1.5, "cm"),  # Increase height of legend keys
      # legend.key.width = unit(2.5, "cm")  # Increase width of legend keys
      # # legend.background = element_text(size = 35, color = "black")
    )
                                 # DPI (resolution)
    return(p)
}

### Inputs


## List all the datasets that we want to plot together
set_of_rds_files <- list(
  c("pri_sec_neq_detailed_a7_alter_sero_dom_denv1_vcov_0.8_baseline_yes_nsamp_100_waning_0_prescrng_0.rds",
    "pri_sec_neq_detailed_a7_alter_sero_dom_denv1_vcov_0.8_baseline_no_nsamp_100_waning_0_prescrng_0.rds"),  # Set 1

  c("pri_sec_neq_detailed_a7_alter_sero_dom_denv2_vcov_0.8_baseline_yes_nsamp_100_waning_0_prescrng_0.rds",
    "pri_sec_neq_detailed_a7_alter_sero_dom_denv2_vcov_0.8_baseline_no_nsamp_100_waning_0_prescrng_0.rds"),  # Set 2

  c("pri_sec_neq_detailed_a7_alter_sero_dom_denv3_vcov_0.8_baseline_yes_nsamp_100_waning_0_prescrng_0.rds",
    "pri_sec_neq_detailed_a7_alter_sero_dom_denv3_vcov_0.8_baseline_no_nsamp_100_waning_0_prescrng_0.rds"),  # Set 3

  c("pri_sec_neq_detailed_a7_alter_sero_dom_denv4_vcov_0.8_baseline_yes_nsamp_100_waning_0_prescrng_0.rds",
    "pri_sec_neq_detailed_a7_alter_sero_dom_denv4_vcov_0.8_baseline_no_nsamp_100_waning_0_prescrng_0.rds")    # Set 4
)


## grab the start of vaccination year from one of the dataset
t_begin = readRDS(here::here("model_output",set_of_rds_files[[1]][1]) )$v_year 


y_limits <- c(0, 3)
y_breaks <- seq(0, 3, by = 1)


## Generate figure now
plot_total_vaccine <- get_plot_total_vaccination(rds_files = set_of_rds_files[[1]],
                                          y_lab = "Total vaccinations (in million)",
                                          t_begin = t_begin,
                                          t_end = t_begin + 9)

# figure_name <- "total_vaccination.jpg"

# ## save

ggsave(
  filename = file.path(here("figure"),"total_vaccination.jpg"),  # Combine folder path and file name
  plot = plot_total_vaccine,                                            # The plot object to save
  width = 29*2,                                           # Width in inches
  height = 40,                                          # Height in inches
  dpi = 300,
  units = "cm") 
```



### Percentage of cases averted  With vs without efficacy against infection (with lower bound zero for seronegative)
```{r}
get_agg_over_age <- function(arr) {
  arr_agg_age <- apply(arr, c(1,2,4), sum)
  return(arr_agg_age)
}

## cumulative number over year
get_cumulative_over_time <- function(arr, t_begin, t_end) {
  arr_cum_time <- apply(arr[, , t_begin:t_end], c(1, 2), sum)
  return(arr_cum_time)
}


## extract variable from .rds file
extract_variable <- function(rds_file, variable_name) {
  
  result <- readRDS(here::here("model_output",  rds_file) )
  
  out_v <- as.data.frame(result$output, stringsAsFactors = FALSE)
  
  n_vac_age = result$n_vac_age
  n_sample = result$n_sample
  n_age = result$n_age
  n_year = result$n_year
  
  x <- out_v[,colnames(out_v) == variable_name] 
  
  y <- array(NA, dim = c(n_vac_age,n_sample, n_age, n_year))
  
  for (i in 1:n_vac_age) {
    
    y[i,,,] <- x[[paste0("result.", i)]]
  }
  
  return(y)
}


get_averted_effi_inf <- function(nv_output, v_output, t_begin, t_end){
  
  nv_agg_age <- get_agg_over_age(nv_output)
  v_agg_age <-  get_agg_over_age(v_output)
  
  
  nv_cum_t <- get_cumulative_over_time( nv_agg_age, t_begin = t_begin, t_end = t_end)
  v_cum_t <- get_cumulative_over_time( v_agg_age, t_begin = t_begin, t_end = t_end)
  
  averted_effi_inf <- 100*(nv_cum_t - v_cum_t)/nv_cum_t 
  
  
  
  return(averted_effi_inf)
  
}


get_plot_averted_with_without_effi_inf <- function(df_with_effi_inf, df_without_effi_inf, y_limits, y_breaks) {
  
  
  # Add a column for age groups
  df_with_effi_inf$age <- 1:nrow(df_with_effi_inf)
  df_without_effi_inf$age <- 1:nrow(df_without_effi_inf)
  
  
  # Reshape the dataframes to long format
  df_with_effi_inf_long <- gather(df_with_effi_inf, key = "Realization", value = "Output", -age)
  df_without_effi_inf_long <- gather(df_without_effi_inf, key = "Realization", value = "Output", -age)
  
  
  # Add a column to indicate the vaccine coverage for each dataset
  df_with_effi_inf_long$efficacy_type <- "With efficacy against infection"
  df_without_effi_inf_long$efficacy_type <- "Without efficacy against infection"
  
  # Combine all datasets into one long dataframe
  df_long <- bind_rows(df_with_effi_inf_long, df_without_effi_inf_long)
  
  # Calculate the mean and 95% confidence interval for each age group and vaccine coverage
  summary_df <- df_long %>%
    group_by(age, efficacy_type) %>%
    summarise(
      mean_output = mean(Output),
      lower_bound = quantile(Output, 0.025),
      upper_bound = quantile(Output, 0.975)
    ) %>%
    ungroup()
  

  # Define colors for different vaccine coverages
  efficacy_type_barcolors <- c("With efficacy against infection" = "#fb8072", "Without efficacy against infection" = "#80b1d3")
  efficacy_type_errorbar_colors <- c("With efficacy against infection" = "#cc5045", "Without efficacy against infection" = "#40759a")
  # Define the dodge position for side-by-side plotting
  dodge <- position_dodge(width = 0.5)
  
  # Plot using ggplot2
  p <- ggplot(summary_df, aes(x = factor(age), y = mean_output, fill = efficacy_type)) +
    # geom_point(size = 9, position = dodge, shape = 16) +  # Points for the mean with dodge
    geom_bar(stat = "identity", position = position_dodge(width = 0.75), width = 0.65) +
    
    geom_errorbar(aes(ymin = lower_bound, ymax = upper_bound, color = efficacy_type), 
                  width = 0.0, size = 1.8, position = position_dodge(width = 0.75)) +
    # geom_errorbar(aes(ymin = lower_bound, ymax = upper_bound), 
    #               width = 0.0, size = 1.8, position = dodge) +  # Error bars with dodge
    scale_fill_manual(values = efficacy_type_barcolors, name = "") + # Custom colors for bars
    scale_color_manual(values = efficacy_type_errorbar_colors,  name = "") + # Custom colors for error bars
    # scale_color_manual(values = poptype_colors, name = "") + 
    scale_x_discrete(
      breaks = c(1, 2, 3, 4, 5, 6, 7),   # Set the positions of the x-axis ticks
      labels = c("6-16", "17-30", "31-40", "41-50", "51-60", "61-70", "71-80")  # Labels for age groups
    ) +
    # labs(x = "Age at vaccination", y = ylab, color = NULL) +  # Labels for x and y axes
    scale_y_continuous(limits = y_limits, breaks = y_breaks) +  # Define y-axis tick points )+
    theme_bw() +  # Clean theme
    theme(
      axis.ticks.length = unit(0.4, "cm"),        # Increase the length of the ticks
      axis.ticks = element_line(size = 1.5),      # Increase the thickness of the ticks
      panel.border = element_rect(color = "black", size = 2),  # Thicker border
      plot.margin = margin(t=10, r=10, b=20, l=25),
      axis.text.x = element_text(size = 35, color="black", angle= 30, margin = margin(t = 10, b = 20)),
      axis.text.y = element_text(size = 35,color="black", margin = margin(r = 10, l = 30)),
      # axis.title = element_text(size = 35, color = "black"),
      axis.title = element_blank(),
      legend.position = "top",
      legend.direction = "horizontal",
      legend.text = element_text(size = 40),
      legend.key.size = unit(2, "cm"),  # Increase size of legend keys
      legend.key.height = unit(1.5, "cm"),  # Increase height of legend keys
      legend.key.width = unit(2.5, "cm"),  # Increase width of legend keys
      legend.background = element_blank()
    )
  
     return(list(plot = p, summary = summary_df))
  
}



get_arranged_plot_averted_with_without_effi_inf <- function(set_of_rds_files, variable_name, y_lab, t_begin, t_end) {
  
  summary_list <- list()
  plot_list <- list()
  
  for (i in seq_along(set_of_rds_files)) {
    
    rds_files <- set_of_rds_files[[i]]
    
    ## for total population
    nv_with_effi_inf  <- extract_variable(rds_file = rds_files[1] , 
                                 variable_name = variable_name) + 
      extract_variable(rds_file =  rds_files[1], 
                       variable_name = paste0(variable_name, "_v"))
    
    v_with_effi_inf <- extract_variable(rds_file = rds_files[2] , 
                                        variable_name = variable_name) + 
      extract_variable(rds_file =  rds_files[2], 
                       variable_name = paste0(variable_name, "_v"))
    
    
    
    
    nv_without_effi_inf <- extract_variable(rds_file = rds_files[3] , 
                                variable_name = variable_name) + 
      extract_variable(rds_file =  rds_files[3], 
                       variable_name = paste0(variable_name, "_v"))
    
    v_without_effi_inf <- extract_variable(rds_file = rds_files[4] , 
                                        variable_name = variable_name) + 
      extract_variable(rds_file =  rds_files[4], 
                       variable_name = paste0(variable_name, "_v"))
    

   
    averted_with_effi_inf <- get_averted_effi_inf(nv_output = nv_with_effi_inf,
                                                 v_output = v_with_effi_inf,
                                                 t_begin = t_begin,
                                                 t_end = t_end)
    
    averted_without_effi_inf <- get_averted_effi_inf(nv_output = nv_without_effi_inf,
                                                   v_output = v_without_effi_inf,
                                                   t_begin = t_begin,
                                                   t_end = t_end)

    df_averted_with_effi_inf <- as.data.frame(averted_with_effi_inf)
    
    df_averted_without_effi_inf <- as.data.frame(averted_without_effi_inf)
    
  
    
    
    # Determine y-axis settings for this figure
    if (i == 1 ) {  # Example: The second figure requires different limits
      y_limits <- custom_y_limits1
      y_breaks <- custom_y_breaks1
      
    } else if (i == 2) {
      y_limits <- custom_y_limits2
      y_breaks <- custom_y_breaks2
      
    }else if (i == 3) {
      y_limits <- custom_y_limits3
      y_breaks <- custom_y_breaks3
      
    }else if (i == 4) {
      y_limits <- custom_y_limits4
      y_breaks <- custom_y_breaks4
      
    }
    
    
    result <- get_plot_averted_with_without_effi_inf(
      df_with_effi_inf =  df_averted_with_effi_inf,
      df_without_effi_inf = df_averted_without_effi_inf,
      y_limits = y_limits,
      y_breaks = y_breaks)
    
    averted_plot_with_without_effi_inf <- result$plot
    plot_list[[i]] <-  averted_plot_with_without_effi_inf
    summary_list[[i]] <- result$summary

    
  }
  
  names(summary_list) <- c("DENV1", "DENV2", "DENV3", "DENV4")
  combined_summary <- dplyr::bind_rows(summary_list, .id = "Sero")
  ## saving upto 3 decimal place
  combined_summary <- combined_summary %>%
  dplyr::mutate(
    mean_output = round(mean_output, 3),
    lower_bound = round(lower_bound, 3),
    upper_bound = round(upper_bound, 3)
  )
  # write.table(combined_summary,
  #           file = here::here("output_estimate_figure", "percent_symp_averted_effi_inf.txt"),
  #           sep = "\t",
  #           row.names = FALSE,
  #           quote = FALSE)
  # 
  
  ## remove legend in each of the figure
  plot_list_wo_legend <- list()
  
  for (i in seq_along(plot_list)) {
    plot_list_wo_legend[[i]] <- plot_list[[i]] + theme(legend.position = "none")
  }  
  
  ## extrct the legend  
  legend_plot <- get_legend(averted_plot_with_without_effi_inf)  
  
  # Create the grid of plots without individual x and y labels
  plot_wo_labels <- plot_grid(
    plotlist = plot_list_wo_legend,
    nrow = 2,
    ncol = 2,
    align = "hv",
    axis = "tblr",
    labels = c("(a)", "(b)", "(c)", "(d)"),  # Add subfigure labels
    label_size = 40,                        # Adjust label size
    label_x = 0.03,                         # Adjust horizontal position of labels
    label_y = 1.08                          # Adjust vertical position of labels
  )
  
  plot_with_labels <- ggdraw() +
    draw_plot(plot_wo_labels, x = 0, y = 0, width = 1, height = 1) +   
    draw_label(y_lab, x = 0.01, y = 0.55, angle = 90, size = 45, fontface = "bold") +  # Y-axis label
    draw_label("Age at vaccination (year)", x = 0.5, y = 0.025, angle = 0, size = 45, fontface = "bold")           # X-axis label
  
  # make grid of plots  
  final_plot_with_legend <- plot_grid(
    legend_plot,
    plot_with_labels,
    nrow = 2, 
    rel_heights = c(0.1,1)  
  )
  
  return(final_plot_with_legend)
  
}  



### Inputs

## List all the datasets that we want to plot together
set_of_rds_files <- list(
  c("effi_inf_lower_0_pri_sec_neq_detailed_a7_sero_dom_denv4_vcov_0.8_baseline_yes_nsamp_100_waning_0_prescrng_0.rds", 
    "effi_inf_lower_0_pri_sec_neq_detailed_a7_sero_dom_denv1_vcov_0.8_baseline_no_nsamp_100_waning_0_prescrng_0.rds",
    "pri_sec_neq_detailed_a7_sero_dom_denv1_vcov_0.8_baseline_yes_nsamp_100_waning_0.rds",
    "pri_sec_neq_detailed_a7_sero_dom_denv1_vcov_0.8_baseline_no_nsamp_100_waning_0.rds"),  # Set 1
  
 c("effi_inf_lower_0_pri_sec_neq_detailed_a7_sero_dom_denv2_vcov_0.8_baseline_yes_nsamp_100_waning_0_prescrng_0.rds", 
    "effi_inf_lower_0_pri_sec_neq_detailed_a7_sero_dom_denv2_vcov_0.8_baseline_no_nsamp_100_waning_0_prescrng_0.rds",
    "pri_sec_neq_detailed_a7_sero_dom_denv2_vcov_0.8_baseline_yes_nsamp_100_waning_0.rds",
    "pri_sec_neq_detailed_a7_sero_dom_denv2_vcov_0.8_baseline_no_nsamp_100_waning_0.rds"),  # Set 2
  
 c("effi_inf_lower_0_pri_sec_neq_detailed_a7_sero_dom_denv3_vcov_0.8_baseline_yes_nsamp_100_waning_0_prescrng_0.rds", 
    "effi_inf_lower_0_pri_sec_neq_detailed_a7_sero_dom_denv3_vcov_0.8_baseline_no_nsamp_100_waning_0_prescrng_0.rds",
    "pri_sec_neq_detailed_a7_sero_dom_denv3_vcov_0.8_baseline_yes_nsamp_100_waning_0.rds",
    "pri_sec_neq_detailed_a7_sero_dom_denv3_vcov_0.8_baseline_no_nsamp_100_waning_0.rds"),   # Set 3
  
 c("effi_inf_lower_0_pri_sec_neq_detailed_a7_sero_dom_denv4_vcov_0.8_baseline_yes_nsamp_100_waning_0_prescrng_0.rds", 
    "effi_inf_lower_0_pri_sec_neq_detailed_a7_sero_dom_denv4_vcov_0.8_baseline_no_nsamp_100_waning_0_prescrng_0.rds",
    "pri_sec_neq_detailed_a7_sero_dom_denv4_vcov_0.8_baseline_yes_nsamp_100_waning_0.rds",
    "pri_sec_neq_detailed_a7_sero_dom_denv4_vcov_0.8_baseline_no_nsamp_100_waning_0.rds")   # Set 4
)

## grab the start of vaccination year from one of the dataset
t_begin = readRDS(here::here("model_output",set_of_rds_files[[1]][1]) )$v_year 

# General y-axis settings



custom_y_limits1 <- c(0, 90)
custom_y_breaks1 <- seq(0, 90, by = 30)

custom_y_limits2 <- c(0, 68)
custom_y_breaks2 <- seq(0, 60, by = 20)

# Custom y-axis settings for a specific figure (for negative impact)(change it accordingly)
custom_y_limits3 <- c(0, 20)
custom_y_breaks3 <- seq(0, 20, by = 5)

custom_y_limits4 <- c(-20, 30)
custom_y_breaks4 <- seq(-20, 30, by = 10)

## Generate figure now
plot_fig <- get_arranged_plot_averted_with_without_effi_inf(set_of_rds_files = set_of_rds_files,
                                                                              variable_name = "symp_sample_age",
                                                                              y_lab = "Reported cases averted (%)", 
                                                                              t_begin = t_begin,
                                                                              t_end = t_begin + 9)

figure_name <- "percent_symp_averted_effi_inf_lower_zero.jpg"

### save
ggsave(
  filename = file.path(here("figure"), figure_name),  # Combine folder path and file name
  plot = plot_fig,                                            # The plot object to save
  width = 29*2,                                           # Width in inches
  height = 40,                                          # Height in inches
  dpi = 300,
  units = "cm")                                  # DPI (resolution)

```
#### Plot curent dengue cases trend in Singapore (2014-2020)
```{r}

get_plot_dengue_cases_trend <- function(){


# read the data
df_case_age_annual = read_xlsx(here("data","serotype_share_age_cases.xlsx"),
                               sheet = "age_case_2014_20")

# select the incidence per 100k data
df_case_age_inc <- select(df_case_age_annual, year, contains("_inc_"))


df_long_case <- df_case_age_inc %>%
  pivot_longer(
    cols = -year,
    names_to = "age_group",
    values_to = "incidence"
  ) %>%
  mutate(
    age_group = gsub("y_inc_p_100k", "", age_group)  # optional cleaning
  ) %>%
  mutate(
    age_group = factor(
      age_group,
      levels = c("0-4", "5-14", "15-24", "25-34",
                 "35-44", "45-54", "55-64", "65+")
    )
  )


color_cases <- c(
  "0-4"  = "#f7fbff",
  "5-14" = "#deebf7",
  "15-24" = "#c6dbef",
  "25-34" = "#9ecae1",
  "35-44" = "#6baed6",
  "45-54" = "#4292c6",
  "55-64" = "#2171b5",
  "65+"   = "#084594"
)



p_cases <- ggplot(df_long_case, aes(x = factor(year), y = incidence, fill = age_group)) +
     geom_col(position = position_dodge(width = 0.9), color = "white", alpha = 0.9) +
     scale_fill_manual(values = color_cases) +
     scale_y_continuous(limits = c(0, 800), breaks = seq(0,800, by = 200)) +
    labs(
    x = "",
    y = "",
    fill = "Age (year)",
    title = ""
  ) +
  theme_bw() +  # Clean theme
  theme(
    axis.ticks.length = unit(0.4, "cm"),        # Increase the length of the ticks
    axis.ticks = element_line(size = 1.5),      # Increase the thickness of the ticks
    panel.border = element_rect(color = "black", size = 2),  # Thicker border
    plot.margin = margin(t=10, r=0, b=10, l=25),
    axis.text.x = element_text(size = 35, color="black", angle = 30, margin = margin(t = 10, b = 0)),
    axis.text.y = element_text(size = 35,color="black", margin = margin(r = 10, l = 20)),
    # axis.title.y = element_text(size = 35, color = "black"),
    axis.title.x = element_blank(),
    axis.title.y = element_blank(),
    legend.position = c(0.45, 0.85),
    legend.direction = "horizontal",
    legend.text = element_text(size = 35),
    legend.title = element_text(size = 35, face = "bold"),
    legend.key.size = unit(1.5, "cm"),   # Increase size of legend keys
    legend.key.height = unit(1, "cm"),  # Increase height of legend keys
    legend.key.width = unit(1, "cm"),  # Increase width of legend keys
    legend.background = element_blank()
  )+
  guides(fill = guide_legend(
    nrow = 2,
    title.position = "top"    #THIS moves the title above legend keys
  ))


################ Now plot the serotyped incidence of cases


# read the data aggregated cases data
df_case_aggregated_annual = read_xlsx(here("data","serotype_share_age_cases.xlsx"),
                               sheet = "yearly_reported_cases")

df_case_aggregated_annual_selected_years <- df_case_aggregated_annual %>%
  filter(year >= 2014 & year <= 2020) %>%
  select(year, cases_p_100k)
  # select(year, absolute_cases)


## read sero share data
df_sero_share = read_xlsx(here("data","serotype_share_age_cases.xlsx"),
                          sheet = "sero_share")


df_sero_share_selected_years <- df_sero_share %>%
  filter(year >= 2014 & year <= 2020)


cases_vec <- df_case_aggregated_annual_selected_years$cases_p_100k   # extract vector of length 7

# cases_vec <- df_case_aggregated_annual_selected_years$absolute_cases

df_sero_inc_cases <- df_sero_share_selected_years %>%
  mutate(
    across(
      D1:D4,
      ~ (1/100)*.x * cases_vec,
      .names = "incidence_sero_{col}"
    )
  ) %>%
  select(year, starts_with("incidence_sero_")) %>%
  pivot_longer(
    cols = starts_with("incidence_sero"),
    names_to = "serotype",
    values_to = "incidence"
  ) %>%
  mutate(
    serotype = factor(serotype,
                      levels = c("incidence_sero_D1",
                                 "incidence_sero_D2",
                                 "incidence_sero_D3",
                                 "incidence_sero_D4"),
                      labels = c("DENV-1", "DENV-2", "DENV-3", "DENV-4"))
  )



color_sero <- c(
  "DENV-1" = "#7570b3",
  "DENV-2" = "#b2182b",
  "DENV-3" = "#66a61e",
  "DENV-4" = "#e6ab02"
)

p_sero <- ggplot(df_sero_inc_cases, aes(x = factor(year), y = incidence, fill = serotype)) +
  geom_col(position = position_dodge(width = 0.9), color = "white", alpha = 0.9) +
  scale_fill_manual(values = color_sero) +
  scale_y_continuous(limits = c(0, 300), breaks = seq(0,300, by = 50)) +
  labs(
    x = "",
    y = "",
    fill = "Serotype",
    title = ""
  ) +
  theme_bw() +  # Clean theme
  theme(
    axis.ticks.length = unit(0.4, "cm"),        # Increase the length of the ticks
    axis.ticks = element_line(size = 1.5),      # Increase the thickness of the ticks
    panel.border = element_rect(color = "black", size = 2),  # Thicker border
    plot.margin = margin(t=10, r=10, b=10, l=10),
    axis.text.x = element_text(size = 35, color="black", angle = 30, margin = margin(t = 10, b = 0)),
    axis.text.y = element_text(size = 35,color="black", margin = margin(r = 10, l = 20)),
    # axis.title.y = element_text(size = 35, color = "black"),
    axis.title.x = element_blank(),
    axis.title.y = element_blank(),
    legend.position = c(0.35, 0.85),
    legend.direction = "horizontal",
    legend.text = element_text(size = 35),
    legend.title = element_text(size = 35, face = "bold"),
    legend.key.size = unit(1.5, "cm"),  # Increase size of legend keys
    legend.key.height = unit(1, "cm"),  # Increase height of legend keys
    legend.key.width = unit(1, "cm"),  # Increase width of legend keys
    legend.background = element_blank()
  )+
  guides(fill = guide_legend(
    nrow = 2,
    title.position = "top"    #THIS moves the title above legend keys
  ))

figure_list <- list()
figure_list[[1]] <- p_cases
figure_list[[2]] <- p_sero


plot_wo_labels <- plot_grid(
  plotlist = figure_list,
  nrow = 1,
  ncol = 2,
  align = "hv",
  axis = "tblr",
  labels = c("(a)", "(b)"),  # Add subfigure labels
  label_size = 35,                        # Adjust label size
  label_x = 0.02,                         # Adjust horizontal position of labels
  label_y = 1.02                          # Adjust vertical position of labels
)

plot_with_labels <- ggdraw() +
  draw_plot(plot_wo_labels, x = 0, y = 0, width = 1, height = 1) +   
  draw_label("Incidence per 100000 population", x = 0.01, y = 0.5, angle = 90, size = 35, fontface = "bold") +  # Y-axis label
  draw_label("Year", x = 0.52, y = 0.04, angle = 0, size = 35, fontface = "bold")           # X-axis label

# make grid of plots  


return(plot_with_labels)


}


plot_cases_trend <- get_plot_dengue_cases_trend()


figure_name <- "cases_recent_trend_singapore.jpg"

# ## save
ggsave(
  filename = file.path(here("figure"), figure_name),  # Combine folder path and file name
  plot = plot_cases_trend,                                            # The plot object to save
  width = 29*2,                                           # Width in inches
  height = 20,                                          # Height in inches
  dpi = 300,
  units = "cm") 

```

############# Impact per vaccinated cases hospitalization combined

```{r}
## aggregate over all the age groups
get_agg_over_age <- function(arr) {
  arr_agg_age <- apply(arr, c(1,2,4), sum)
  return(arr_agg_age)
}

## cumulative number over year
get_cumulative_over_time <- function(arr, t_begin, t_end) {
  arr_cum_time <- apply(arr[, , t_begin:t_end], c(1, 2), sum)
  return(arr_cum_time)
}

## calculate the averted 
get_averted_per_vacc <- function(nv_output, v_output, tot_vacc_output, t_begin, t_end, output_type){
  
  nv_agg_age <- get_agg_over_age(nv_output)
  v_agg_age <-  get_agg_over_age(v_output)
  tot_vacc_agg_age <- get_agg_over_age(tot_vacc_output)
  
  nv_cum_t <- get_cumulative_over_time( nv_agg_age, t_begin = t_begin, t_end = t_end)
  v_cum_t <- get_cumulative_over_time( v_agg_age, t_begin = t_begin, t_end = t_end)
  tot_vacc_cum_t <- get_cumulative_over_time( tot_vacc_agg_age, t_begin = t_begin, t_end = t_end)
  
  if (output_type == "absolute") {
    
    averted <- 1000*(nv_cum_t - v_cum_t)/tot_vacc_cum_t
  }
  
  if (output_type == "proportion") {
    
    averted <- 100*(nv_cum_t - v_cum_t)/nv_cum_t
  }
  
  return(averted)
}

## extract variable from .rds file
extract_variable <- function(rds_file, variable_name) {
  
  result <- readRDS(here::here("model_output",  rds_file) )
  
  out_v <- as.data.frame(result$output, stringsAsFactors = FALSE)
  
  n_vac_age = result$n_vac_age
  n_sample = result$n_sample
  n_age = result$n_age
  n_year = result$n_year
  
  x <- out_v[,colnames(out_v) == variable_name] 
  
  y <- array(NA, dim = c(n_vac_age,n_sample, n_age, n_year))
  
  for (i in 1:n_vac_age) {
    
    y[i,,,] <- x[[paste0("result.", i)]]
  }
  
  return(y)
}

## make single figure
get_plot_averted <- function(df_v20, df_v50, df_v80, y_limits, y_breaks) {
  
  # Add a column for age groups
  df_v20$age <- 1:nrow(df_v20)
  df_v50$age <- 1:nrow(df_v50)
  df_v80$age <- 1:nrow(df_v80)
  
  # Reshape the dataframes to long format
  df_v20_long <- gather(df_v20, key = "Realization", value = "Output", -age)
  df_v50_long <- gather(df_v50, key = "Realization", value = "Output", -age)
  df_v80_long <- gather(df_v80, key = "Realization", value = "Output", -age)
  
  # Add a column to indicate the vaccine coverage for each dataset
  df_v20_long$VaccineCoverage <- "20% Coverage"
  df_v50_long$VaccineCoverage <- "50% Coverage"
  df_v80_long$VaccineCoverage <- "80% Coverage"
  
  # Combine all datasets into one long dataframe
  df_long <- bind_rows(df_v20_long, df_v50_long, df_v80_long)
  
  # Calculate the mean and 95% confidence interval for each age group and vaccine coverage
  summary_df <- df_long %>%
    group_by(age, VaccineCoverage) %>%
    summarise(
      mean_output =  quantile(Output, 0.5), #mean(Output),
      lower_bound = quantile(Output, 0.025),
      upper_bound = quantile(Output, 0.975)
    ) %>%
    ungroup()

  # 
  
  # Define colors for different vaccine coverages
  vaccine_colors <- c("20% Coverage" = "#1b7a53", "50% Coverage" = "#d94e28", "80% Coverage" = "#4a5a92")
  
  # Define the dodge position for side-by-side plotting
  dodge <- position_dodge(width = 0.7)
  
  # Plot using ggplot2
  p <- ggplot(summary_df, aes(x = factor(age), y = mean_output, color = VaccineCoverage)) +
    geom_point(size = 9, position = dodge, shape = 16) +  # Points for the mean with dodge
    geom_errorbar(aes(ymin = lower_bound, ymax = upper_bound), 
                  width = 0.0, size = 1.8, position = dodge) +  # Error bars with dodge
    scale_color_manual(values = vaccine_colors, name = "") + 
    scale_x_discrete(
      breaks = c(1, 2, 3, 4, 5, 6, 7),   # Set the positions of the x-axis ticks
      labels = c("6-16", "17-30", "31-40", "41-50", "51-60", "61-70", "71-80")  # Labels for age groups
    ) +
    # labs(x = "Age at vaccination", y = ylab, color = NULL) +  # Labels for x and y axes
    scale_y_continuous(limits = y_limits, breaks = y_breaks) +  # Define y-axis tick points )+
    theme_bw() +  # Clean theme
    theme(
      axis.ticks.length = unit(0.4, "cm"),        # Increase the length of the ticks
      axis.ticks = element_line(size = 1.5),      # Increase the thickness of the ticks
      panel.border = element_rect(color = "black", size = 2),  # Thicker border
      plot.margin = margin(t=10, r=10, b=20, l=25),
      axis.text.x = element_text(size = 35, color="black", angle= 30, margin = margin(t = 10, b = 20)),
      axis.text.y = element_text(size = 35,color="black", margin = margin(r = 10, l = 30)),
      # axis.title = element_text(size = 35, color = "black"),
      axis.title = element_blank(),
      legend.position = "top",
      legend.direction = "horizontal",
      legend.text = element_text(size = 40),
      legend.key.size = unit(2, "cm"),  # Increase size of legend keys
      legend.key.height = unit(1.5, "cm"),  # Increase height of legend keys
      legend.key.width = unit(2.5, "cm"),  # Increase width of legend keys
      legend.background = element_blank()
    )
  
  return(list(plot = p, summary = summary_df))
  
}


get_arranged_plot_per_vacc_avert_percent_combined <- function(set_of_rds_files, variable_name1, variable_name2, y_lab1, y_lab2, t_begin, t_end) {
  
  plot_list_cases <- list()
  plot_list_hosp <- list()

  for (i in seq_along(set_of_rds_files)) {
    
    rds_files <- set_of_rds_files[[i]]
    
    v_0_cases <- extract_variable(rds_file = rds_files[1] , 
                            variable_name = variable_name1) + 
      extract_variable(rds_file =  rds_files[1], 
                       variable_name = paste0(variable_name1, "_v"))
    
    v_20_cases <- extract_variable(rds_file = rds_files[2] , 
                             variable_name = variable_name1) + 
      extract_variable(rds_file =  rds_files[2], 
                       variable_name = paste0(variable_name1, "_v"))
    
    new_vac_total_20 <- extract_variable(rds_file = rds_files[2] , 
                                      variable_name = "new_vac_sample_age")

    
    v_50_cases <- extract_variable(rds_file = rds_files[3] , 
                             variable_name = variable_name1) + 
      extract_variable(rds_file =  rds_files[3], 
                       variable_name = paste0(variable_name1, "_v"))
    
        new_vac_total_50 <- extract_variable(rds_file = rds_files[3] , 
                                      variable_name = "new_vac_sample_age")

    
    v_80_cases <- extract_variable(rds_file = rds_files[4] , 
                             variable_name = variable_name1) + 
      extract_variable(rds_file =  rds_files[4], 
                       variable_name = paste0(variable_name1, "_v"))
    
        new_vac_total_80 <- extract_variable(rds_file = rds_files[4] , 
                                      variable_name = "new_vac_sample_age")

    
    
    
    averted_inc_v20_cases <- get_averted_per_vacc(nv_output = v_0_cases,
                                   v_output = v_20_cases,
                                   tot_vacc_output = new_vac_total_20,
                                   t_begin = t_begin,
                                   t_end = t_end,
                                   output_type = "absolute")
    
    averted_inc_v50_cases <- get_averted_per_vacc(nv_output = v_0_cases,
                                   v_output = v_50_cases,
                                   tot_vacc_output = new_vac_total_50,
                                   t_begin = t_begin,
                                   t_end = t_end,
                                   output_type = "absolute")
    
    averted_inc_v80_cases <- get_averted_per_vacc(nv_output = v_0_cases,
                                   v_output = v_80_cases,
                                   tot_vacc_output = new_vac_total_80,
                                   t_begin = t_begin,
                                   t_end = t_end,
                                   output_type = "absolute")
    
    
    df_v20_cases <- as.data.frame(averted_inc_v20_cases)
    df_v50_cases <- as.data.frame(averted_inc_v50_cases)
    df_v80_cases <- as.data.frame(averted_inc_v80_cases)
    
    
    
  # Determine y-axis settings for this figure
    if (i == 1 ) {  # Example: The second figure requires different limits
      y_limits <- custom_y_limits1_cases
      y_breaks <- custom_y_breaks1_cases
      
    } else if (i == 2) {
      y_limits <- custom_y_limits2_cases
      y_breaks <- custom_y_breaks2_cases
      
    } else if (i == 3) {
      y_limits <- custom_y_limits3_cases
      y_breaks <- custom_y_breaks3_cases
      
    }  else if (i == 4) {
      y_limits <- custom_y_limits4_cases
      y_breaks <- custom_y_breaks4_cases
    }

    
    result_cases <- get_plot_averted(df_v20 = df_v20_cases , df_v50 = df_v50_cases, df_v80 = df_v80_cases, 
                                     y_limits = y_limits, y_breaks = y_breaks )
    
    averted_plot_cases <- result_cases$plot
    plot_list_cases[[i]] <- averted_plot_cases
    
  }
  
### Now for hospitalizations  
  
   for (i in seq_along(set_of_rds_files)) {
    
    rds_files <- set_of_rds_files[[i]]
    
    v_0_hosp <- extract_variable(rds_file = rds_files[1] , 
                            variable_name = variable_name2) + 
      extract_variable(rds_file =  rds_files[1], 
                       variable_name = paste0(variable_name2, "_v"))
    
    v_20_hosp <- extract_variable(rds_file = rds_files[2] , 
                             variable_name = variable_name2) + 
      extract_variable(rds_file =  rds_files[2], 
                       variable_name = paste0(variable_name2, "_v"))
    
    v_50_hosp <- extract_variable(rds_file = rds_files[3] , 
                             variable_name = variable_name2) + 
      extract_variable(rds_file =  rds_files[3], 
                       variable_name = paste0(variable_name2, "_v"))
    
    v_80_hosp <- extract_variable(rds_file = rds_files[4] , 
                             variable_name = variable_name2) + 
      extract_variable(rds_file =  rds_files[4], 
                       variable_name = paste0(variable_name2, "_v"))
    
    averted_inc_v20_hosp <- get_averted_per_vacc(nv_output = v_0_hosp,
                                   v_output = v_20_hosp,
                                   tot_vacc_output = new_vac_total_20,
                                   t_begin = t_begin,
                                   t_end = t_end,
                                   output_type = "absolute")
    
    averted_inc_v50_hosp <- get_averted_per_vacc(nv_output = v_0_hosp,
                                   v_output = v_50_hosp,
                                   tot_vacc_output = new_vac_total_50,
                                   t_begin = t_begin,
                                   t_end = t_end,
                                   output_type = "absolute")
    
    averted_inc_v80_hosp <- get_averted_per_vacc(nv_output = v_0_hosp,
                                   v_output = v_80_hosp,
                                   tot_vacc_output = new_vac_total_80,
                                   t_begin = t_begin,
                                   t_end = t_end,
                                   output_type = "absolute")
    
    
    df_v20_hosp <- as.data.frame(averted_inc_v20_hosp)
    df_v50_hosp <- as.data.frame(averted_inc_v50_hosp)
    df_v80_hosp <- as.data.frame(averted_inc_v80_hosp)
    
    
    
  # Determine y-axis settings for this figure
    if (i == 1 ) {  # Example: The second figure requires different limits
      y_limits <- custom_y_limits1_hosp
      y_breaks <- custom_y_breaks1_hosp
      
    } else if (i == 2) {
      y_limits <- custom_y_limits2_hosp
      y_breaks <- custom_y_breaks2_hosp
      
    } else if (i == 3) {
      y_limits <- custom_y_limits3_hosp
      y_breaks <- custom_y_breaks3_hosp
      
    }  else if (i == 4) {
      y_limits <- custom_y_limits4_hosp
      y_breaks <- custom_y_breaks4_hosp
    }

    
    result_hosp <- get_plot_averted(df_v20 = df_v20_hosp, df_v50 = df_v50_hosp, df_v80 = df_v80_hosp, 
                                     y_limits = y_limits, y_breaks = y_breaks )
    
    averted_plot_hosp <- result_hosp$plot
    plot_list_hosp[[i]] <- averted_plot_hosp
    

    
  }
  
  
  ### combine the plots
  plot_list <- c(plot_list_cases, plot_list_hosp)
  

  
## remove legend in each of the figure
  plot_list_wo_legend <- list()
  
  for (i in seq_along(plot_list)){
    plot_list_wo_legend[[i]] <- plot_list[[i]] + theme(legend.position = "none")
  }  
  
## extrct the legend  
legend_plot <- get_legend(averted_plot_cases)  

# Create the grid of plots without individual x and y labels
plot_wo_labels <- plot_grid(
  plotlist = plot_list_wo_legend,
  nrow = 4,
  ncol = 2,
  align = "hv",
  axis = "tblr",
  labels = c("(a)", "(b)", "(c)", "(d)", "(e)", "(f)", "(g)", "(h)"),  # Add subfigure labels
  label_size = 40,                        # Adjust label size
  label_x = 0.03,                         # Adjust horizontal position of labels
  label_y = 1.08                          # Adjust vertical position of labels
)

plot_with_labels <- ggdraw() +
  draw_plot(plot_wo_labels, x = 0, y = 0, width = 1, height = 1) +   
  draw_label(y_lab1, x = 0.01, y = 0.78, angle = 90, size = 45, fontface = "bold") +  # Y-axis label for cases
  draw_label(y_lab2, x = 0.01, y = 0.28, angle = 90, size = 45, fontface = "bold") +  # Y-axis label
  
  draw_label("Age at vaccination (year)", x = 0.5, y = 0.025, angle = 0, size = 45, fontface = "bold")           # X-axis label

# make grid of plots  
final_plot_with_legend <- plot_grid(
  legend_plot,
  plot_with_labels,
  nrow = 2, 
  rel_heights = c(0.1,1)  
)

return(final_plot_with_legend)
  
}  

### Inputs
## List all the datasets that we want to plot together
set_of_rds_files <- list(
  c("pri_sec_neq_detailed_a7_sero_dom_denv1_vcov_0.8_baseline_yes_nsamp_100_waning_0.rds", 
    "pri_sec_neq_detailed_a7_sero_dom_denv1_vcov_0.2_baseline_no_nsamp_100_waning_0.rds",
    "pri_sec_neq_detailed_a7_sero_dom_denv1_vcov_0.5_baseline_no_nsamp_100_waning_0.rds", 
    "pri_sec_neq_detailed_a7_sero_dom_denv1_vcov_0.8_baseline_no_nsamp_100_waning_0.rds"),  # Set 1
  
  c("pri_sec_neq_detailed_a7_sero_dom_denv2_vcov_0.8_baseline_yes_nsamp_100_waning_0.rds", 
    "pri_sec_neq_detailed_a7_sero_dom_denv2_vcov_0.2_baseline_no_nsamp_100_waning_0.rds",
    "pri_sec_neq_detailed_a7_sero_dom_denv2_vcov_0.5_baseline_no_nsamp_100_waning_0.rds", 
    "pri_sec_neq_detailed_a7_sero_dom_denv2_vcov_0.8_baseline_no_nsamp_100_waning_0.rds"),  # Set 2
  
  c("pri_sec_neq_detailed_a7_sero_dom_denv3_vcov_0.8_baseline_yes_nsamp_100_waning_0.rds", 
    "pri_sec_neq_detailed_a7_sero_dom_denv3_vcov_0.2_baseline_no_nsamp_100_waning_0.rds",
    "pri_sec_neq_detailed_a7_sero_dom_denv3_vcov_0.5_baseline_no_nsamp_100_waning_0.rds", 
    "pri_sec_neq_detailed_a7_sero_dom_denv3_vcov_0.8_baseline_no_nsamp_100_waning_0.rds"),  # Set 3
  
  c("pri_sec_neq_detailed_a7_sero_dom_denv4_vcov_0.8_baseline_yes_nsamp_100_waning_0.rds", 
    "pri_sec_neq_detailed_a7_sero_dom_denv4_vcov_0.2_baseline_no_nsamp_100_waning_0.rds",
    "pri_sec_neq_detailed_a7_sero_dom_denv4_vcov_0.5_baseline_no_nsamp_100_waning_0.rds", 
    "pri_sec_neq_detailed_a7_sero_dom_denv4_vcov_0.8_baseline_no_nsamp_100_waning_0.rds")    # Set 4
)

## grab the start of vaccination year from one of the dataset
t_begin = readRDS(here::here("model_output",set_of_rds_files[[1]][1]) )$v_year 

custom_y_limits1_cases <- c(0, 30)
custom_y_breaks1_cases <- seq(0, 30, by = 6)


custom_y_limits2_cases <- c(0, 25)
custom_y_breaks2_cases <- seq(0, 25, by = 5)

# Custom y-axis settings for a specific figure (for negative impact)(change it accordingly)
custom_y_limits3_cases <- c(0, 90)
custom_y_breaks3_cases <- seq(0, 90, by = 18)

custom_y_limits4_cases <- c(-165, 120)
custom_y_breaks4_cases <- seq(-160, 120, by = 40)

## for hosp
custom_y_limits1_hosp <- c(0, 12)
custom_y_breaks1_hosp <- seq(0, 12, by = 2)


custom_y_limits2_hosp <- c(0, 8)
custom_y_breaks2_hosp <- seq(0, 8, by = 2)

# Custom y-axis settings for a specific figure (for negative impact)(change it accordingly)
custom_y_limits3_hosp <- c(0, 45)
custom_y_breaks3_hosp <- seq(0, 45, by = 9)

custom_y_limits4_hosp <- c(-0.2, 40)
custom_y_breaks4_hosp <- seq(0,40, by = 8)



## Generate figure now
plot_impact <- get_arranged_plot_per_vacc_avert_percent_combined(set_of_rds_files = set_of_rds_files,
                                                       variable_name1 = "symp_sample_age",
                                                       variable_name2 = "hosp_sample_age",
                                                       y_lab1 = "Cases averted per 1000 vaccinated", 
                                                       y_lab2 = "Hospitalizations averted per 1000 vaccinated", 
                                                       t_begin = t_begin,
                                                       t_end = t_begin + 9) ## for 10 year impact

figure_name <- "per_vacc_averted_dom_sero_symp_hosp_combined.jpg"

# ## save
ggsave(
  filename = file.path(here("figure"), figure_name),  # Combine folder path and file name
  plot = plot_impact,                                            # The plot object to save
  width = 29*2,                                           # Width in inches
  height = 80,                                          # Height in inches
  dpi = 300,
  units = "cm")                                  # DPI (resolution)
```









```{r}
# ## aggregate over all the age groups
# get_agg_over_age <- function(arr) {
#   arr_agg_age <- apply(arr, c(1,2,4), sum)
#   return(arr_agg_age)
# }
# 
# ## cumulative number over year
# get_cumulative_over_time <- function(arr, t_begin, t_end) {
#   arr_cum_time <- apply(arr[, , t_begin:t_end], c(1, 2), sum)
#   return(arr_cum_time)
# }
# 
# ## calculate the averted 
# get_averted_per_vacc <- function(nv_output, v_output, tot_vacc_output, t_begin, t_end, output_type){
#   
#   nv_agg_age <- get_agg_over_age(nv_output)
#   v_agg_age <-  get_agg_over_age(v_output)
#   tot_vacc_agg_age <- get_agg_over_age(tot_vacc_output)
#   
#   nv_cum_t <- get_cumulative_over_time( nv_agg_age, t_begin = t_begin, t_end = t_end)
#   v_cum_t <- get_cumulative_over_time( v_agg_age, t_begin = t_begin, t_end = t_end)
#   tot_vacc_cum_t <- get_cumulative_over_time( tot_vacc_agg_age, t_begin = t_begin, t_end = t_end)
#   
#   if (output_type == "absolute") {
#     
#     averted <- 1000*(nv_cum_t - v_cum_t)/tot_vacc_cum_t 
#   }
#   
#   if (output_type == "proportion") {
#     
#     averted <- 100*(nv_cum_t - v_cum_t)/nv_cum_t
#     
#     
#   }
#   
#   return(averted)
# }
# 
# ## extract variable from .rds file
# extract_variable <- function(rds_file, variable_name) {
#   
#   result <- readRDS(here::here("model_output",  rds_file) )
#   
#   out_v <- as.data.frame(result$output, stringsAsFactors = FALSE)
#   
#   n_vac_age = result$n_vac_age
#   n_sample = result$n_sample
#   n_age = result$n_age
#   n_year = result$n_year
#   
#   x <- out_v[,colnames(out_v) == variable_name] 
#   
#   y <- array(NA, dim = c(n_vac_age,n_sample, n_age, n_year))
#   
#   for (i in 1:n_vac_age) {
#     
#     y[i,,,] <- x[[paste0("result.", i)]]
#   }
#   
#   return(y)
# }
# 
# ## make single figure
# get_plot_averted <- function(df_v20, df_v50, df_v80, y_limits, y_breaks) {
#   
#   # Add a column for age groups
#   df_v20$age <- 1:nrow(df_v20)
#   df_v50$age <- 1:nrow(df_v50)
#   df_v80$age <- 1:nrow(df_v80)
#   
#   # Reshape the dataframes to long format
#   df_v20_long <- gather(df_v20, key = "Realization", value = "Output", -age)
#   df_v50_long <- gather(df_v50, key = "Realization", value = "Output", -age)
#   df_v80_long <- gather(df_v80, key = "Realization", value = "Output", -age)
#   
#   # Add a column to indicate the vaccine coverage for each dataset
#   df_v20_long$VaccineCoverage <- "20% Coverage"
#   df_v50_long$VaccineCoverage <- "50% Coverage"
#   df_v80_long$VaccineCoverage <- "80% Coverage"
#   
#   # Combine all datasets into one long dataframe
#   df_long <- bind_rows(df_v20_long, df_v50_long, df_v80_long)
#   
#   # Calculate the mean and 95% confidence interval for each age group and vaccine coverage
#   summary_df <- df_long %>%
#     group_by(age, VaccineCoverage) %>%
#     summarise(
#       mean_output =  quantile(Output, 0.5), #mean(Output),
#       lower_bound = quantile(Output, 0.025),
#       upper_bound = quantile(Output, 0.975)
#     ) %>%
#     ungroup()
# 
#   # 
#   
#   # Define colors for different vaccine coverages
#   vaccine_colors <- c("20% Coverage" = "#1b7a53", "50% Coverage" = "#d94e28", "80% Coverage" = "#4a5a92")
#   
#   # Define the dodge position for side-by-side plotting
#   dodge <- position_dodge(width = 0.5)
#   
#   # Plot using ggplot2
#   p <- ggplot(summary_df, aes(x = factor(age), y = mean_output, color = VaccineCoverage)) +
#     geom_point(size = 9, position = dodge, shape = 16) +  # Points for the mean with dodge
#     geom_errorbar(aes(ymin = lower_bound, ymax = upper_bound), 
#                   width = 0.0, size = 1.8, position = dodge) +  # Error bars with dodge
#     scale_color_manual(values = vaccine_colors, name = "") + 
#     scale_x_discrete(
#       breaks = c(1, 2, 3, 4, 5, 6, 7),   # Set the positions of the x-axis ticks
#       labels = c("6-16", "17-30", "31-40", "41-50", "51-60", "61-70", "71-80")  # Labels for age groups
#     ) +
#     # labs(x = "Age at vaccination", y = ylab, color = NULL) +  # Labels for x and y axes
#     scale_y_continuous(limits = y_limits, breaks = y_breaks) +  # Define y-axis tick points )+
#     theme_bw() +  # Clean theme
#     theme(
#       axis.ticks.length = unit(0.4, "cm"),        # Increase the length of the ticks
#       axis.ticks = element_line(size = 1.5),      # Increase the thickness of the ticks
#       panel.border = element_rect(color = "black", size = 2),  # Thicker border
#       plot.margin = margin(t=10, r=10, b=10, l=10),
#       axis.text.x = element_text(size = 35, color="black", angle= 30, margin = margin(t = 10, b = 10)),
#       axis.text.y = element_text(size = 35,color="black", margin = margin(r = 10, l = 30)),
#       # axis.title = element_text(size = 35, color = "black"),
#       axis.title = element_blank(),
#       legend.position = "top",
#       legend.direction = "horizontal",
#       legend.text = element_text(size = 40),
#       legend.key.size = unit(2, "cm"),  # Increase size of legend keys
#       legend.key.height = unit(1.5, "cm"),  # Increase height of legend keys
#       legend.key.width = unit(2.5, "cm"),  # Increase width of legend keys
#       legend.background = element_blank()
#     )
#   
#   return(list(plot = p, summary = summary_df))
#   
# }
# 
# 
# get_arranged_plot_avert_percent <- function(set_of_rds_files, variable_name, y_lab, t_begin, t_end) {
#   
#   plot_list <- list()
#   summary_list <- list()
# 
#   for (i in seq_along(set_of_rds_files)) {
#     
#     rds_files <- set_of_rds_files[[i]]
#     
#     v_0 <- extract_variable(rds_file = rds_files[1] , 
#                             variable_name = variable_name) + 
#       extract_variable(rds_file =  rds_files[1], 
#                        variable_name = paste0(variable_name, "_v"))
#     
#     v_20 <- extract_variable(rds_file = rds_files[2] , 
#                              variable_name = variable_name) + 
#       extract_variable(rds_file =  rds_files[2], 
#                        variable_name = paste0(variable_name, "_v"))
#      new_vac_total_20 <- extract_variable(rds_file = rds_files[2] , 
#                                       variable_name = "new_vac_sample_age")
#      
#     
#     v_50 <- extract_variable(rds_file = rds_files[3] , 
#                              variable_name = variable_name) + 
#       extract_variable(rds_file =  rds_files[3], 
#                        variable_name = paste0(variable_name, "_v"))
#     new_vac_total_50 <- extract_variable(rds_file = rds_files[3] , 
#                                       variable_name = "new_vac_sample_age")
#     
#     
#     
#     v_80 <- extract_variable(rds_file = rds_files[4] , 
#                              variable_name = variable_name) + 
#       extract_variable(rds_file =  rds_files[4], 
#                        variable_name = paste0(variable_name, "_v"))
#     new_vac_total_80 <- extract_variable(rds_file = rds_files[4] , 
#                                       variable_name = "new_vac_sample_age")
#     
#     
#     
#     averted_inc_v20 <- get_averted_per_vacc(nv_output = v_0,
#                                    v_output = v_20,
#                                    tot_vacc_output = new_vac_total_20,
#                                    t_begin = t_begin,
#                                    t_end = t_end,
#                                    # output_type = "proportion"
#                                    output_type = "absolute")
#     
#     averted_inc_v50 <- get_averted_per_vacc(nv_output = v_0,
#                                    v_output = v_50,
#                                    tot_vacc_output = new_vac_total_50,
#                                    t_begin = t_begin,
#                                    t_end = t_end,
#                                    # output_type = "proportion"
#                                    output_type = "absolute")
#     
#     averted_inc_v80 <- get_averted_per_vacc(nv_output = v_0,
#                                    v_output = v_80,
#                                    tot_vacc_output = new_vac_total_80,
#                                    t_begin = t_begin,
#                                    t_end = t_end,
#                                    # output_type = "proportion",
#                                    output_type = "absolute")
#     
#     
#     df_v20 <- as.data.frame(averted_inc_v20)
#     df_v50 <- as.data.frame(averted_inc_v50)
#     df_v80 <- as.data.frame(averted_inc_v80)
#     
#     
#     
#   # Determine y-axis settings for this figure
#     if (i == 1 ) {  # Example: The second figure requires different limits
#       y_limits <- custom_y_limits1
#       y_breaks <- custom_y_breaks1
#       
#     } else if (i == 2) {
#       y_limits <- custom_y_limits2
#       y_breaks <- custom_y_breaks2
#       
#     } else if (i == 3) {
#       y_limits <- custom_y_limits3
#       y_breaks <- custom_y_breaks3
#       
#     }  else if (i == 4) {
#       y_limits <- custom_y_limits4
#       y_breaks <- custom_y_breaks4
#     }
# 
#     
#     result <- get_plot_averted(df_v20 = df_v20 , df_v50 = df_v50, df_v80 = df_v80, 
#                                      y_limits = y_limits, y_breaks = y_breaks )
#     
#     averted_plot <- result$plot
#     plot_list[[i]] <- averted_plot
#     
#     ## save estimates presented in the figure
#     
#     summary_list[[i]] <- result$summary
#     
#   }
#   
#   
#   ## store the estimates in a file for future reference
#   # names(summary_list) <- c("DENV1", "DENV2", "DENV3", "DENV4")
#   # combined_summary <- dplyr::bind_rows(summary_list, .id = "Sero")
#   # ## saving upto 3 decimal place
#   # combined_summary <- combined_summary %>%
#   # dplyr::mutate(
#   #   mean_output = round(mean_output, 3),
#   #   lower_bound = round(lower_bound, 3),
#   #   upper_bound = round(upper_bound, 3)
#   # )
#   # write.table(combined_summary,
#   #           file = here::here("output_estimate_figure", "percent_symp_averted_10_y_dom_sero.txt"),
#   #           sep = "\t",
#   #           row.names = FALSE,
#   #           quote = FALSE)
# 
# 
# 
# 
# ## remove legend in each of the figure
#   plot_list_wo_legend <- list()
#   
#   for (i in seq_along(plot_list)){
#     plot_list_wo_legend[[i]] <- plot_list[[i]] + theme(legend.position = "none")
#   }  
#   
# ## extrct the legend  
# legend_plot <- get_legend(averted_plot)  
# 
# # Create the grid of plots without individual x and y labels
# plot_wo_labels <- plot_grid(
#   plotlist = plot_list_wo_legend,
#   nrow = 2,
#   ncol = 2,
#   align = "hv",
#   axis = "tblr",
#   labels = c("(a)", "(b)", "(c)", "(d)"),  # Add subfigure labels
#   label_size = 40,                        # Adjust label size
#   label_x = 0.03,                         # Adjust horizontal position of labels
#   label_y = 1.08                          # Adjust vertical position of labels
# )
# 
# plot_with_labels <- ggdraw() +
#   draw_plot(plot_wo_labels, x = 0, y = 0, width = 1, height = 1) +   
#   draw_label(y_lab, x = 0.01, y = 0.5, angle = 90, size = 45, fontface = "bold") +  # Y-axis label
#   draw_label("Age at vaccination (year)", x = 0.5, y = 0.025, angle = 0, size = 45, fontface = "bold")           # X-axis label
# 
# # make grid of plots  
# final_plot_with_legend <- plot_grid(
#   legend_plot,
#   plot_with_labels,
#   nrow = 2, 
#   rel_heights = c(0.1,1)  
# )
# 
# return(final_plot_with_legend)
#   
# }  
# 
# ### Inputs
# ## List all the datasets that we want to plot together
# set_of_rds_files <- list(
#   c("pri_sec_neq_detailed_a7_sero_dom_denv1_vcov_0.8_baseline_yes_nsamp_100_waning_0.rds", 
#     "pri_sec_neq_detailed_a7_sero_dom_denv1_vcov_0.2_baseline_no_nsamp_100_waning_0.rds",
#     "pri_sec_neq_detailed_a7_sero_dom_denv1_vcov_0.5_baseline_no_nsamp_100_waning_0.rds", 
#     "pri_sec_neq_detailed_a7_sero_dom_denv1_vcov_0.8_baseline_no_nsamp_100_waning_0.rds"),  # Set 1
#   
#   c("pri_sec_neq_detailed_a7_sero_dom_denv2_vcov_0.8_baseline_yes_nsamp_100_waning_0.rds", 
#     "pri_sec_neq_detailed_a7_sero_dom_denv2_vcov_0.2_baseline_no_nsamp_100_waning_0.rds",
#     "pri_sec_neq_detailed_a7_sero_dom_denv2_vcov_0.5_baseline_no_nsamp_100_waning_0.rds", 
#     "pri_sec_neq_detailed_a7_sero_dom_denv2_vcov_0.8_baseline_no_nsamp_100_waning_0.rds"),  # Set 2
#   
#   c("pri_sec_neq_detailed_a7_sero_dom_denv3_vcov_0.8_baseline_yes_nsamp_100_waning_0.rds", 
#     "pri_sec_neq_detailed_a7_sero_dom_denv3_vcov_0.2_baseline_no_nsamp_100_waning_0.rds",
#     "pri_sec_neq_detailed_a7_sero_dom_denv3_vcov_0.5_baseline_no_nsamp_100_waning_0.rds", 
#     "pri_sec_neq_detailed_a7_sero_dom_denv3_vcov_0.8_baseline_no_nsamp_100_waning_0.rds"),  # Set 3
#   
#   c("pri_sec_neq_detailed_a7_sero_dom_denv4_vcov_0.8_baseline_yes_nsamp_100_waning_0.rds", 
#     "pri_sec_neq_detailed_a7_sero_dom_denv4_vcov_0.2_baseline_no_nsamp_100_waning_0.rds",
#     "pri_sec_neq_detailed_a7_sero_dom_denv4_vcov_0.5_baseline_no_nsamp_100_waning_0.rds", 
#     "pri_sec_neq_detailed_a7_sero_dom_denv4_vcov_0.8_baseline_no_nsamp_100_waning_0.rds")    # Set 4
# )
# 
# ## grab the start of vaccination year from one of the dataset
# t_begin = readRDS(here::here("model_output",set_of_rds_files[[1]][1]) )$v_year 
# 
# custom_y_limits1 <- c(0, 30)
# custom_y_breaks1 <- seq(0, 30, by = 6)
# 
# 
# custom_y_limits2 <- c(0, 25)
# custom_y_breaks2 <- seq(0, 25, by = 5)
# 
# # Custom y-axis settings for a specific figure (for negative impact)(change it accordingly)
# custom_y_limits3 <- c(0, 90)
# custom_y_breaks3 <- seq(0, 90, by = 18)
# 
# custom_y_limits4 <- c(-165, 120)
# custom_y_breaks4 <- seq(-160, 120, by = 40)
# 
# 
# ## Generate figure now
# plot_impact <- get_arranged_plot_avert_percent(set_of_rds_files = set_of_rds_files,
#                                                        variable_name = "symp_sample_age",
#                                                        y_lab = "Reported cases averted per 1000 vaccinated (%)", 
#                                                        t_begin = t_begin,
#                                                        t_end = t_begin + 9) ## for 10 year impact
# 
# figure_name <- "symp_averted_dom_sero_per_vacc.jpg"
# 
# # ## save
# ggsave(
#   filename = file.path(here("figure"), figure_name),  # Combine folder path and file name
#   plot = plot_impact,                                            # The plot object to save
#   width = 29*2,                                           # Width in inches
#   height = 40,                                          # Height in inches
#   dpi = 300,
#   units = "cm")                                  # DPI (resolution)
```

